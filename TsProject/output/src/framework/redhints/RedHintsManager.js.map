{"version":3,"file":"RedHintsManager.js","sourceRoot":"","sources":["../../../../src/framework/redhints/RedHintsManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { emit } from \"puerts\";\r\nimport { Singleton } from \"../common/Singleton\";\r\nimport { Logger } from \"../logger/Logger\";\r\nimport { RedHintsMessageManager } from \"./RedHintsMessageManager\";\r\n\r\nexport enum enumRedHints {\r\n    /** 标记位 */\r\n    none = 0,\r\n    /** 聊天 */\r\n    chat = 1,\r\n    /** 聊天世界频道 */\r\n    chat_world = 2,\r\n    /** 聊天公会频道 */\r\n    chat_family = 3,\r\n    /** 聊天系统频道 */\r\n    chat_system = 4,\r\n}\r\n\r\n\r\nexport class RedHintsManager extends Singleton<RedHintsManager>{\r\n\r\n    private _data: Array<number>;//记录每个红点的数值\r\n    private _parentIndex: Array<number>;//记录父级索引\r\n    private _childNum: Array<number>;//记录子项数量\r\n    private _childIndex: Array<number>;//记录子项在父级中的排序索引\r\n\r\n    /**\r\n     * 红点值改变\r\n    */\r\n    public static RED_HINT_VALUE_CHANGED: string = \"RED_HINT_VALUE_CHANGED\";\r\n\r\n    constructor(){\r\n        super();\r\n        this.init();\r\n    }\r\n\r\n    private init() {\r\n        this._data = [0];//第一位无意义\r\n        this._parentIndex = [0];\r\n        this._childNum = [0];\r\n        this._childIndex = [0];\r\n        //------------------------记录父子关系-----------------------\r\n        //聊天\r\n        this.setParent(enumRedHints.chat_world, enumRedHints.chat);\r\n        this.setParent(enumRedHints.chat_family, enumRedHints.chat);\r\n        this.setParent(enumRedHints.chat_system, enumRedHints.chat);\r\n    }\r\n\r\n    /**\r\n     * 设置红点的开启和关闭\r\n    */\r\n   public setRedHintOpenOrClose(red: number, isOpen: boolean) {\r\n        if (this._childNum[red] > 0) {\r\n            Logger.log(\"红点数据设置错误：不能直接对高级的红点数据操作\");\r\n            return;\r\n        }\r\n        this.doSetRedHintOpenOrClose(red, isOpen ? 1 : 0);\r\n    }\r\n\r\n\r\n    /**\r\n     * 记录父子关系：子---父\r\n    */\r\n    private setParent(child: number, parent: number) {\r\n        if (this._parentIndex[parent] == child) {\r\n            Logger.log(\"关系反了\");\r\n            return;\r\n        }\r\n        if (this._parentIndex[child]) {\r\n            Logger.log(\"重复设置\");\r\n            return;\r\n        }\r\n        this._parentIndex[child] = parent;\r\n        if (isNaN(this._childNum[parent])) { this._childNum[parent] = 0 }\r\n        this._childNum[parent]++;//子项数量增加\r\n        this._childIndex[child] = this._childNum[parent];//子项的索引 从1开始\r\n    }\r\n\r\n    private doSetRedHintOpenOrClose(red: number, value: number) {\r\n        if (this._data[red] != value) {\r\n            this._data[red] = value;\r\n            let _parent: number = this._parentIndex[red]\r\n            if (_parent) {\r\n                //如果有父级，更新父级\r\n                let index: number = this._childIndex[red];//获取在父级中的索引\r\n                this.doSetRedHintOpenOrClose(_parent, value > 0 ? this._data[_parent] | this.addV(index) : this._data[_parent] & this.subV(index));//设置父级的值\r\n            }\r\n\r\n            //发改变事件:全局事件\r\n            //emit(RedHintsManager.RED_HINT_VALUE_CHANGED, red);\r\n            //红点事件，局部事件\r\n            RedHintsMessageManager.Instance(RedHintsMessageManager).broadcast(red, value);\r\n        }\r\n    }\r\n    private addV(index: number): number {\r\n        return 1 << (index - 1);\r\n    }\r\n    private subV(index: number): number {\r\n        return ~this.addV(index);\r\n    }\r\n    /**\r\n     * 查看红点是否开启\r\n    */\r\n    public checkRedIsOpen(red: number): boolean {\r\n        return this._data[red] > 0;\r\n    }\r\n\r\n\r\n}"]}