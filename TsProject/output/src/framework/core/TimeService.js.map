{"version":3,"file":"TimeService.js","sourceRoot":"","sources":["../../../../src/framework/core/TimeService.ts"],"names":[],"mappings":"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","sourcesContent":["import { TypedObjectPool } from \"../common/TypedObjectPool\";\r\n\r\nclass TimeEvent {\r\n    id: number;\r\n    endTime: number;\r\n    interval: number;\r\n\r\n    fireTime: number;\r\n    fired: boolean;\r\n    isEnd: boolean;\r\n\r\n    init(id: number, curTime: number, life: number, delay: number, interval: number) {\r\n        this.id = id;\r\n        this.fired = false;\r\n        this.isEnd = false;\r\n        this.interval = interval;\r\n        this.endTime = curTime + life;\r\n        \r\n        this.fireTime = curTime + delay;\r\n        this.tick(curTime, curTime);\r\n        return this;\r\n    }\r\n\r\n    tick(curTime: number, prevTime: number) {\r\n        if (this.isEnd) {\r\n            return;\r\n        }\r\n\r\n        let fireTime = this.fireTime;\r\n        this.fired = fireTime <= curTime;\r\n        if (this.fired) {\r\n            this.fireTime = curTime + this.interval;\r\n        }\r\n        this.isEnd = curTime >= this.endTime;\r\n    }\r\n\r\n    stop() {\r\n        this.fired = false;\r\n        this.isEnd = true;\r\n    }\r\n\r\n    mod(delta: number) {\r\n        if (this.isEnd) {\r\n            return;\r\n        }\r\n        this.fireTime += delta;\r\n        this.endTime += delta;\r\n    }\r\n\r\n    timeLeft(curTime: number) {\r\n        return Math.max(0, this.endTime - curTime);\r\n    }\r\n}\r\n\r\nexport class TimeServer {\r\n    private _dt: number;\r\n    private _time: number;\r\n    private _prevTime: number;\r\n    private _nextID: number = 1;\r\n    private _idToEvent: { [id: number]: TimeEvent } = {};\r\n    private _finishedTimer: number[] = [];\r\n    private _pool: TypedObjectPool<TimeEvent> = new TypedObjectPool(TimeEvent);\r\n\r\n    get dt() { return this._dt; }\r\n    get time() { return this._time; }\r\n    get prevTime() { return this._prevTime; }\r\n\r\n    constructor() {\r\n        this.reset();\r\n    }\r\n\r\n    reset() {\r\n        this._dt = 0;\r\n        this._time = 0;\r\n        this._prevTime = 0;\r\n        this._nextID = 1;\r\n        this.removeAllTimer();\r\n        this._finishedTimer.length = 0;\r\n    }\r\n\r\n    tick(dt: number, time: number) {\r\n        this._dt = dt;\r\n        let prevTime = this._prevTime = this._time;\r\n        this._time = time;\r\n\r\n        let idToEvent = this._idToEvent;\r\n\r\n        for (let id in idToEvent) {\r\n            let event = idToEvent[id];\r\n            event.tick(time, prevTime);\r\n            if (event.isEnd) {\r\n                this._finishedTimer.push(event.id);\r\n            }\r\n        }\r\n    }\r\n\r\n    postTick() {\r\n        this.removeFinishedTimer();\r\n    }\r\n\r\n    wait(life: number): number {\r\n        return this.loop(life, life, life + 1);\r\n    }\r\n\r\n    loop(life: number, delay: number, interval: number): number {\r\n        let id = this._nextID++;\r\n        let event = this._pool.get();\r\n        this._idToEvent[id] = event;\r\n        event.init(id, this._time, life, delay, interval);\r\n        return id;\r\n    }\r\n\r\n    stop(id: number) {\r\n        let event = this._idToEvent[id];\r\n        if (event) {\r\n            event.stop();\r\n        }\r\n    }\r\n\r\n    resetTime(id: number, life: number) {\r\n        let event = this._idToEvent[id];\r\n        if (event) {\r\n            event.init(event.id, this._time, life, 0, event.interval);\r\n        }\r\n    }\r\n\r\n    modTime(id: number, modVal: number) {\r\n        let event = this._idToEvent[id];\r\n        if (event) {\r\n            event.mod(modVal);\r\n        }\r\n    }\r\n\r\n    waitOrResetTime(id: number, life: number): number {\r\n        if (this.isEnd(id)) {\r\n            return this.wait(life);\r\n        }\r\n        this.resetTime(id, life);\r\n        return id;\r\n    }\r\n\r\n    on(id: number): boolean {\r\n        let event = this._idToEvent[id];\r\n        return event ? event.fired : false;\r\n    }\r\n\r\n    isEnd(id: number): boolean {\r\n        let event = this._idToEvent[id];\r\n        return event ? event.isEnd : true;\r\n    }\r\n\r\n    timeLeft(id: number): number {\r\n        let event = this._idToEvent[id];\r\n        return event ? event.timeLeft(this._time) : 0;\r\n    }\r\n\r\n    private removeFinishedTimer() {\r\n        let finishedTimer = this._finishedTimer;\r\n        let idToEvent = this._idToEvent;\r\n        let pool = this._pool;\r\n\r\n        for (let id of this._finishedTimer) {\r\n            let event = idToEvent[id];\r\n            pool.recover(event);\r\n\r\n            delete idToEvent[id];\r\n        }\r\n        finishedTimer.length = 0;\r\n    }\r\n\r\n    private removeAllTimer() {\r\n        let idToEvent = this._idToEvent;\r\n        let pool = this._pool;\r\n\r\n        for (let id in idToEvent) {\r\n            let event = idToEvent[id];\r\n            pool.recover(event);\r\n            delete idToEvent[id];\r\n        }\r\n    }\r\n}"]}