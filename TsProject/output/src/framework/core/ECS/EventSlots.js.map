{"version":3,"file":"EventSlots.js","sourceRoot":"","sources":["../../../../../src/framework/core/ECS/EventSlots.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,QAAQ,EAAE,MAAM,aAAa,CAAC;AAKvC,IAAI,WAAW,GAAe,EAAE,CAAC;AAEjC,MAAM,OAAO,UAAU;IAAvB;QACY,cAAS,GAAa,EAAE,CAAC;IAuErC,CAAC;IArEG,GAAG,CAAC,KAAa,EAAE,QAAqB,EAAE,IAAU;QAChD,IAAI,SAAS,GAAG,IAAI,CAAC,oBAAoB,CAAC,KAAK,CAAC,CAAC;QAEjD,IAAI,IAAI,GAAG,QAAQ,CAAC,MAAM,EAAE,CAAC;QAC7B,IAAI,CAAC,IAAI,GAAG,QAAQ,CAAC;QACrB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,CAAC,KAAK,GAAC,KAAK,CAAC;QACjB,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC;QAE5B,OAAO,IAAI,CAAC;IAChB,CAAC;IAED,IAAI,CAAC,KAAa,EAAE,GAAQ;QACxB,IAAI,SAAS,GAAG,IAAI,CAAC,oBAAoB,CAAC,KAAK,CAAC,CAAC;QACjD,SAAS,CAAC,IAAI,EAAE,CAAC;QAEjB,IAAI,YAAY,GAAG,KAAK,CAAC;QAEzB,IAAI,IAAI,GAAG,SAAS,CAAC,IAAI,CAAC;QAC5B,uBAAuB;QAErB,IAAI,KAAK,GAAG,WAAW,CAAC;QACxB,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC;QACjB,OAAM,IAAI,KAAK,SAAS,EAAE,CAAC;YACvB,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACjB,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;QACrB,CAAC;QAED,KAAI,IAAI,IAAI,IAAI,KAAK,EAAE,CAAC;YACpB,IAAG,IAAI,CAAC,IAAI,IAAE,IAAI,CAAC,IAAI,CAAC,IAAI;gBACxB,YAAY,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,GAAG,EAAE,IAAI,CAAC,SAAS,EAAE,SAAS,CAAC,IAAI,CAAC,IAAI,YAAY,CAAC;QACjG,CAAC;QAED,+BAA+B;QAC/B,wBAAwB;QACxB,qCAAqC;QAErC,yBAAyB;QACzB,oGAAoG;QAEpG,wCAAwC;QACxC,uBAAuB;QACvB,QAAQ;QAER,mBAAmB;QACnB,IAAI;QAEJ,IAAI,YAAY,EAAE,CAAC;YACf,SAAS,CAAC,IAAI,GAAG,CAAC,CAAC;QACvB,CAAC;IACL,CAAC;IAEO,oBAAoB,CAAC,KAAa;QACtC,IAAI,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;QACrC,IAAI,QAAQ,EAAE,CAAC;YACX,OAAO,QAAQ,CAAC;QACpB,CAAC;QAED,QAAQ,GAAG,QAAQ,CAAC,MAAM,EAAE,CAAC;QAC7B,QAAQ,CAAC,IAAI,GAAG,QAAQ,CAAC;QACzB,QAAQ,CAAC,IAAI,GAAG,QAAQ,CAAC;QAEzB,oBAAoB;QACpB,QAAQ,CAAC,IAAI,GAAG,CAAC,CAAC;QAClB,QAAQ,CAAC,SAAS,GAAG,SAAS,CAAC;QAE/B,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,QAAQ,CAAC;QACjC,OAAO,QAAQ,CAAC;IACpB,CAAC;CACJ","sourcesContent":["import { ListNode } from \"../ListNode\";\r\n\r\ntype EventAction = (evt: any, data?: any, eventCounter?: number) => boolean;\r\ntype EventMap = { [event: number]: ListNode };\r\n\r\nlet _tmpListArr: ListNode[] = [];\r\n\r\nexport class EventSlots {\r\n    private _eventMap: EventMap = {};\r\n\r\n    add(event: number, callback: EventAction, data?: any): ListNode {\r\n        let eventList = this.getOrCreateEventList(event);\r\n\r\n        let node = ListNode.create();\r\n        node.data = callback;\r\n        node.dataExtra = data;\r\n        node.event=event;\r\n        node.insertAfter(eventList);\r\n  \r\n        return node;\r\n    }\r\n\r\n    fire(event: number, evt: any) {\r\n        let eventList = this.getOrCreateEventList(event);\r\n        eventList.data++;\r\n\r\n        let clearCounter = false;\r\n\r\n        let node = eventList.next;\r\n      //  let next: ListNode;\r\n\r\n        let nodes = _tmpListArr;\r\n        nodes.length = 0;\r\n        while(node !== eventList) {\r\n            nodes.push(node);\r\n            node = node.next;\r\n        }\r\n\r\n        for(let node of nodes) {\r\n            if(node.data&&node.data.call)\r\n                clearCounter = node.data.call(null, evt, node.dataExtra, eventList.data) || clearCounter;            \r\n        }\r\n\r\n        // while (node !== eventList) {\r\n        //     next = node.next;\r\n        //     let checkNextNext = next.next;\r\n\r\n        //     if(node.data.call)\r\n        //         clearCounter = node.data.call(null, evt, node.dataExtra, eventList.data) || clearCounter;\r\n\r\n        //     if (next.next != checkNextNext) {\r\n        //         let iii = 0;\r\n        //     }\r\n\r\n        //     node = next;\r\n        // }\r\n\r\n        if (clearCounter) {\r\n            eventList.data = 0;\r\n        }\r\n    }\r\n\r\n    private getOrCreateEventList(event: number): ListNode {\r\n        let listNode = this._eventMap[event];\r\n        if (listNode) {\r\n            return listNode;\r\n        }\r\n\r\n        listNode = ListNode.create();\r\n        listNode.prev = listNode;\r\n        listNode.next = listNode;\r\n        \r\n        // NOTE: 这个用来存消息的计数.\r\n        listNode.data = 0;\r\n        listNode.dataExtra = undefined;\r\n\r\n        this._eventMap[event] = listNode;\r\n        return listNode;\r\n    }\r\n}"]}