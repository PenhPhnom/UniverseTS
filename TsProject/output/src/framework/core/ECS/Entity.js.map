{"version":3,"file":"Entity.js","sourceRoot":"","sources":["../../../../../src/framework/core/ECS/Entity.ts"],"names":[],"mappings":"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","sourcesContent":["import { EntityContext, CompFieldType } from \"./EntityContext\";\r\nimport { Vec2 } from \"../Vec2\";\r\nimport { GroupID } from \"./GroupID\";\r\nimport { theFramePool } from \"../FramePool\";\r\nimport { EventSlots } from \"./EventSlots\";\r\nimport { TypedObjectPool } from \"../../common/TypedObjectPool\";\r\n\r\ntype Class<T> = new (...args: any[]) => T;\r\n\r\nlet GArrayPool = new TypedObjectPool(Array);\r\n\r\nexport class Entity {\r\n    private _id: number;\r\n    private _ctx: EntityContext;\r\n    private _groupID: GroupID;\r\n    private _prevGroupID: GroupID;\r\n\r\n    get id() { return this._id; }\r\n    get context() { return this._ctx; }\r\n    get groupID() { return this._groupID; }\r\n\r\n    init(ctx: EntityContext, id: number) {\r\n        this._ctx = ctx;\r\n        this._id = id;\r\n        this._groupID = new GroupID();\r\n        this._prevGroupID = new GroupID();\r\n    }\r\n\r\n    reset() {\r\n        this._ctx = null;\r\n        this._groupID = null;\r\n        this._prevGroupID = null;\r\n        this.clearAllComponentData();\r\n    }\r\n\r\n    beforeRecover() {\r\n        this._prevGroupID.assign(this._groupID);\r\n        this._groupID.reset();\r\n\r\n        this._ctx.componentGroupContext.changeEntityGroup(this, this._prevGroupID, this._groupID);\r\n        this._ctx = null;\r\n        this.clearAllComponentData();\r\n    }\r\n\r\n    add<T0, T1, T2, T3, T4, T5>(\r\n        cls0: Class<T0>,\r\n        cls1?: Class<T1>,\r\n        cls2?: Class<T2>,\r\n        cls3?: Class<T3>,\r\n        cls4?: Class<T4>,\r\n        cls5?: Class<T5>): Entity & T0 & T1 & T2 & T3 & T4 & T5 {\r\n\r\n        this.beginGroupChange();\r\n        this.doAdd(cls0);\r\n        if (cls1) {\r\n            this.doAdd(cls1);\r\n            if (cls2) {\r\n                this.doAdd(cls2);\r\n                if (cls3) {\r\n                    this.doAdd(cls3);\r\n                    if (cls4) {\r\n                        this.doAdd(cls4);\r\n                        if (cls5) { this.doAdd(cls5); }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        this.endGroupChange();\r\n        return <Entity & T0 & T1 & T2 & T3 & T4 & T5><any>this;\r\n    }\r\n\r\n    get<T0, T1, T2, T3, T4>(cls0: Class<T0>, cls1?: Class<T1>, cls2?: Class<T2>, cls3?: Class<T3>, cls4?: Class<T4>): Entity & T0 & T1 & T2 & T3 & T4 {\r\n        if (!this.has(cls0)) {\r\n            return null;\r\n        }\r\n        if (cls1 !== undefined && !this.has(cls1)) { return null; }\r\n        if (cls2 !== undefined && !this.has(cls2)) { return null; }\r\n        if (cls3 !== undefined && !this.has(cls3)) { return null; }\r\n        if (cls4 !== undefined && !this.has(cls4)) { return null; }\r\n        return <Entity & T0 & T1 & T2 & T3 & T4><any>this;\r\n    }\r\n\r\n    getOrCreate<T0, T1, T2, T3, T4>(cls0: Class<T0>, cls1?: Class<T1>, cls2?: Class<T2>, cls3?: Class<T3>, cls4?: Class<T4>): Entity & T0 & T1 & T2 & T3 & T4 {\r\n        let result = this.get(cls0, cls1, cls2, cls3, cls4);\r\n        if (!result) {\r\n            result = this.add(cls0, cls1, cls2, cls3, cls4);\r\n        }\r\n        return result;\r\n    }\r\n\r\n    del(cls: any) {\r\n        let ctx = this._ctx;\r\n        let classID = ctx.getOrRegClassID(cls);\r\n\r\n        if (!this._groupID.has(classID)) {\r\n            return;\r\n        }\r\n\r\n        let prevGroup = theFramePool.allocItem(\"GroupID\", GroupID);\r\n        prevGroup.assign(this._groupID);\r\n        this._groupID.clear(classID);\r\n\r\n        let defaults = ctx.getCompSpecFieldDesc(classID);\r\n        for (let name of Object.getOwnPropertyNames(defaults)) {\r\n            delete this[name];\r\n        }\r\n\r\n        this._ctx.componentGroupContext.changeEntityGroup(this, prevGroup, this._groupID);\r\n    }\r\n\r\n    has(cls: any): boolean {\r\n        let classID = this._ctx.getOrRegClassID(cls);\r\n        return this._groupID.has(classID);\r\n    }\r\n\r\n    recover() {\r\n        this._ctx.recover(this);\r\n    }\r\n\r\n    vec2(name: string): Vec2 {\r\n        let getter = this._ctx.getFieldConvertor(name);\r\n        if (getter) {\r\n            return getter.call(this);\r\n        }\r\n        return Vec2.kZero;\r\n    }\r\n\r\n    private beginGroupChange() {\r\n        this._prevGroupID.assign(this._groupID);\r\n    }\r\n\r\n    private endGroupChange() {\r\n        if (!this._groupID.equal(this._prevGroupID)) {\r\n            this._ctx.componentGroupContext.changeEntityGroup(this, this._prevGroupID, this._groupID);\r\n        }\r\n    }\r\n\r\n    private doAdd(cls: any) {\r\n        let ctx = this._ctx;\r\n        let classID = ctx.getOrRegClassID(cls);\r\n        if (this._groupID.has(classID)) {\r\n            return;\r\n        }\r\n\r\n        let desc = ctx.getCompSpecFieldDesc(classID);\r\n        let count = desc.length;\r\n        for (let i = 0; i < count; i++) {\r\n            let fieldDesc = desc[i];\r\n            switch (fieldDesc.type) {\r\n                case CompFieldType.Array:\r\n                    this[fieldDesc.name] = GArrayPool.get();\r\n                    break;\r\n                case CompFieldType.Map:\r\n                    this[fieldDesc.name] = {};\r\n                    break;\r\n                case CompFieldType.Slot:\r\n                    this[fieldDesc.name] = new EventSlots();\r\n                    break;\r\n            }\r\n        }\r\n        this._groupID.set(classID);\r\n    }\r\n\r\n    private clearAllComponentData() {\r\n        // Entity自己的成员变量是以_开始的, 所以可以这么暴力.\r\n        let names = Object.getOwnPropertyNames(this);\r\n        let count = names.length;\r\n        for (let i = 0; i < count; i++) {\r\n            let name = names[i];\r\n            if (name.substr(0, 3) == 'ref') {\r\n                delete this[name];\r\n            } else if (name.substr(-4) == \"List\") {\r\n                let list = this[name];\r\n                list.length = 0;\r\n                GArrayPool.recover(list);\r\n                delete this[name];\r\n            } else if (name.substr(0, -3) == 'Map') {\r\n                delete this[name];\r\n            }\r\n        }\r\n    }\r\n}"]}