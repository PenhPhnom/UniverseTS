!function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=59)}([function(t,e){t.exports=require("csharp")},function(t,e,n){"use strict";var i=n(42),r=i.Reader,s=i.Writer,a=i.util,o=n(58);i.util.Long=o,i.configure();var l,u=i.roots.default||(i.roots.default={});u.nice_ts=((l={}).C2R_Login=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Account="",t.prototype.Password="",t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=s.create()),null!=t.Account&&Object.hasOwnProperty.call(t,"Account")&&e.uint32(10).string(t.Account),null!=t.Password&&Object.hasOwnProperty.call(t,"Password")&&e.uint32(18).string(t.Password),e},t.encodeDelimited=function(t,e){return this.encode(t,e).ldelim()},t.decode=function(t,e){t instanceof r||(t=r.create(t));for(var n=void 0===e?t.len:t.pos+e,i=new u.nice_ts.C2R_Login;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:i.Account=t.string();break;case 2:i.Password=t.string();break;default:t.skipType(7&s)}}return i},t.decodeDelimited=function(t){return t instanceof r||(t=new r(t)),this.decode(t,t.uint32())},t.verify=function(t){return"object"!=typeof t||null===t?"object expected":null!=t.Account&&t.hasOwnProperty("Account")&&!a.isString(t.Account)?"Account: string expected":null!=t.Password&&t.hasOwnProperty("Password")&&!a.isString(t.Password)?"Password: string expected":null},t.fromObject=function(t){if(t instanceof u.nice_ts.C2R_Login)return t;var e=new u.nice_ts.C2R_Login;return null!=t.Account&&(e.Account=String(t.Account)),null!=t.Password&&(e.Password=String(t.Password)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(n.Account="",n.Password=""),null!=t.Account&&t.hasOwnProperty("Account")&&(n.Account=t.Account),null!=t.Password&&t.hasOwnProperty("Password")&&(n.Password=t.Password),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,i.util.toJSONOptions)},t}(),l.R2C_Login=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Error=0,t.prototype.Message="",t.prototype.Address="",t.prototype.Key=a.Long?a.Long.fromBits(0,0,!1):0,t.prototype.GateId=a.Long?a.Long.fromBits(0,0,!1):0,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=s.create()),null!=t.Address&&Object.hasOwnProperty.call(t,"Address")&&e.uint32(10).string(t.Address),null!=t.Key&&Object.hasOwnProperty.call(t,"Key")&&e.uint32(16).int64(t.Key),null!=t.GateId&&Object.hasOwnProperty.call(t,"GateId")&&e.uint32(24).int64(t.GateId),null!=t.Error&&Object.hasOwnProperty.call(t,"Error")&&e.uint32(728).int32(t.Error),null!=t.Message&&Object.hasOwnProperty.call(t,"Message")&&e.uint32(738).string(t.Message),e},t.encodeDelimited=function(t,e){return this.encode(t,e).ldelim()},t.decode=function(t,e){t instanceof r||(t=r.create(t));for(var n=void 0===e?t.len:t.pos+e,i=new u.nice_ts.R2C_Login;t.pos<n;){var s=t.uint32();switch(s>>>3){case 91:i.Error=t.int32();break;case 92:i.Message=t.string();break;case 1:i.Address=t.string();break;case 2:i.Key=t.int64();break;case 3:i.GateId=t.int64();break;default:t.skipType(7&s)}}return i},t.decodeDelimited=function(t){return t instanceof r||(t=new r(t)),this.decode(t,t.uint32())},t.verify=function(t){return"object"!=typeof t||null===t?"object expected":null!=t.Error&&t.hasOwnProperty("Error")&&!a.isInteger(t.Error)?"Error: integer expected":null!=t.Message&&t.hasOwnProperty("Message")&&!a.isString(t.Message)?"Message: string expected":null!=t.Address&&t.hasOwnProperty("Address")&&!a.isString(t.Address)?"Address: string expected":null!=t.Key&&t.hasOwnProperty("Key")&&!(a.isInteger(t.Key)||t.Key&&a.isInteger(t.Key.low)&&a.isInteger(t.Key.high))?"Key: integer|Long expected":null!=t.GateId&&t.hasOwnProperty("GateId")&&!(a.isInteger(t.GateId)||t.GateId&&a.isInteger(t.GateId.low)&&a.isInteger(t.GateId.high))?"GateId: integer|Long expected":null},t.fromObject=function(t){if(t instanceof u.nice_ts.R2C_Login)return t;var e=new u.nice_ts.R2C_Login;return null!=t.Error&&(e.Error=0|t.Error),null!=t.Message&&(e.Message=String(t.Message)),null!=t.Address&&(e.Address=String(t.Address)),null!=t.Key&&(a.Long?(e.Key=a.Long.fromValue(t.Key)).unsigned=!1:"string"==typeof t.Key?e.Key=parseInt(t.Key,10):"number"==typeof t.Key?e.Key=t.Key:"object"==typeof t.Key&&(e.Key=new a.LongBits(t.Key.low>>>0,t.Key.high>>>0).toNumber())),null!=t.GateId&&(a.Long?(e.GateId=a.Long.fromValue(t.GateId)).unsigned=!1:"string"==typeof t.GateId?e.GateId=parseInt(t.GateId,10):"number"==typeof t.GateId?e.GateId=t.GateId:"object"==typeof t.GateId&&(e.GateId=new a.LongBits(t.GateId.low>>>0,t.GateId.high>>>0).toNumber())),e},t.toObject=function(t,e){e||(e={});var n={};if(e.defaults){if(n.Address="",a.Long){var i=new a.Long(0,0,!1);n.Key=e.longs===String?i.toString():e.longs===Number?i.toNumber():i}else n.Key=e.longs===String?"0":0;a.Long?(i=new a.Long(0,0,!1),n.GateId=e.longs===String?i.toString():e.longs===Number?i.toNumber():i):n.GateId=e.longs===String?"0":0,n.Error=0,n.Message=""}return null!=t.Address&&t.hasOwnProperty("Address")&&(n.Address=t.Address),null!=t.Key&&t.hasOwnProperty("Key")&&("number"==typeof t.Key?n.Key=e.longs===String?String(t.Key):t.Key:n.Key=e.longs===String?a.Long.prototype.toString.call(t.Key):e.longs===Number?new a.LongBits(t.Key.low>>>0,t.Key.high>>>0).toNumber():t.Key),null!=t.GateId&&t.hasOwnProperty("GateId")&&("number"==typeof t.GateId?n.GateId=e.longs===String?String(t.GateId):t.GateId:n.GateId=e.longs===String?a.Long.prototype.toString.call(t.GateId):e.longs===Number?new a.LongBits(t.GateId.low>>>0,t.GateId.high>>>0).toNumber():t.GateId),null!=t.Error&&t.hasOwnProperty("Error")&&(n.Error=t.Error),null!=t.Message&&t.hasOwnProperty("Message")&&(n.Message=t.Message),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,i.util.toJSONOptions)},t}(),l.C2G_LoginGate=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Key=a.Long?a.Long.fromBits(0,0,!1):0,t.prototype.GateId=a.Long?a.Long.fromBits(0,0,!1):0,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=s.create()),null!=t.Key&&Object.hasOwnProperty.call(t,"Key")&&e.uint32(8).int64(t.Key),null!=t.GateId&&Object.hasOwnProperty.call(t,"GateId")&&e.uint32(16).int64(t.GateId),e},t.encodeDelimited=function(t,e){return this.encode(t,e).ldelim()},t.decode=function(t,e){t instanceof r||(t=r.create(t));for(var n=void 0===e?t.len:t.pos+e,i=new u.nice_ts.C2G_LoginGate;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:i.Key=t.int64();break;case 2:i.GateId=t.int64();break;default:t.skipType(7&s)}}return i},t.decodeDelimited=function(t){return t instanceof r||(t=new r(t)),this.decode(t,t.uint32())},t.verify=function(t){return"object"!=typeof t||null===t?"object expected":null!=t.Key&&t.hasOwnProperty("Key")&&!(a.isInteger(t.Key)||t.Key&&a.isInteger(t.Key.low)&&a.isInteger(t.Key.high))?"Key: integer|Long expected":null!=t.GateId&&t.hasOwnProperty("GateId")&&!(a.isInteger(t.GateId)||t.GateId&&a.isInteger(t.GateId.low)&&a.isInteger(t.GateId.high))?"GateId: integer|Long expected":null},t.fromObject=function(t){if(t instanceof u.nice_ts.C2G_LoginGate)return t;var e=new u.nice_ts.C2G_LoginGate;return null!=t.Key&&(a.Long?(e.Key=a.Long.fromValue(t.Key)).unsigned=!1:"string"==typeof t.Key?e.Key=parseInt(t.Key,10):"number"==typeof t.Key?e.Key=t.Key:"object"==typeof t.Key&&(e.Key=new a.LongBits(t.Key.low>>>0,t.Key.high>>>0).toNumber())),null!=t.GateId&&(a.Long?(e.GateId=a.Long.fromValue(t.GateId)).unsigned=!1:"string"==typeof t.GateId?e.GateId=parseInt(t.GateId,10):"number"==typeof t.GateId?e.GateId=t.GateId:"object"==typeof t.GateId&&(e.GateId=new a.LongBits(t.GateId.low>>>0,t.GateId.high>>>0).toNumber())),e},t.toObject=function(t,e){e||(e={});var n={};if(e.defaults){if(a.Long){var i=new a.Long(0,0,!1);n.Key=e.longs===String?i.toString():e.longs===Number?i.toNumber():i}else n.Key=e.longs===String?"0":0;a.Long?(i=new a.Long(0,0,!1),n.GateId=e.longs===String?i.toString():e.longs===Number?i.toNumber():i):n.GateId=e.longs===String?"0":0}return null!=t.Key&&t.hasOwnProperty("Key")&&("number"==typeof t.Key?n.Key=e.longs===String?String(t.Key):t.Key:n.Key=e.longs===String?a.Long.prototype.toString.call(t.Key):e.longs===Number?new a.LongBits(t.Key.low>>>0,t.Key.high>>>0).toNumber():t.Key),null!=t.GateId&&t.hasOwnProperty("GateId")&&("number"==typeof t.GateId?n.GateId=e.longs===String?String(t.GateId):t.GateId:n.GateId=e.longs===String?a.Long.prototype.toString.call(t.GateId):e.longs===Number?new a.LongBits(t.GateId.low>>>0,t.GateId.high>>>0).toNumber():t.GateId),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,i.util.toJSONOptions)},t}(),l.G2C_LoginGate=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Error=0,t.prototype.Message="",t.prototype.PlayerId=a.Long?a.Long.fromBits(0,0,!1):0,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=s.create()),null!=t.PlayerId&&Object.hasOwnProperty.call(t,"PlayerId")&&e.uint32(8).int64(t.PlayerId),null!=t.Error&&Object.hasOwnProperty.call(t,"Error")&&e.uint32(728).int32(t.Error),null!=t.Message&&Object.hasOwnProperty.call(t,"Message")&&e.uint32(738).string(t.Message),e},t.encodeDelimited=function(t,e){return this.encode(t,e).ldelim()},t.decode=function(t,e){t instanceof r||(t=r.create(t));for(var n=void 0===e?t.len:t.pos+e,i=new u.nice_ts.G2C_LoginGate;t.pos<n;){var s=t.uint32();switch(s>>>3){case 91:i.Error=t.int32();break;case 92:i.Message=t.string();break;case 1:i.PlayerId=t.int64();break;default:t.skipType(7&s)}}return i},t.decodeDelimited=function(t){return t instanceof r||(t=new r(t)),this.decode(t,t.uint32())},t.verify=function(t){return"object"!=typeof t||null===t?"object expected":null!=t.Error&&t.hasOwnProperty("Error")&&!a.isInteger(t.Error)?"Error: integer expected":null!=t.Message&&t.hasOwnProperty("Message")&&!a.isString(t.Message)?"Message: string expected":null!=t.PlayerId&&t.hasOwnProperty("PlayerId")&&!(a.isInteger(t.PlayerId)||t.PlayerId&&a.isInteger(t.PlayerId.low)&&a.isInteger(t.PlayerId.high))?"PlayerId: integer|Long expected":null},t.fromObject=function(t){if(t instanceof u.nice_ts.G2C_LoginGate)return t;var e=new u.nice_ts.G2C_LoginGate;return null!=t.Error&&(e.Error=0|t.Error),null!=t.Message&&(e.Message=String(t.Message)),null!=t.PlayerId&&(a.Long?(e.PlayerId=a.Long.fromValue(t.PlayerId)).unsigned=!1:"string"==typeof t.PlayerId?e.PlayerId=parseInt(t.PlayerId,10):"number"==typeof t.PlayerId?e.PlayerId=t.PlayerId:"object"==typeof t.PlayerId&&(e.PlayerId=new a.LongBits(t.PlayerId.low>>>0,t.PlayerId.high>>>0).toNumber())),e},t.toObject=function(t,e){e||(e={});var n={};if(e.defaults){if(a.Long){var i=new a.Long(0,0,!1);n.PlayerId=e.longs===String?i.toString():e.longs===Number?i.toNumber():i}else n.PlayerId=e.longs===String?"0":0;n.Error=0,n.Message=""}return null!=t.PlayerId&&t.hasOwnProperty("PlayerId")&&("number"==typeof t.PlayerId?n.PlayerId=e.longs===String?String(t.PlayerId):t.PlayerId:n.PlayerId=e.longs===String?a.Long.prototype.toString.call(t.PlayerId):e.longs===Number?new a.LongBits(t.PlayerId.low>>>0,t.PlayerId.high>>>0).toNumber():t.PlayerId),null!=t.Error&&t.hasOwnProperty("Error")&&(n.Error=t.Error),null!=t.Message&&t.hasOwnProperty("Message")&&(n.Message=t.Message),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,i.util.toJSONOptions)},t}(),l.C2GS_Test=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.testID=0,t.prototype.testName="",t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=s.create()),null!=t.testID&&Object.hasOwnProperty.call(t,"testID")&&e.uint32(8).int32(t.testID),null!=t.testName&&Object.hasOwnProperty.call(t,"testName")&&e.uint32(18).string(t.testName),e},t.encodeDelimited=function(t,e){return this.encode(t,e).ldelim()},t.decode=function(t,e){t instanceof r||(t=r.create(t));for(var n=void 0===e?t.len:t.pos+e,i=new u.nice_ts.C2GS_Test;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:i.testID=t.int32();break;case 2:i.testName=t.string();break;default:t.skipType(7&s)}}return i},t.decodeDelimited=function(t){return t instanceof r||(t=new r(t)),this.decode(t,t.uint32())},t.verify=function(t){return"object"!=typeof t||null===t?"object expected":null!=t.testID&&t.hasOwnProperty("testID")&&!a.isInteger(t.testID)?"testID: integer expected":null!=t.testName&&t.hasOwnProperty("testName")&&!a.isString(t.testName)?"testName: string expected":null},t.fromObject=function(t){if(t instanceof u.nice_ts.C2GS_Test)return t;var e=new u.nice_ts.C2GS_Test;return null!=t.testID&&(e.testID=0|t.testID),null!=t.testName&&(e.testName=String(t.testName)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(n.testID=0,n.testName=""),null!=t.testID&&t.hasOwnProperty("testID")&&(n.testID=t.testID),null!=t.testName&&t.hasOwnProperty("testName")&&(n.testName=t.testName),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,i.util.toJSONOptions)},t}(),l.GS2C_Test=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Error=0,t.prototype.Message="",t.prototype.testResponse="",t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=s.create()),null!=t.testResponse&&Object.hasOwnProperty.call(t,"testResponse")&&e.uint32(10).string(t.testResponse),null!=t.Error&&Object.hasOwnProperty.call(t,"Error")&&e.uint32(728).int32(t.Error),null!=t.Message&&Object.hasOwnProperty.call(t,"Message")&&e.uint32(738).string(t.Message),e},t.encodeDelimited=function(t,e){return this.encode(t,e).ldelim()},t.decode=function(t,e){t instanceof r||(t=r.create(t));for(var n=void 0===e?t.len:t.pos+e,i=new u.nice_ts.GS2C_Test;t.pos<n;){var s=t.uint32();switch(s>>>3){case 91:i.Error=t.int32();break;case 92:i.Message=t.string();break;case 1:i.testResponse=t.string();break;default:t.skipType(7&s)}}return i},t.decodeDelimited=function(t){return t instanceof r||(t=new r(t)),this.decode(t,t.uint32())},t.verify=function(t){return"object"!=typeof t||null===t?"object expected":null!=t.Error&&t.hasOwnProperty("Error")&&!a.isInteger(t.Error)?"Error: integer expected":null!=t.Message&&t.hasOwnProperty("Message")&&!a.isString(t.Message)?"Message: string expected":null!=t.testResponse&&t.hasOwnProperty("testResponse")&&!a.isString(t.testResponse)?"testResponse: string expected":null},t.fromObject=function(t){if(t instanceof u.nice_ts.GS2C_Test)return t;var e=new u.nice_ts.GS2C_Test;return null!=t.Error&&(e.Error=0|t.Error),null!=t.Message&&(e.Message=String(t.Message)),null!=t.testResponse&&(e.testResponse=String(t.testResponse)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(n.testResponse="",n.Error=0,n.Message=""),null!=t.testResponse&&t.hasOwnProperty("testResponse")&&(n.testResponse=t.testResponse),null!=t.Error&&t.hasOwnProperty("Error")&&(n.Error=t.Error),null!=t.Message&&t.hasOwnProperty("Message")&&(n.Message=t.Message),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,i.util.toJSONOptions)},t}(),l),t.exports=u},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.throwNullException=e.NullException=void 0;class i extends Error{}e.NullException=i,e.throwNullException=function(t){throw new i(t+" is null or undefined")}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.InkObject=void 0;const i=n(4),r=n(12),s=n(15),a=n(7),o=n(2);e.InkObject=class{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(t){if(null===t)return null;let e=this.rootContentContainer;if(e){let n=e.ContentAtPath(t).obj;if(n){let t=n.debugMetadata;if(null!==t)return t.startLineNumber}}return null}get path(){if(null==this._path)if(null==this.parent)this._path=new i.Path;else{let t=[],e=this,n=a.asOrNull(e.parent,r.Container);for(;null!==n;){let s=a.asINamedContentOrNull(e);null!=s&&s.hasValidName?t.unshift(new i.Path.Component(s.name)):t.unshift(new i.Path.Component(n.content.indexOf(e))),e=n,n=a.asOrNull(n.parent,r.Container)}this._path=new i.Path(t)}return this._path}ResolvePath(t){if(null===t)return o.throwNullException("path");if(t.isRelative){let e=a.asOrNull(this,r.Container);return null===e&&(s.Debug.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),e=a.asOrNull(this.parent,r.Container),s.Debug.Assert(null!==e,"Expected parent to be a container"),s.Debug.Assert(t.GetComponent(0).isParent),t=t.tail),null===e?o.throwNullException("nearestContainer"):e.ContentAtPath(t)}{let e=this.rootContentContainer;return null===e?o.throwNullException("contentContainer"):e.ContentAtPath(t)}}ConvertPathToRelative(t){let e=this.path,n=Math.min(t.length,e.length),r=-1;for(let i=0;i<n;++i){let n=e.GetComponent(i),s=t.GetComponent(i);if(!n.Equals(s))break;r=i}if(-1==r)return t;let s=e.componentCount-1-r,a=[];for(let t=0;t<s;++t)a.push(i.Path.Component.ToParent());for(let e=r+1;e<t.componentCount;++e)a.push(t.GetComponent(e));return new i.Path(a,!0)}CompactPathString(t){let e=null,n=null;if(t.isRelative)n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString;else{n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString}return n.length<e.length?n:e}get rootContentContainer(){let t=this;for(;t.parent;)t=t.parent;return a.asOrNull(t,r.Container)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Path=void 0;class i{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){let t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof i.Component&&arguments[1]instanceof i){let t=arguments[0],e=arguments[1];this._components.push(t),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){let t=arguments[0],e=!!arguments[1];this._components=this._components.concat(t),this._isRelative=e}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return this._components.length>0?this._components[0]:null}get tail(){if(this._components.length>=2){let t=this._components.slice(1,this._components.length);return new i(t)}return i.self}get length(){return this._components.length}get lastComponent(){let t=this._components.length-1;return t>=0?this._components[t]:null}get containsNamedComponent(){for(let t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}static get self(){let t=new i;return t._isRelative=!0,t}GetComponent(t){return this._components[t]}PathByAppendingPath(t){let e=new i,n=0;for(let e=0;e<t._components.length&&t._components[e].isParent;++e)n++;for(let t=0;t<this._components.length-n;++t)e._components.push(this._components[t]);for(let i=n;i<t._components.length;++i)e._components.push(t._components[i]);return e}get componentsString(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString}set componentsString(t){if(this._components.length=0,this._componentsString=t,null==this._componentsString||""==this._componentsString)return;"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));let e=this._componentsString.split(".");for(let t of e)/^(\-|\+)?([0-9]+|Infinity)$/.test(t)?this._components.push(new i.Component(parseInt(t))):this._components.push(new i.Component(t))}toString(){return this.componentsString}Equals(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(let e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}PathByAppendingComponent(t){let e=new i;return e._components.push.apply(e._components,this._components),e._components.push(t),e}}e.Path=i,i.parentId="^",function(t){class e{constructor(t){this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}get isIndex(){return this.index>=0}get isParent(){return this.name==t.parentId}static ToParent(){return new e(t.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}t.Component=e}(i=e.Path||(e.Path={}))},function(t,e){t.exports=require("puerts")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ValueType=e.ListValue=e.VariablePointerValue=e.DivertTargetValue=e.StringValue=e.FloatValue=e.IntValue=e.Value=e.AbstractValue=void 0;const i=n(3),r=n(4),s=n(8),a=n(11),o=n(7),l=n(13),u=n(2);class h extends i.InkObject{static Create(t,e){if(e){if(e===S.Int&&Number.isInteger(Number(t)))return new d(Number(t));if(e===S.Float&&!isNaN(t))return new p(Number(t))}if("boolean"==typeof t){t=!!t?1:0}return"string"==typeof t?new f(String(t)):Number.isInteger(Number(t))?new d(Number(t)):isNaN(t)?t instanceof r.Path?new m(o.asOrThrows(t,r.Path)):t instanceof s.InkList?new y(o.asOrThrows(t,s.InkList)):null:new p(Number(t))}Copy(){return o.asOrThrows(h.Create(this),i.InkObject)}BadCastException(t){return new a.StoryException("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}e.AbstractValue=h;class c extends h{constructor(t){super(),this.value=t}get valueObject(){return this.value}toString(){return null===this.value?u.throwNullException("Value.value"):this.value.toString()}}e.Value=c;class d extends c{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return S.Int}Cast(t){if(null===this.value)return u.throwNullException("Value.value");if(t==this.valueType)return this;if(t==S.Float)return new p(this.value);if(t==S.String)return new f(""+this.value);throw this.BadCastException(t)}}e.IntValue=d;class p extends c{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return S.Float}Cast(t){if(null===this.value)return u.throwNullException("Value.value");if(t==this.valueType)return this;if(t==S.Int)return new d(this.value);if(t==S.String)return new f(""+this.value);throw this.BadCastException(t)}}e.FloatValue=p;class f extends c{constructor(t){if(super(t||""),this._isNewline="\n"==this.value,this._isInlineWhitespace=!0,null===this.value)return u.throwNullException("Value.value");this.value.length>0&&this.value.split("").every(t=>" "==t||"\t"==t||(this._isInlineWhitespace=!1,!1))}get valueType(){return S.String}get isTruthy(){return null===this.value?u.throwNullException("Value.value"):this.value.length>0}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(t){if(t==this.valueType)return this;if(t==S.Int){let e=l.tryParseInt(this.value);if(e.exists)return new d(e.result);throw this.BadCastException(t)}if(t==S.Float){let e=l.tryParseFloat(this.value);if(e.exists)return new p(e.result);throw this.BadCastException(t)}throw this.BadCastException(t)}}e.StringValue=f;class m extends c{constructor(t){super(t)}get valueType(){return S.DivertTarget}get targetPath(){return null===this.value?u.throwNullException("Value.value"):this.value}set targetPath(t){this.value=t}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a divert target")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"DivertTargetValue("+this.targetPath+")"}}e.DivertTargetValue=m;class g extends c{constructor(t,e=-1){super(t),this._contextIndex=e}get contextIndex(){return this._contextIndex}set contextIndex(t){this._contextIndex=t}get variableName(){return null===this.value?u.throwNullException("Value.value"):this.value}set variableName(t){this.value=t}get valueType(){return S.VariablePointer}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new g(this.variableName,this.contextIndex)}}e.VariablePointerValue=g;class y extends c{get isTruthy(){return null===this.value?u.throwNullException("this.value"):this.value.Count>0}get valueType(){return S.List}Cast(t){if(null===this.value)return u.throwNullException("Value.value");if(t==S.Int){let t=this.value.maxItem;return t.Key.isNull?new d(0):new d(t.Value)}if(t==S.Float){let t=this.value.maxItem;return t.Key.isNull?new p(0):new p(t.Value)}if(t==S.String){let t=this.value.maxItem;return t.Key.isNull?new f(""):new f(t.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}constructor(t,e){super(null),t||e?t instanceof s.InkList?this.value=new s.InkList(t):t instanceof s.InkListItem&&"number"==typeof e&&(this.value=new s.InkList({Key:t,Value:e})):this.value=new s.InkList}static RetainListOriginsForAssignment(t,e){let n=o.asOrNull(t,y),i=o.asOrNull(e,y);return i&&null===i.value?u.throwNullException("newList.value"):n&&null===n.value?u.throwNullException("oldList.value"):void(n&&i&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames))}}var S;e.ListValue=y,function(t){t[t.Int=0]="Int",t[t.Float=1]="Float",t[t.List=2]="List",t[t.String=3]="String",t[t.DivertTarget=4]="DivertTarget",t[t.VariablePointer=5]="VariablePointer"}(S=e.ValueType||(e.ValueType={}))},function(t,e,n){"use strict";function i(t,e){return t}Object.defineProperty(e,"__esModule",{value:!0}),e.isEquatable=e.nullIfUndefined=e.asINamedContentOrNull=e.asNumberOrThrows=e.asOrThrows=e.asOrNull=void 0,e.asOrNull=function(t,e){return t instanceof e?i(t,e):null},e.asOrThrows=function(t,e){if(t instanceof e)return i(t,e);throw new Error(`${t} is not of type ${e}`)},e.asNumberOrThrows=function(t){if("number"==typeof t)return t;throw new Error(t+" is not a number")},e.asINamedContentOrNull=function(t){return t.hasValidName&&t.name?t:null},e.nullIfUndefined=function(t){return void 0===t?null:t},e.isEquatable=function(t){return"object"==typeof t&&"function"==typeof t.Equals}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.InkList=e.InkListItem=void 0;const i=n(2),r=n(10);class s{constructor(){if(this.originName=null,this.itemName=null,void 0!==arguments[1]){let t=arguments[0],e=arguments[1];this.originName=t,this.itemName=e}else if(arguments[0]){let t=arguments[0].toString().split(".");this.originName=t[0],this.itemName=t[1]}}static get Null(){return new s(null,null)}get isNull(){return null==this.originName&&null==this.itemName}get fullName(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(t){if(t instanceof s){let e=t;return e.itemName==this.itemName&&e.originName==this.originName}return!1}copy(){return new s(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(t){let e=JSON.parse(t);if(!s.isLikeInkListItem(e))return s.Null;let n=e;return new s(n.originName,n.itemName)}static isLikeInkListItem(t){return"object"==typeof t&&(!(!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName"))&&(("string"==typeof t.originName||null===typeof t.originName)&&("string"==typeof t.itemName||null===typeof t.itemName)))}}e.InkListItem=s;class a extends Map{constructor(){if(super(arguments[0]instanceof a?arguments[0]:[]),this.origins=null,this._originNames=[],arguments[0]instanceof a){let t=arguments[0];t._originNames&&(this._originNames=t._originNames.slice())}else if("string"==typeof arguments[0]){let t=arguments[0],e=arguments[1];this.SetInitialOriginName(t);let n=e.listDefinitions.TryListGetDefinition(t,null);if(!n.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+t);this.origins=[n.result]}else if("object"==typeof arguments[0]&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let t=arguments[0];this.Add(t.Key,t.Value)}}AddItem(t){if(t instanceof s){let e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return i.throwNullException("this.origins");for(let t of this.origins)if(t.name==e.originName){let n=t.TryGetValueForItem(e,0);if(n.exists)return void this.Add(e,n.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}{let e=t,n=null;if(null===this.origins)return i.throwNullException("this.origins");for(let t of this.origins){if(null===e)return i.throwNullException("itemName");if(t.ContainsItemWithName(e)){if(null!=n)throw new Error("Could not add the item "+e+" to this list because it could come from either "+t.name+" or "+n.name);n=t}}if(null==n)throw new Error("Could not add the item "+e+" to this list because it isn't known to any list definitions previously associated with this list.");let r=new s(n.name,e),a=n.ValueForItem(r);this.Add(r,a)}}ContainsItemNamed(t){for(let[e]of this){if(s.fromSerializedKey(e).itemName==t)return!0}return!1}ContainsKey(t){return this.has(t.serialized())}Add(t,e){let n=t.serialized();if(this.has(n))throw new Error("The Map already contains an entry for "+t);this.set(n,e)}Remove(t){return this.delete(t.serialized())}get Count(){return this.size}get originOfMaxItem(){if(null==this.origins)return null;let t=this.maxItem.Key.originName,e=null;return this.origins.every(n=>n.name!=t||(e=n,!1)),e}get originNames(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(let[t]of this){let e=s.fromSerializedKey(t);if(null===e.originName)return i.throwNullException("item.originName");this._originNames.push(e.originName)}}return this._originNames}SetInitialOriginName(t){this._originNames=[t]}SetInitialOriginNames(t){this._originNames=null==t?null:t.slice()}get maxItem(){let t={Key:s.Null,Value:0};for(let[e,n]of this){let i=s.fromSerializedKey(e);(t.Key.isNull||n>t.Value)&&(t={Key:i,Value:n})}return t}get minItem(){let t={Key:s.Null,Value:0};for(let[e,n]of this){let i=s.fromSerializedKey(e);(t.Key.isNull||n<t.Value)&&(t={Key:i,Value:n})}return t}get inverse(){let t=new a;if(null!=this.origins)for(let e of this.origins)for(let[n,i]of e.items){let e=s.fromSerializedKey(n);this.ContainsKey(e)||t.Add(e,i)}return t}get all(){let t=new a;if(null!=this.origins)for(let e of this.origins)for(let[n,i]of e.items){let e=s.fromSerializedKey(n);t.set(e.serialized(),i)}return t}Union(t){let e=new a(this);for(let[n,i]of t)e.set(n,i);return e}Intersect(t){let e=new a;for(let[n,i]of this)t.has(n)&&e.set(n,i);return e}Without(t){let e=new a(this);for(let[n]of t)e.delete(n);return e}Contains(t){for(let[e]of t)if(!this.has(e))return!1;return!0}GreaterThan(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}GreaterThanOrEquals(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}LessThan(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}LessThanOrEquals(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}MaxAsList(){return this.Count>0?new a(this.maxItem):new a}MinAsList(){return this.Count>0?new a(this.minItem):new a}ListWithSubRange(t,e){if(0==this.Count)return new a;let n=this.orderedItems,i=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?i=t:t instanceof a&&t.Count>0&&(i=t.minItem.Value),Number.isInteger(e)?r=e:t instanceof a&&t.Count>0&&(r=e.maxItem.Value);let s=new a;s.SetInitialOriginNames(this.originNames);for(let t of n)t.Value>=i&&t.Value<=r&&s.Add(t.Key,t.Value);return s}Equals(t){if(t instanceof a==!1)return!1;if(t.Count!=this.Count)return!1;for(let[e]of this)if(!t.has(e))return!1;return!0}get orderedItems(){let t=new Array;for(let[e,n]of this){let i=s.fromSerializedKey(e);t.push({Key:i,Value:n})}return t.sort((t,e)=>null===t.Key.originName?i.throwNullException("x.Key.originName"):null===e.Key.originName?i.throwNullException("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0),t}toString(){let t=this.orderedItems,e=new r.StringBuilder;for(let n=0;n<t.length;n++){n>0&&e.Append(", ");let r=t[n].Key;if(null===r.itemName)return i.throwNullException("item.itemName");e.Append(r.itemName)}return e.toString()}valueOf(){return NaN}}e.InkList=a},function(t,e,n){"use strict";(function(t){var i=e;function r(t,e,n){for(var i=Object.keys(e),r=0;r<i.length;++r)void 0!==t[i[r]]&&n||(t[i[r]]=e[i[r]]);return t}function s(t){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&r(this,n)}return(e.prototype=Object.create(Error.prototype)).constructor=e,Object.defineProperty(e.prototype,"name",{get:function(){return t}}),e.prototype.toString=function(){return this.name+": "+this.message},e}i.asPromise=n(45),i.base64=n(46),i.EventEmitter=n(47),i.float=n(48),i.inquire=n(49),i.utf8=n(50),i.pool=n(51),i.LongBits=n(52),i.isNode=Boolean(void 0!==t&&t&&t.process&&t.process.versions&&t.process.versions.node),i.global=i.isNode&&t||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,i.emptyArray=Object.freeze?Object.freeze([]):[],i.emptyObject=Object.freeze?Object.freeze({}):{},i.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},i.isString=function(t){return"string"==typeof t||t instanceof String},i.isObject=function(t){return t&&"object"==typeof t},i.isset=i.isSet=function(t,e){var n=t[e];return!(null==n||!t.hasOwnProperty(e))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},i.Buffer=function(){try{var t=i.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),i._Buffer_from=null,i._Buffer_allocUnsafe=null,i.newBuffer=function(t){return"number"==typeof t?i.Buffer?i._Buffer_allocUnsafe(t):new i.Array(t):i.Buffer?i._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},i.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,i.Long=i.global.dcodeIO&&i.global.dcodeIO.Long||i.global.Long||i.inquire("long"),i.key2Re=/^true|false|0|1$/,i.key32Re=/^-?(?:0|[1-9][0-9]*)$/,i.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,i.longToHash=function(t){return t?i.LongBits.from(t).toHash():i.LongBits.zeroHash},i.longFromHash=function(t,e){var n=i.LongBits.fromHash(t);return i.Long?i.Long.fromBits(n.lo,n.hi,e):n.toNumber(Boolean(e))},i.merge=r,i.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},i.newError=s,i.ProtocolError=s("ProtocolError"),i.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&void 0!==this[t[n]]&&null!==this[t[n]])return t[n]}},i.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}},i.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},i._configure=function(){var t=i.Buffer;t?(i._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,n){return new t(e,n)},i._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):i._Buffer_from=i._Buffer_allocUnsafe=null}}).call(this,n(44))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.StringBuilder=void 0;e.StringBuilder=class{constructor(t){t=void 0!==t?t.toString():"",this.string=t}get Length(){return this.string.length}Append(t){null!==t&&(this.string+=t)}AppendLine(t){void 0!==t&&this.Append(t),this.string+="\n"}AppendFormat(t,...e){this.string+=t.replace(/{(\d+)}/g,(t,n)=>void 0!==e[n]?e[n]:t)}toString(){return this.string}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.StoryException=void 0;class i extends Error{constructor(t){super(t),this.useEndLineNumber=!1,this.message=t,this.name="StoryException"}}e.StoryException=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Container=void 0;const i=n(6),r=n(2),s=n(10),a=n(3),o=n(35),l=n(4),u=n(15),h=n(13),c=n(7);class d extends a.InkObject{constructor(){super(...arguments),this.name="",this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return null!=this.name&&this.name.length>0}get content(){return this._content}set content(t){this.AddContent(t)}get namedOnlyContent(){let t=new Map;for(let[e,n]of this.namedContent){let i=c.asOrThrows(n,a.InkObject);t.set(e,i)}for(let e of this.content){let n=c.asINamedContentOrNull(e);null!=n&&n.hasValidName&&t.delete(n.name)}return 0==t.size&&(t=null),t}set namedOnlyContent(t){let e=this.namedOnlyContent;if(null!=e)for(let[t]of e)this.namedContent.delete(t);if(null!=t)for(let[,e]of t){let t=c.asINamedContentOrNull(e);null!=t&&this.AddToNamedContentOnly(t)}}get countFlags(){let t=0;return this.visitsShouldBeCounted&&(t|=d.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=d.CountFlags.Turns),this.countingAtStartOnly&&(t|=d.CountFlags.CountStartOnly),t==d.CountFlags.CountStartOnly&&(t=0),t}set countFlags(t){let e=t;(e&d.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&d.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&d.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let t=[],e=this;for(;e instanceof d;)e.content.length>0&&(t.push(new l.Path.Component(0)),e=e.content[0]);return new l.Path(t)}AddContent(t){if(t instanceof Array){let e=t;for(let t of e)this.AddContent(t)}else{let e=t;if(this._content.push(e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}}TryAddNamedContent(t){let e=c.asINamedContentOrNull(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}AddToNamedContentOnly(t){u.Debug.AssertType(t,a.InkObject,"Can only add Runtime.Objects to a Runtime.Container"),c.asOrThrows(t,a.InkObject).parent=this,this.namedContent.set(t.name,t)}ContentAtPath(t,e=0,n=-1){-1==n&&(n=t.length);let i=new o.SearchResult;i.approximate=!1;let r=this,s=this;for(let a=e;a<n;++a){let e=t.GetComponent(a);if(null==r){i.approximate=!0;break}let n=r.ContentWithPathComponent(e);if(null==n){i.approximate=!0;break}s=n,r=c.asOrNull(n,d)}return i.obj=s,i}InsertContent(t,e){if(this.content[e]=t,t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}AddContentsOfContainer(t){this.content=this.content.concat(t.content);for(let e of t.content)e.parent=this,this.TryAddNamedContent(e)}ContentWithPathComponent(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;{if(null===t.name)return r.throwNullException("component.name");let e=h.tryGetValueFromMap(this.namedContent,t.name,null);return e.exists?c.asOrThrows(e.result,a.InkObject):null}}BuildStringOfHierarchy(){let t;if(0==arguments.length)return t=new s.StringBuilder,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];let e=arguments[1],n=arguments[2];function r(){for(let n=0;n<4*e;++n)t.Append(" ")}r(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==n&&t.Append("  <---"),t.AppendLine(),e++;for(let s=0;s<this.content.length;++s){let a=this.content[s];if(a instanceof d){a.BuildStringOfHierarchy(t,e,n)}else r(),a instanceof i.StringValue?(t.Append('"'),t.Append(a.toString().replace("\n","\\n")),t.Append('"')):t.Append(a.toString());s!=this.content.length-1&&t.Append(","),a instanceof d||a!=n||t.Append("  <---"),t.AppendLine()}let o=new Map;for(let[t,e]of this.namedContent)this.content.indexOf(c.asOrThrows(e,a.InkObject))>=0||o.set(t,e);if(o.size>0){r(),t.AppendLine("-- named: --");for(let[,i]of o){u.Debug.AssertType(i,d,"Can only print out named Containers"),i.BuildStringOfHierarchy(t,e,n),t.AppendLine()}}e--,r(),t.Append("]")}}e.Container=d,function(t){let e;!function(t){t[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"}(e=t.CountFlags||(t.CountFlags={}))}(d=e.Container||(e.Container={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.tryParseFloat=e.tryParseInt=e.tryGetValueFromMap=void 0,e.tryGetValueFromMap=function(t,e,n){if(null===t)return{result:n,exists:!1};let i=t.get(e);return void 0===i?{result:n,exists:!1}:{result:i,exists:!0}},e.tryParseInt=function(t,e=0){let n=parseInt(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}},e.tryParseFloat=function(t,e=0){let n=parseFloat(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PushPopType=void 0,function(t){t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(e.PushPopType||(e.PushPopType={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Debug=void 0,function(t){function e(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),new Error("")}t.AssertType=function(t,n,i){e(t instanceof n,i)},t.Assert=e}(e.Debug||(e.Debug={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.JsonSerialisation=void 0;const i=n(12),r=n(6),s=n(22),a=n(20),o=n(14),l=n(23),u=n(24),h=n(25),c=n(26),d=n(27),p=n(18),f=n(21),m=n(4),g=n(28),y=n(36),S=n(29),C=n(8),v=n(7),b=n(2);class _{static JArrayToRuntimeObjList(t,e=!1){let n=t.length;e&&n--;let i=[];for(let e=0;e<n;e++){let n=t[e],r=this.JTokenToRuntimeObject(n);if(null===r)return b.throwNullException("runtimeObj");i.push(r)}return i}static WriteDictionaryRuntimeObjs(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WritePropertyStart(n),this.WriteRuntimeObject(t,i),t.WritePropertyEnd();t.WriteObjectEnd()}static WriteListRuntimeObjs(t,e){t.WriteArrayStart();for(let n of e)this.WriteRuntimeObject(t,n);t.WriteArrayEnd()}static WriteIntDictionary(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WriteIntProperty(n,i);t.WriteObjectEnd()}static WriteRuntimeObject(t,e){let n=v.asOrNull(e,i.Container);if(n)return void this.WriteRuntimeContainer(t,n);let m=v.asOrNull(e,l.Divert);if(m){let e,n="->";return m.isExternal?n="x()":m.pushesToStack&&(m.stackPushType==o.PushPopType.Function?n="f()":m.stackPushType==o.PushPopType.Tunnel&&(n="->t->")),e=m.hasVariableTarget?m.variableDivertName:m.targetPathString,t.WriteObjectStart(),t.WriteProperty(n,e),m.hasVariableTarget&&t.WriteProperty("var",!0),m.isConditional&&t.WriteProperty("c",!0),m.externalArgs>0&&t.WriteIntProperty("exArgs",m.externalArgs),void t.WriteObjectEnd()}let y=v.asOrNull(e,u.ChoicePoint);if(y)return t.WriteObjectStart(),t.WriteProperty("*",y.pathStringOnChoice),t.WriteIntProperty("flg",y.flags),void t.WriteObjectEnd();let S=v.asOrNull(e,r.IntValue);if(S)return void t.WriteInt(S.value);let C=v.asOrNull(e,r.FloatValue);if(C)return void t.WriteFloat(C.value);let w=v.asOrNull(e,r.StringValue);if(w)return void(w.isNewline?t.Write("\n",!1):(t.WriteStringStart(),t.WriteStringInner("^"),t.WriteStringInner(w.value),t.WriteStringEnd()));let P=v.asOrNull(e,r.ListValue);if(P)return void this.WriteInkList(t,P);let O=v.asOrNull(e,r.DivertTargetValue);if(O)return t.WriteObjectStart(),null===O.value?b.throwNullException("divTargetVal.value"):(t.WriteProperty("^->",O.value.componentsString),void t.WriteObjectEnd());let T=v.asOrNull(e,r.VariablePointerValue);if(T)return t.WriteObjectStart(),t.WriteProperty("^var",T.value),t.WriteIntProperty("ci",T.contextIndex),void t.WriteObjectEnd();if(v.asOrNull(e,s.Glue))return void t.Write("<>");let N=v.asOrNull(e,a.ControlCommand);if(N)return void t.Write(_._controlCommandNames[N.commandType]);let E=v.asOrNull(e,d.NativeFunctionCall);if(E){let e=E.name;return"^"==e&&(e="L^"),void t.Write(e)}let I=v.asOrNull(e,h.VariableReference);if(I){t.WriteObjectStart();let e=I.pathStringForCount;return null!=e?t.WriteProperty("CNT?",e):t.WriteProperty("VAR?",I.name),void t.WriteObjectEnd()}let x=v.asOrNull(e,c.VariableAssignment);if(x){t.WriteObjectStart();let e=x.isGlobal?"VAR=":"temp=";return t.WriteProperty(e,x.variableName),x.isNewDeclaration||t.WriteProperty("re",!0),void t.WriteObjectEnd()}if(v.asOrNull(e,p.Void))return void t.Write("void");let A=v.asOrNull(e,f.Tag);if(A)return t.WriteObjectStart(),t.WriteProperty("#",A.text),void t.WriteObjectEnd();let k=v.asOrNull(e,g.Choice);if(!k)throw new Error("Failed to convert runtime object to Json token: "+e);this.WriteChoice(t,k)}static JObjectToDictionaryRuntimeObjs(t){let e=new Map;for(let n in t)if(t.hasOwnProperty(n)){let i=this.JTokenToRuntimeObject(t[n]);if(null===i)return b.throwNullException("inkObject");e.set(n,i)}return e}static JObjectToIntDictionary(t){let e=new Map;for(let n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}static JTokenToRuntimeObject(t){if("number"==typeof t&&!isNaN(t))return r.Value.Create(t);if("string"==typeof t){let e=t.toString(),n=e[0];if("^"==n)return new r.StringValue(e.substring(1));if("\n"==n&&1==e.length)return new r.StringValue("\n");if("<>"==e)return new s.Glue;for(let t=0;t<_._controlCommandNames.length;++t){if(e==_._controlCommandNames[t])return new a.ControlCommand(t)}if("L^"==e&&(e="^"),d.NativeFunctionCall.CallExistsWithName(e))return d.NativeFunctionCall.CallWithName(e);if("->->"==e)return a.ControlCommand.PopTunnel();if("~ret"==e)return a.ControlCommand.PopFunction();if("void"==e)return new p.Void}if("object"==typeof t&&!Array.isArray(t)){let e,n=t;if(n["^->"])return e=n["^->"],new r.DivertTargetValue(new m.Path(e.toString()));if(n["^var"]){e=n["^var"];let t=new r.VariablePointerValue(e.toString());return"ci"in n&&(e=n.ci,t.contextIndex=parseInt(e)),t}let i=!1,s=!1,a=o.PushPopType.Function,d=!1;if((e=n["->"])?i=!0:(e=n["f()"])?(i=!0,s=!0,a=o.PushPopType.Function):(e=n["->t->"])?(i=!0,s=!0,a=o.PushPopType.Tunnel):(e=n["x()"])&&(i=!0,d=!0,s=!1,a=o.PushPopType.Function),i){let t=new l.Divert;t.pushesToStack=s,t.stackPushType=a,t.isExternal=d;let i=e.toString();return(e=n.var)?t.variableDivertName=i:t.targetPathString=i,t.isConditional=!!n.c,d&&(e=n.exArgs)&&(t.externalArgs=parseInt(e)),t}if(e=n["*"]){let t=new u.ChoicePoint;return t.pathStringOnChoice=e.toString(),(e=n.flg)&&(t.flags=parseInt(e)),t}if(e=n["VAR?"])return new h.VariableReference(e.toString());if(e=n["CNT?"]){let t=new h.VariableReference;return t.pathStringForCount=e.toString(),t}let p=!1,g=!1;if((e=n["VAR="])?(p=!0,g=!0):(e=n["temp="])&&(p=!0,g=!1),p){let t=e.toString(),i=!n.re,r=new c.VariableAssignment(t,i);return r.isGlobal=g,r}if(void 0!==n["#"])return e=n["#"],new f.Tag(e.toString());if(e=n.list){let t=e,i=new C.InkList;if(e=n.origins){let t=e;i.SetInitialOriginNames(t)}for(let e in t)if(t.hasOwnProperty(e)){let n=t[e],r=new C.InkListItem(e),s=parseInt(n);i.Add(r,s)}return new r.ListValue(i)}if(null!=n.originalChoicePath)return this.JObjectToChoice(n)}if(Array.isArray(t))return this.JArrayToContainer(t);if(null==t)return null;throw new Error("Failed to convert token to runtime object: "+JSON.stringify(t))}static WriteRuntimeContainer(t,e,n=!1){if(t.WriteArrayStart(),null===e)return b.throwNullException("container");for(let n of e.content)this.WriteRuntimeObject(t,n);let r=e.namedOnlyContent,s=e.countFlags,a=null!=e.name&&!n,o=null!=r||s>0||a;if(o&&t.WriteObjectStart(),null!=r)for(let[e,n]of r){let r=e,s=v.asOrNull(n,i.Container);t.WritePropertyStart(r),this.WriteRuntimeContainer(t,s,!0),t.WritePropertyEnd()}a&&t.WriteProperty("#n",e.name),o?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}static JArrayToContainer(t){let e=new i.Container;e.content=this.JArrayToRuntimeObjList(t,!0);let n=t[t.length-1];if(null!=n){let t=new Map;for(let r in n)if("#f"==r)e.countFlags=parseInt(n[r]);else if("#n"==r)e.name=n[r].toString();else{let e=this.JTokenToRuntimeObject(n[r]),s=v.asOrNull(e,i.Container);s&&(s.name=r),t.set(r,e)}e.namedOnlyContent=t}return e}static JObjectToChoice(t){let e=new g.Choice;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}static WriteChoice(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),t.WriteObjectEnd()}static WriteInkList(t,e){let n=e.value;if(null===n)return b.throwNullException("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();for(let[e,i]of n){let n=C.InkListItem.fromSerializedKey(e),r=i;if(null===n.itemName)return b.throwNullException("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(n.originName?n.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(n.itemName),t.WritePropertyNameEnd(),t.Write(r),t.WritePropertyEnd()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),0==n.Count&&null!=n.originNames&&n.originNames.length>0){t.WritePropertyStart("origins"),t.WriteArrayStart();for(let e of n.originNames)t.Write(e);t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}static ListDefinitionsToJToken(t){let e={};for(let n of t.lists){let t={};for(let[e,i]of n.items){let n=C.InkListItem.fromSerializedKey(e);if(null===n.itemName)return b.throwNullException("item.itemName");t[n.itemName]=i}e[n.name]=t}return e}static JTokenToListDefinitions(t){let e=t,n=[];for(let t in e)if(e.hasOwnProperty(t)){let i=t.toString(),r=e[t],s=new Map;for(let n in r)if(e.hasOwnProperty(t)){let t=r[n];s.set(n,parseInt(t))}let a=new y.ListDefinition(i,s);n.push(a)}return new S.ListDefinitionsOrigin(n)}}e.JsonSerialisation=_,_._controlCommandNames=(()=>{let t=[];t[a.ControlCommand.CommandType.EvalStart]="ev",t[a.ControlCommand.CommandType.EvalOutput]="out",t[a.ControlCommand.CommandType.EvalEnd]="/ev",t[a.ControlCommand.CommandType.Duplicate]="du",t[a.ControlCommand.CommandType.PopEvaluatedValue]="pop",t[a.ControlCommand.CommandType.PopFunction]="~ret",t[a.ControlCommand.CommandType.PopTunnel]="->->",t[a.ControlCommand.CommandType.BeginString]="str",t[a.ControlCommand.CommandType.EndString]="/str",t[a.ControlCommand.CommandType.NoOp]="nop",t[a.ControlCommand.CommandType.ChoiceCount]="choiceCnt",t[a.ControlCommand.CommandType.Turns]="turn",t[a.ControlCommand.CommandType.TurnsSince]="turns",t[a.ControlCommand.CommandType.ReadCount]="readc",t[a.ControlCommand.CommandType.Random]="rnd",t[a.ControlCommand.CommandType.SeedRandom]="srnd",t[a.ControlCommand.CommandType.VisitIndex]="visit",t[a.ControlCommand.CommandType.SequenceShuffleIndex]="seq",t[a.ControlCommand.CommandType.StartThread]="thread",t[a.ControlCommand.CommandType.Done]="done",t[a.ControlCommand.CommandType.End]="end",t[a.ControlCommand.CommandType.ListFromInt]="listInt",t[a.ControlCommand.CommandType.ListRange]="range",t[a.ControlCommand.CommandType.ListRandom]="lrnd";for(let e=0;e<a.ControlCommand.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t})()},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Pointer=void 0;const i=n(4);class r{constructor(){this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}get isNull(){return null==this.container}get path(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new i.Path.Component(this.index)):this.container.path}toString(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new r(this.container,this.index)}static StartOf(t){return new r(t,0)}static get Null(){return new r(null,-1)}}e.Pointer=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Void=void 0;const i=n(3);class r extends i.InkObject{}e.Void=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Story=void 0;const i=n(12),r=n(3),s=n(16),a=n(37),o=n(20),l=n(14),u=n(24),h=n(28),c=n(23),d=n(6),p=n(4),f=n(18),m=n(21),g=n(26),y=n(25),S=n(27),C=n(11),v=n(30),b=n(10),_=n(29),w=n(41),P=n(17),O=n(8),T=n(7),N=n(2),E=n(31);var I=n(8);Object.defineProperty(e,"InkList",{enumerable:!0,get:function(){return I.InkList}}),Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});class x extends r.InkObject{constructor(){let t;super(),this.inkVersionMinimumCompatible=18,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateSnapshotAtLastNewline=null,this._recursiveContinueCount=0,this._asyncSaving=!1,this._profiler=null;let e=null,n=null;if(arguments[0]instanceof i.Container)t=arguments[0],void 0!==arguments[1]&&(e=arguments[1]),this._mainContentContainer=t;else if("string"==typeof arguments[0]){let t=arguments[0];n=E.SimpleJson.TextToDictionary(t)}else n=arguments[0];if(null!=e&&(this._listDefinitions=new _.ListDefinitionsOrigin(e)),this._externals=new Map,null!==n){let t=n,e=t.inkVersion;if(null==e)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");let r=parseInt(e);if(r>x.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(r<this.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");r!=x.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");let a,o=t.root;if(null==o)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(a=t.listDefs)&&(this._listDefinitions=s.JsonSerialisation.JTokenToListDefinitions(a)),this._mainContentContainer=T.asOrThrows(s.JsonSerialisation.JTokenToRuntimeObject(o),i.Container),this.ResetState()}}get currentChoices(){let t=[];if(null===this._state)return N.throwNullException("this._state");for(let e of this._state.currentChoices)e.isInvisibleDefault||(e.index=t.length,t.push(e));return t}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}ToJson(t){let e=!1;if(t||(e=!0,t=new E.SimpleJson.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",x.inkVersionCurrent),t.WriteProperty("root",t=>s.JsonSerialisation.WriteRuntimeContainer(t,this._mainContentContainer)),null!=this._listDefinitions){t.WritePropertyStart("listDefs"),t.WriteObjectStart();for(let e of this._listDefinitions.lists){t.WritePropertyStart(e.name),t.WriteObjectStart();for(let[n,i]of e.items){let e=O.InkListItem.fromSerializedKey(n),r=i;t.WriteIntProperty(e.itemName,r)}t.WriteObjectEnd(),t.WritePropertyEnd()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),e)return t.ToString()}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new a.StoryState(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(null===this._state)return N.throwNullException("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return N.throwNullException("this._state");this._state.ForceEnd()}ResetGlobals(){if(this._mainContentContainer.namedContent.get("global decl")){let t=this.state.currentPointer.copy();this.ChoosePath(new p.Path("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}ContinueInternal(t=0){null!=this._profiler&&this._profiler.PreContinue();let e=t>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new C.StoryException("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}let n=new w.Stopwatch;n.Start();let i=!1;do{try{i=this.ContinueSingleStep()}catch(t){if(!(t instanceof C.StoryException))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}if(i)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);n.Stop(),!i&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(l.PushPopType.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(l.PushPopType.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}ContinueSingleStep(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return N.throwNullException("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return N.throwNullException("this.state.currentTags");let t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==x.OutputStateChange.ExtendedBeyondNewline)return this.RestoreStateSnapshot(),!0;t==x.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(t,e,n,i){if(null===t)return N.throwNullException("prevText");if(null===e)return N.throwNullException("currText");let r=e.length>=t.length&&"\n"==e.charAt(t.length-1);if(n==i&&t.length==e.length&&r)return x.OutputStateChange.NoChange;if(!r)return x.OutputStateChange.NewlineRemoved;if(i>n)return x.OutputStateChange.ExtendedBeyondNewline;for(let n=t.length;n<e.length;n++){let t=e.charAt(n);if(" "!=t&&"\t"!=t)return x.OutputStateChange.ExtendedBeyondNewline}return x.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");let t=new b.StringBuilder;for(;this.canContinue;)t.Append(this.Continue());return t.toString()}ContentAtPath(t){return this.mainContentContainer.ContentAtPath(t)}KnotContainerWithName(t){let e=this.mainContentContainer.namedContent.get(t);return e instanceof i.Container?e:null}PointerAtPath(t){if(0==t.length)return P.Pointer.Null;let e=new P.Pointer,n=t.length,i=null;return null===t.lastComponent?N.throwNullException("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}StateSnapshot(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}RestoreStateSnapshot(){null===this._stateSnapshotAtLastNewline&&N.throwNullException("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}DiscardSnapshot(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}CopyStateForBackgroundThreadSave(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");let t=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,t}BackgroundSaveComplete(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}Step(){let t=!0,e=this.state.currentPointer.copy();if(e.isNull)return;let n=T.asOrNull(e.Resolve(),i.Container);for(;n&&(this.VisitContainer(n,!0),0!=n.content.length);)e=P.Pointer.StartOf(n),n=T.asOrNull(e.Resolve(),i.Container);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);let r=e.Resolve(),s=this.PerformLogicAndFlowControl(r);if(this.state.currentPointer.isNull)return;s&&(t=!1);let a=T.asOrNull(r,u.ChoicePoint);if(a){let e=this.ProcessChoice(a);e&&this.state.generatedChoices.push(e),r=null,t=!1}if(r instanceof i.Container&&(t=!1),t){let t=T.asOrNull(r,d.VariablePointerValue);if(t&&-1==t.contextIndex){let e=this.state.callStack.ContextForVariableNamed(t.variableName);r=new d.VariablePointerValue(t.variableName,e)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(r):this.state.PushToOutputStream(r)}this.NextContent();let l=T.asOrNull(r,o.ControlCommand);l&&l.commandType==o.ControlCommand.CommandType.StartThread&&this.state.callStack.PushThread()}VisitContainer(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}VisitChangedContainersDueToDivert(){let t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(e.isNull||-1==e.index)return;if(this._prevContainers.length=0,!t.isNull){let e=t.Resolve(),n=T.asOrNull(e,i.Container)||T.asOrNull(t.container,i.Container);for(;n;)this._prevContainers.push(n),n=T.asOrNull(n.parent,i.Container)}let n=e.Resolve();if(null==n)return;let r=T.asOrNull(n.parent,i.Container);for(;r&&(this._prevContainers.indexOf(r)<0||r.countingAtStartOnly);){let t=r.content.length>0&&n==r.content[0];this.VisitContainer(r,t),n=r,r=T.asOrNull(r.parent,i.Container)}}ProcessChoice(t){let e=!0;if(t.hasCondition){let t=this.state.PopEvaluationStack();this.IsTruthy(t)||(e=!1)}let n="",i="";if(t.hasChoiceOnlyContent){i=T.asOrThrows(this.state.PopEvaluationStack(),d.StringValue).value||""}if(t.hasStartContent){n=T.asOrThrows(this.state.PopEvaluationStack(),d.StringValue).value||""}if(t.onceOnly){this.state.VisitCountForContainer(t.choiceTarget)>0&&(e=!1)}if(!e)return null;let r=new h.Choice;return r.targetPath=t.pathOnChoice,r.sourcePath=t.path.toString(),r.isInvisibleDefault=t.isInvisibleDefault,r.threadAtGeneration=this.state.callStack.ForkThread(),r.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),r}IsTruthy(t){if(t instanceof d.Value){let e=t;if(e instanceof d.DivertTargetValue){let t=e;return this.Error("Shouldn't use a divert target (to "+t.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}PerformLogicAndFlowControl(t){if(null==t)return!1;if(t instanceof c.Divert){let e=t;if(e.isConditional){let t=this.state.PopEvaluationStack();if(!this.IsTruthy(t))return!0}if(e.hasVariableTarget){let t=e.variableDivertName,n=this.state.variablesState.GetVariableWithName(t);if(null==n)this.Error("Tried to divert using a target from a variable that could not be found ("+t+")");else if(!(n instanceof d.DivertTargetValue)){let e=T.asOrNull(n,d.IntValue),i="Tried to divert to a target from a variable, but the variable ("+t+") didn't contain a divert target, it ";e instanceof d.IntValue&&0==e.value?i+="was empty/null (the value 0).":i+="contained '"+n+"'.",this.Error(i)}let i=T.asOrThrows(n,d.DivertTargetValue);this.state.divertedPointer=this.PointerAtPath(i.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof o.ControlCommand){let e=t;switch(e.commandType){case o.ControlCommand.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case o.ControlCommand.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case o.ControlCommand.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){let t=this.state.PopEvaluationStack();if(!(t instanceof f.Void)){let e=new d.StringValue(t.toString());this.state.PushToOutputStream(e)}}break;case o.ControlCommand.CommandType.NoOp:break;case o.ControlCommand.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case o.ControlCommand.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case o.ControlCommand.CommandType.PopFunction:case o.ControlCommand.CommandType.PopTunnel:let t=e.commandType==o.ControlCommand.CommandType.PopFunction?l.PushPopType.Function:l.PushPopType.Tunnel,n=null;if(t==l.PushPopType.Tunnel){let t=this.state.PopEvaluationStack();n=T.asOrNull(t,d.DivertTargetValue),null===n&&this.Assert(t instanceof f.Void,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==t&&this.state.callStack.canPop)this.state.PopCallStack(),n&&(this.state.divertedPointer=this.PointerAtPath(n.targetPath));else{let e=new Map;e.set(l.PushPopType.Function,"function return statement (~ return)"),e.set(l.PushPopType.Tunnel,"tunnel onwards statement (->->)");let n=e.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(n="end of flow (-> END or choice)");let i="Found "+e.get(t)+", when expected "+n;this.Error(i)}break;case o.ControlCommand.CommandType.BeginString:this.state.PushToOutputStream(e),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case o.ControlCommand.CommandType.EndString:let r=[],s=0;for(let t=this.state.outputStream.length-1;t>=0;--t){let e=this.state.outputStream[t];s++;let n=T.asOrNull(e,o.ControlCommand);if(n&&n.commandType==o.ControlCommand.CommandType.BeginString)break;e instanceof d.StringValue&&r.push(e)}this.state.PopFromOutputStream(s),r=r.reverse();let a=new b.StringBuilder;for(let t of r)a.Append(t.toString());this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new d.StringValue(a.toString()));break;case o.ControlCommand.CommandType.ChoiceCount:let u=this.state.generatedChoices.length;this.state.PushEvaluationStack(new d.IntValue(u));break;case o.ControlCommand.CommandType.Turns:this.state.PushEvaluationStack(new d.IntValue(this.state.currentTurnIndex+1));break;case o.ControlCommand.CommandType.TurnsSince:case o.ControlCommand.CommandType.ReadCount:let h=this.state.PopEvaluationStack();if(!(h instanceof d.DivertTargetValue)){let t="";h instanceof d.IntValue&&(t=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+h+t);break}let c,p=T.asOrThrows(h,d.DivertTargetValue),m=T.asOrNull(this.ContentAtPath(p.targetPath).correctObj,i.Container);null!=m?c=e.commandType==o.ControlCommand.CommandType.TurnsSince?this.state.TurnsSinceForContainer(m):this.state.VisitCountForContainer(m):(c=e.commandType==o.ControlCommand.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+e.toString()+" lookup at "+p.targetPath.toString())),this.state.PushEvaluationStack(new d.IntValue(c));break;case o.ControlCommand.CommandType.Random:{let t=T.asOrNull(this.state.PopEvaluationStack(),d.IntValue),e=T.asOrNull(this.state.PopEvaluationStack(),d.IntValue);if(null==e||e instanceof d.IntValue==!1)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==t||e instanceof d.IntValue==!1)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===t.value)return N.throwNullException("maxInt.value");if(null===e.value)return N.throwNullException("minInt.value");let n=t.value-e.value+1;n<=0&&this.Error("RANDOM was called with minimum as "+e.value+" and maximum as "+t.value+". The maximum must be larger");let i=this.state.storySeed+this.state.previousRandom,r=new v.PRNG(i).next(),s=r%n+e.value;this.state.PushEvaluationStack(new d.IntValue(s)),this.state.previousRandom=r;break}case o.ControlCommand.CommandType.SeedRandom:let g=T.asOrNull(this.state.PopEvaluationStack(),d.IntValue);if(null==g||g instanceof d.IntValue==!1)return this.Error("Invalid value passed to SEED_RANDOM");if(null===g.value)return N.throwNullException("minInt.value");this.state.storySeed=g.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new f.Void);break;case o.ControlCommand.CommandType.VisitIndex:let y=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new d.IntValue(y));break;case o.ControlCommand.CommandType.SequenceShuffleIndex:let S=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new d.IntValue(S));break;case o.ControlCommand.CommandType.StartThread:break;case o.ControlCommand.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=P.Pointer.Null);break;case o.ControlCommand.CommandType.End:this.state.ForceEnd();break;case o.ControlCommand.CommandType.ListFromInt:let _=T.asOrNull(this.state.PopEvaluationStack(),d.IntValue),w=T.asOrThrows(this.state.PopEvaluationStack(),d.StringValue);if(null===_)throw new C.StoryException("Passed non-integer when creating a list element from a numerical value.");let E=null;if(null===this.listDefinitions)return N.throwNullException("this.listDefinitions");let I=this.listDefinitions.TryListGetDefinition(w.value,null);if(!I.exists)throw new C.StoryException("Failed to find LIST called "+w.value);{if(null===_.value)return N.throwNullException("minInt.value");let t=I.result.TryGetItemWithValue(_.value,O.InkListItem.Null);t.exists&&(E=new d.ListValue(t.result,_.value))}null==E&&(E=new d.ListValue),this.state.PushEvaluationStack(E);break;case o.ControlCommand.CommandType.ListRange:let x=T.asOrNull(this.state.PopEvaluationStack(),d.Value),A=T.asOrNull(this.state.PopEvaluationStack(),d.Value),k=T.asOrNull(this.state.PopEvaluationStack(),d.ListValue);if(null===k||null===A||null===x)throw new C.StoryException("Expected list, minimum and maximum for LIST_RANGE");if(null===k.value)return N.throwNullException("targetList.value");let V=k.value.ListWithSubRange(A.valueObject,x.valueObject);this.state.PushEvaluationStack(new d.ListValue(V));break;case o.ControlCommand.CommandType.ListRandom:{let t=this.state.PopEvaluationStack();if(null===t)throw new C.StoryException("Expected list for LIST_RANDOM");let e=t.value,n=null;if(null===e)throw N.throwNullException("list");if(0==e.Count)n=new O.InkList;else{let t=this.state.storySeed+this.state.previousRandom,i=new v.PRNG(t).next(),r=i%e.Count,s=e.entries();for(let t=0;t<=r-1;t++)s.next();let a=s.next().value,o={Key:O.InkListItem.fromSerializedKey(a[0]),Value:a[1]};if(null===o.Key.originName)return N.throwNullException("randomItem.Key.originName");n=new O.InkList(o.Key.originName,this),n.Add(o.Key,o.Value),this.state.previousRandom=i}this.state.PushEvaluationStack(new d.ListValue(n));break}default:this.Error("unhandled ControlCommand: "+e)}return!0}if(t instanceof g.VariableAssignment){let e=t,n=this.state.PopEvaluationStack();return this.state.variablesState.Assign(e,n),!0}if(t instanceof y.VariableReference){let e=t,n=null;if(null!=e.pathForCount){let t=e.containerForCount,i=this.state.VisitCountForContainer(t);n=new d.IntValue(i)}else n=this.state.variablesState.GetVariableWithName(e.name),null==n&&(this.Warning("Variable not found: '"+e.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),n=new d.IntValue(0));return this.state.PushEvaluationStack(n),!0}if(t instanceof S.NativeFunctionCall){let e=t,n=this.state.PopEvaluationStack(e.numberOfParameters),i=e.Call(n);return this.state.PushEvaluationStack(i),!0}return!1}ChoosePathString(t,e=!0,n=[]){if(this.IfAsyncWeCant("call ChoosePathString right now"),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==l.PushPopType.Function){let e="",n=this.state.callStack.currentElement.currentPointer.container;throw null!=n&&(e="("+n.path.toString()+") "),new Error("Story was running a function "+e+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new p.Path(t))}IfAsyncWeCant(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(t,e=!0){this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(t){t=t;let e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");let n=e[t];return null===n.threadAtGeneration?N.throwNullException("choiceToChoose.threadAtGeneration"):null===n.targetPath?N.throwNullException("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}HasFunction(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}EvaluateFunction(t,e=[],n=!1){if(this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");let i=this.KnotContainerWithName(t);if(null==i)throw new Error("Function doesn't exist: '"+t+"'");let r=[];r.push.apply(r,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);let s=new b.StringBuilder;for(;this.canContinue;)s.Append(this.Continue());let a=s.toString();this._state.ResetOutput(r);let o=this.state.CompleteFunctionEvaluationFromGame();return n?{returned:o,output:a}:o}EvaluateExpression(t){let e=this.state.callStack.elements.length;this.state.callStack.Push(l.PushPopType.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();let n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}CallExternalFunction(t,e){if(null===t)return N.throwNullException("funcName");let n=this._externals.get(t),i=null;if(!(void 0!==n)){if(this.allowExternalFunctionFallbacks)return i=this.KnotContainerWithName(t),this.Assert(null!==i,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(l.PushPopType.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=P.Pointer.StartOf(i));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}let r=[];for(let t=0;t<e;++t){let t=T.asOrThrows(this.state.PopEvaluationStack(),d.Value).valueObject;r.push(t)}r.reverse();let s=n(r),a=null;null!=s?(a=d.Value.Create(s),this.Assert(null!==a,"Could not create ink value from returned object of type "+typeof s)):a=new f.Void,this.state.PushEvaluationStack(a)}BindExternalFunctionGeneral(t,e){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,e)}TryCoerce(t){return t}BindExternalFunction(t,e){this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,t=>{this.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");let n=[];for(let e=0,i=t.length;e<i;e++)n[e]=this.TryCoerce(t[e]);return e.apply(null,n)})}UnbindExternalFunction(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}ValidateExternalBindings(){let t=null,e=null,n=arguments[1]||new Set;if(arguments[0]instanceof i.Container&&(t=arguments[0]),arguments[0]instanceof r.InkObject&&(e=arguments[0]),null===t&&null===e)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,0==n.size)this._hasValidatedExternals=!0;else{let t="Error: Missing function binding for external";t+=n.size>1?"s":"",t+=": '",t+=Array.from(n).join("', '"),t+="' ",t+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(t)}else if(null!=t){for(let e of t.content){let t=e;null!=t&&t.hasValidName||this.ValidateExternalBindings(e,n)}for(let[,e]of t.namedContent)this.ValidateExternalBindings(T.asOrNull(e,r.InkObject),n)}else if(null!=e){let t=T.asOrNull(e,c.Divert);if(t&&t.isExternal){let e=t.targetPathString;if(null===e)return N.throwNullException("name");if(!this._externals.has(e))if(this.allowExternalFunctionFallbacks){this.mainContentContainer.namedContent.has(e)||n.add(e)}else n.add(e)}}}ObserveVariable(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new C.StoryException("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}ObserveVariables(t,e){for(let n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}RemoveVariableObserver(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(void 0!==e){if(this._variableObservers.has(e)){let n=this._variableObservers.get(e);null!==t?n.splice(n.indexOf(t),1):this._variableObservers.delete(e)}}else if(null!==t){let e=this._variableObservers.keys();for(let n of e){let e=this._variableObservers.get(n);e.splice(e.indexOf(t),1)}}}VariableStateDidChangeEvent(t,e){if(null===this._variableObservers)return;let n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof d.Value))throw new Error("Tried to get the value of a variable that isn't a standard type");let i=T.asOrThrows(e,d.Value);for(let e of n)e(t,i.valueObject)}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}TagsAtStartOfFlowContainerWithPathString(t){let e=new p.Path(t),n=this.ContentAtPath(e).container;if(null===n)return N.throwNullException("flowContainer");for(;;){let t=n.content[0];if(!(t instanceof i.Container))break;n=t}let r=null;for(let t of n.content){let e=T.asOrNull(t,m.Tag);if(!e)break;null==r&&(r=[]),r.push(e.text)}return r}BuildStringOfHierarchy(){let t=new b.StringBuilder;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}BuildStringOfContainer(t){let e=new b.StringBuilder;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),!this.state.divertedPointer.isNull&&(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=P.Pointer.Null,this.VisitChangedContainersDueToDivert(),!this.state.currentPointer.isNull))return;if(!this.IncrementContentPointer()){let t=!1;this.state.callStack.CanPop(l.PushPopType.Function)?(this.state.PopCallStack(l.PushPopType.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new f.Void),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return N.throwNullException("pointer.container");for(;e.index>=e.container.content.length;){t=!1;let n=T.asOrNull(e.container.parent,i.Container);if(n instanceof i.Container==!1)break;let r=n.content.indexOf(e.container);if(-1==r)break;if(e=new P.Pointer(n,r),e.index++,t=!0,null===e.container)return N.throwNullException("pointer.container")}return t||(e=P.Pointer.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){let t=this._state.currentChoices,e=t.filter(t=>t.isInvisibleDefault);if(0==e.length||t.length>e.length)return!1;let n=e[0];return null===n.targetPath?N.throwNullException("choice.targetPath"):null===n.threadAtGeneration?N.throwNullException("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.targetPath,!1),!0)}NextSequenceShuffleIndex(){let t=T.asOrNull(this.state.PopEvaluationStack(),d.IntValue);if(!(t instanceof d.IntValue))return this.Error("expected number of elements in sequence for shuffle index"),0;let e=this.state.currentPointer.container;if(null===e)return N.throwNullException("seqContainer");if(null===t.value)return N.throwNullException("numElementsIntVal.value");let n=t.value,i=T.asOrThrows(this.state.PopEvaluationStack(),d.IntValue).value;if(null===i)return N.throwNullException("seqCount");let r=i/n,s=i%n,a=e.path.toString(),o=0;for(let t=0,e=a.length;t<e;t++)o+=a.charCodeAt(t)||0;let l=o+r+this.state.storySeed,u=new v.PRNG(Math.floor(l)),h=[];for(let t=0;t<n;++t)h.push(t);for(let t=0;t<=s;++t){let e=u.next()%h.length,n=h[e];if(h.splice(e,1),t==s)return n}throw new Error("Should never reach here")}Error(t,e=!1){let n=new C.StoryException(t);throw n.useEndLineNumber=e,n}Warning(t){this.AddError(t,!0)}AddError(t,e=!1,n=!1){let i=this.currentDebugMetadata,r=e?"WARNING":"ERROR";if(null!=i){let e=n?i.endLineNumber:i.startLineNumber;t="RUNTIME "+r+": '"+i.fileName+"' line "+e+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}Assert(t,e=null){if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let n=this.state.callStack.elements.length-1;n>=0;--n)if(e=this.state.callStack.elements[n].currentPointer,!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let e=this.state.outputStream.length-1;e>=0;--e){if(t=this.state.outputStream[e].debugMetadata,null!==t)return t}return null}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}e.Story=x,x.inkVersionCurrent=19,function(t){let e;!function(t){t[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"}(e=t.OutputStateChange||(t.OutputStateChange={}))}(x=e.Story||(e.Story={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ControlCommand=void 0;const i=n(3);class r extends i.InkObject{constructor(t=r.CommandType.NotSet){super(),this._commandType=t}get commandType(){return this._commandType}Copy(){return new r(this.commandType)}static EvalStart(){return new r(r.CommandType.EvalStart)}static EvalOutput(){return new r(r.CommandType.EvalOutput)}static EvalEnd(){return new r(r.CommandType.EvalEnd)}static Duplicate(){return new r(r.CommandType.Duplicate)}static PopEvaluatedValue(){return new r(r.CommandType.PopEvaluatedValue)}static PopFunction(){return new r(r.CommandType.PopFunction)}static PopTunnel(){return new r(r.CommandType.PopTunnel)}static BeginString(){return new r(r.CommandType.BeginString)}static EndString(){return new r(r.CommandType.EndString)}static NoOp(){return new r(r.CommandType.NoOp)}static ChoiceCount(){return new r(r.CommandType.ChoiceCount)}static Turns(){return new r(r.CommandType.Turns)}static TurnsSince(){return new r(r.CommandType.TurnsSince)}static ReadCount(){return new r(r.CommandType.ReadCount)}static Random(){return new r(r.CommandType.Random)}static SeedRandom(){return new r(r.CommandType.SeedRandom)}static VisitIndex(){return new r(r.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new r(r.CommandType.SequenceShuffleIndex)}static StartThread(){return new r(r.CommandType.StartThread)}static Done(){return new r(r.CommandType.Done)}static End(){return new r(r.CommandType.End)}static ListFromInt(){return new r(r.CommandType.ListFromInt)}static ListRange(){return new r(r.CommandType.ListRange)}static ListRandom(){return new r(r.CommandType.ListRandom)}toString(){return this.commandType.toString()}}e.ControlCommand=r,function(t){let e;!function(t){t[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.Random=13]="Random",t[t.SeedRandom=14]="SeedRandom",t[t.VisitIndex=15]="VisitIndex",t[t.SequenceShuffleIndex=16]="SequenceShuffleIndex",t[t.StartThread=17]="StartThread",t[t.Done=18]="Done",t[t.End=19]="End",t[t.ListFromInt=20]="ListFromInt",t[t.ListRange=21]="ListRange",t[t.ListRandom=22]="ListRandom",t[t.ReadCount=23]="ReadCount",t[t.TOTAL_VALUES=24]="TOTAL_VALUES"}(e=t.CommandType||(t.CommandType={}))}(r=e.ControlCommand||(e.ControlCommand={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Tag=void 0;const i=n(3);class r extends i.InkObject{constructor(t){super(),this.text=t.toString()||""}toString(){return"# "+this.text}}e.Tag=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Glue=void 0;const i=n(3);class r extends i.InkObject{toString(){return"Glue"}}e.Glue=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Divert=void 0;const i=n(4),r=n(14),s=n(10),a=n(3),o=n(17),l=n(12),u=n(2);class h extends a.InkObject{constructor(t){super(),this._targetPath=null,this._targetPointer=o.Pointer.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,void 0!==t&&(this.pushesToStack=!0,this.stackPushType=t)}get targetPath(){if(null!=this._targetPath&&this._targetPath.isRelative){let t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath}set targetPath(t){this._targetPath=t,this._targetPointer=o.Pointer.Null}get targetPointer(){if(this._targetPointer.isNull){let t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return u.throwNullException("this._targetPath");if(null===this._targetPath.lastComponent)return u.throwNullException("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return u.throwNullException("targetObj");this._targetPointer.container=t.parent instanceof l.Container?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=o.Pointer.StartOf(t instanceof l.Container?t:null)}return this._targetPointer.copy()}get targetPathString(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)}set targetPathString(t){this.targetPath=null==t?null:new i.Path(t)}get hasVariableTarget(){return null!=this.variableDivertName}Equals(t){let e=t;return e instanceof h&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:null===this.targetPath?u.throwNullException("this.targetPath"):this.targetPath.Equals(e.targetPath))}toString(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";{let t=new s.StringBuilder,e=this.targetPath.toString(),n=null;return null!=n&&(e="line "+n),t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==r.PushPopType.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}}e.Divert=h},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ChoicePoint=void 0;const i=n(3),r=n(4),s=n(2);class a extends i.InkObject{constructor(t=!0){super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=t}get pathOnChoice(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){let t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice}set pathOnChoice(t){this._pathOnChoice=t}get choiceTarget(){return null===this._pathOnChoice?s.throwNullException("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return null===this.pathOnChoice?s.throwNullException("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(t){this.pathOnChoice=new r.Path(t)}get flags(){let t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t}set flags(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}toString(){if(null===this.pathOnChoice)return s.throwNullException("ChoicePoint.pathOnChoice");let t=this.pathOnChoice.toString();return"Choice: -> "+t}}e.ChoicePoint=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.VariableReference=void 0;const i=n(3),r=n(4);class s extends i.InkObject{constructor(t=null){super(),this.pathForCount=null,this.name=t}get containerForCount(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(t){this.pathForCount=null===t?null:new r.Path(t)}toString(){if(null!=this.name)return"var("+this.name+")";return"read_count("+this.pathStringForCount+")"}}e.VariableReference=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.VariableAssignment=void 0;const i=n(3);class r extends i.InkObject{constructor(t,e){super(),this.variableName=t||null,this.isNewDeclaration=!!e,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}}e.VariableAssignment=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.NativeFunctionCall=void 0;const i=n(6),r=n(11),s=n(18),a=n(8),o=n(3),l=n(7),u=n(2);class h extends o.InkObject{constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,0===arguments.length)h.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){let t=arguments[0];h.GenerateNativeFunctionsIfNecessary(),this.name=t}else if(2===arguments.length){let t=arguments[0],e=arguments[1];this._isPrototype=!0,this.name=t,this.numberOfParameters=e}}static CallWithName(t){return new h(t)}static CallExistsWithName(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}get name(){return null===this._name?u.throwNullException("NativeFunctionCall._name"):this._name}set name(t){this._name=t,this._isPrototype||(null===h._nativeFunctions?u.throwNullException("NativeFunctionCall._nativeFunctions"):this._prototype=h._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(t){this._numberOfParameters=t}Call(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");let e=!1;for(let n of t){if(n instanceof s.Void)throw new r.StoryException('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');n instanceof i.ListValue&&(e=!0)}if(2==t.length&&e)return this.CallBinaryListOperation(t);let n=this.CoerceValuesToSingleType(t),a=n[0].valueType;return a==i.ValueType.Int||a==i.ValueType.Float||a==i.ValueType.String||a==i.ValueType.DivertTarget||a==i.ValueType.List?this.CallType(n):null}CallType(t){let e=l.asOrThrows(t[0],i.Value),n=e.valueType,s=e,a=t.length;if(2==a||1==a){if(null===this._operationFuncs)return u.throwNullException("NativeFunctionCall._operationFuncs");let o=this._operationFuncs.get(n);if(!o){const t=i.ValueType[n];throw new r.StoryException("Cannot perform operation "+this.name+" on "+t)}if(2==a){let e=l.asOrThrows(t[1],i.Value),n=o;if(null===s.value||null===e.value)return u.throwNullException("NativeFunctionCall.Call BinaryOp values");let r=n(s.value,e.value);return i.Value.Create(r)}{let t=o;if(null===s.value)return u.throwNullException("NativeFunctionCall.Call UnaryOp value");let n=t(s.value);return this.name===h.Int?i.Value.Create(n,i.ValueType.Int):this.name===h.Float?i.Value.Create(n,i.ValueType.Float):i.Value.Create(n,e.valueType)}}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}CallBinaryListOperation(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof i.ListValue&&t[1]instanceof i.IntValue)return this.CallListIncrementOperation(t);let e=l.asOrThrows(t[0],i.Value),n=l.asOrThrows(t[1],i.Value);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==i.ValueType.List&&n.valueType==i.ValueType.List)){if(null===this._operationFuncs)return u.throwNullException("NativeFunctionCall._operationFuncs");let t=this._operationFuncs.get(i.ValueType.Int);if(null===t)return u.throwNullException("NativeFunctionCall.CallBinaryListOperation op");let r=t(e.isTruthy?1:0,n.isTruthy?1:0);return new i.IntValue(r)}if(e.valueType==i.ValueType.List&&n.valueType==i.ValueType.List)return this.CallType([e,n]);throw new r.StoryException("Can not call use "+this.name+" operation on "+i.ValueType[e.valueType]+" and "+i.ValueType[n.valueType])}CallListIncrementOperation(t){let e=l.asOrThrows(t[0],i.ListValue),n=l.asOrThrows(t[1],i.IntValue),r=new a.InkList;if(null===e.value)return u.throwNullException("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[t,s]of e.value){let o=a.InkListItem.fromSerializedKey(t);if(null===this._operationFuncs)return u.throwNullException("NativeFunctionCall._operationFuncs");let l=this._operationFuncs.get(i.ValueType.Int);if(null===n.value)return u.throwNullException("NativeFunctionCall.CallListIncrementOperation intVal.value");let h=l(s,n.value),c=null;if(null===e.value.origins)return u.throwNullException("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let t of e.value.origins)if(t.name==o.originName){c=t;break}if(null!=c){let t=c.TryGetItemWithValue(h,a.InkListItem.Null);t.exists&&r.Add(t.result,h)}}return new i.ListValue(r)}CoerceValuesToSingleType(t){let e=i.ValueType.Int,n=null;for(let r of t){let t=l.asOrThrows(r,i.Value);t.valueType>e&&(e=t.valueType),t.valueType==i.ValueType.List&&(n=l.asOrNull(t,i.ListValue))}let s=[];if(i.ValueType[e]==i.ValueType[i.ValueType.List])for(let e of t){let t=l.asOrThrows(e,i.Value);if(t.valueType==i.ValueType.List)s.push(t);else{if(t.valueType!=i.ValueType.Int){const e=i.ValueType[t.valueType];throw new r.StoryException("Cannot mix Lists and "+e+" values in this operation")}{let e=parseInt(t.valueObject);if(n=l.asOrThrows(n,i.ListValue),null===n.value)return u.throwNullException("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");let o=n.value.originOfMaxItem;if(null===o)return u.throwNullException("NativeFunctionCall.CoerceValuesToSingleType list");let h=o.TryGetItemWithValue(e,a.InkListItem.Null);if(!h.exists)throw new r.StoryException("Could not find List item with the value "+e+" in "+o.name);{let t=new i.ListValue(h.result,e);s.push(t)}}}}else for(let n of t){let t=l.asOrThrows(n,i.Value).Cast(e);s.push(t)}return s}static Identity(t){return t}static GenerateNativeFunctionsIfNecessary(){if(null==this._nativeFunctions){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(t,e)=>t+e),this.AddIntBinaryOp(this.Subtract,(t,e)=>t-e),this.AddIntBinaryOp(this.Multiply,(t,e)=>t*e),this.AddIntBinaryOp(this.Divide,(t,e)=>Math.floor(t/e)),this.AddIntBinaryOp(this.Mod,(t,e)=>t%e),this.AddIntUnaryOp(this.Negate,t=>-t),this.AddIntBinaryOp(this.Equal,(t,e)=>t==e?1:0),this.AddIntBinaryOp(this.Greater,(t,e)=>t>e?1:0),this.AddIntBinaryOp(this.Less,(t,e)=>t<e?1:0),this.AddIntBinaryOp(this.GreaterThanOrEquals,(t,e)=>t>=e?1:0),this.AddIntBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e?1:0),this.AddIntBinaryOp(this.NotEquals,(t,e)=>t!=e?1:0),this.AddIntUnaryOp(this.Not,t=>0==t?1:0),this.AddIntBinaryOp(this.And,(t,e)=>0!=t&&0!=e?1:0),this.AddIntBinaryOp(this.Or,(t,e)=>0!=t||0!=e?1:0),this.AddIntBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddIntBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddIntBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddIntUnaryOp(this.Floor,h.Identity),this.AddIntUnaryOp(this.Ceiling,h.Identity),this.AddIntUnaryOp(this.Int,h.Identity),this.AddIntUnaryOp(this.Float,t=>t),this.AddFloatBinaryOp(this.Add,(t,e)=>t+e),this.AddFloatBinaryOp(this.Subtract,(t,e)=>t-e),this.AddFloatBinaryOp(this.Multiply,(t,e)=>t*e),this.AddFloatBinaryOp(this.Divide,(t,e)=>t/e),this.AddFloatBinaryOp(this.Mod,(t,e)=>t%e),this.AddFloatUnaryOp(this.Negate,t=>-t),this.AddFloatBinaryOp(this.Equal,(t,e)=>t==e?1:0),this.AddFloatBinaryOp(this.Greater,(t,e)=>t>e?1:0),this.AddFloatBinaryOp(this.Less,(t,e)=>t<e?1:0),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(t,e)=>t>=e?1:0),this.AddFloatBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e?1:0),this.AddFloatBinaryOp(this.NotEquals,(t,e)=>t!=e?1:0),this.AddFloatUnaryOp(this.Not,t=>0==t?1:0),this.AddFloatBinaryOp(this.And,(t,e)=>0!=t&&0!=e?1:0),this.AddFloatBinaryOp(this.Or,(t,e)=>0!=t||0!=e?1:0),this.AddFloatBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddFloatBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddFloatBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddFloatUnaryOp(this.Floor,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Ceiling,t=>Math.ceil(t)),this.AddFloatUnaryOp(this.Int,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Float,h.Identity),this.AddStringBinaryOp(this.Add,(t,e)=>t+e),this.AddStringBinaryOp(this.Equal,(t,e)=>t===e?1:0),this.AddStringBinaryOp(this.NotEquals,(t,e)=>t!==e?1:0),this.AddStringBinaryOp(this.Has,(t,e)=>t.includes(e)?1:0),this.AddStringBinaryOp(this.Hasnt,(t,e)=>t.includes(e)?0:1),this.AddListBinaryOp(this.Add,(t,e)=>t.Union(e)),this.AddListBinaryOp(this.Subtract,(t,e)=>t.Without(e)),this.AddListBinaryOp(this.Has,(t,e)=>t.Contains(e)?1:0),this.AddListBinaryOp(this.Hasnt,(t,e)=>t.Contains(e)?0:1),this.AddListBinaryOp(this.Intersect,(t,e)=>t.Intersect(e)),this.AddListBinaryOp(this.Equal,(t,e)=>t.Equals(e)?1:0),this.AddListBinaryOp(this.Greater,(t,e)=>t.GreaterThan(e)?1:0),this.AddListBinaryOp(this.Less,(t,e)=>t.LessThan(e)?1:0),this.AddListBinaryOp(this.GreaterThanOrEquals,(t,e)=>t.GreaterThanOrEquals(e)?1:0),this.AddListBinaryOp(this.LessThanOrEquals,(t,e)=>t.LessThanOrEquals(e)?1:0),this.AddListBinaryOp(this.NotEquals,(t,e)=>t.Equals(e)?0:1),this.AddListBinaryOp(this.And,(t,e)=>t.Count>0&&e.Count>0?1:0),this.AddListBinaryOp(this.Or,(t,e)=>t.Count>0||e.Count>0?1:0),this.AddListUnaryOp(this.Not,t=>0==t.Count?1:0),this.AddListUnaryOp(this.Invert,t=>t.inverse),this.AddListUnaryOp(this.All,t=>t.all),this.AddListUnaryOp(this.ListMin,t=>t.MinAsList()),this.AddListUnaryOp(this.ListMax,t=>t.MaxAsList()),this.AddListUnaryOp(this.Count,t=>t.Count),this.AddListUnaryOp(this.ValueOfList,t=>t.maxItem.Value);let t=(t,e)=>t.Equals(e)?1:0,e=(t,e)=>t.Equals(e)?0:1;this.AddOpToNativeFunc(this.Equal,2,i.ValueType.DivertTarget,t),this.AddOpToNativeFunc(this.NotEquals,2,i.ValueType.DivertTarget,e)}}AddOpFuncForType(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}static AddOpToNativeFunc(t,e,n,i){if(null===this._nativeFunctions)return u.throwNullException("NativeFunctionCall._nativeFunctions");let r=this._nativeFunctions.get(t);r||(r=new h(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(n,i)}static AddIntBinaryOp(t,e){this.AddOpToNativeFunc(t,2,i.ValueType.Int,e)}static AddIntUnaryOp(t,e){this.AddOpToNativeFunc(t,1,i.ValueType.Int,e)}static AddFloatBinaryOp(t,e){this.AddOpToNativeFunc(t,2,i.ValueType.Float,e)}static AddFloatUnaryOp(t,e){this.AddOpToNativeFunc(t,1,i.ValueType.Float,e)}static AddStringBinaryOp(t,e){this.AddOpToNativeFunc(t,2,i.ValueType.String,e)}static AddListBinaryOp(t,e){this.AddOpToNativeFunc(t,2,i.ValueType.List,e)}static AddListUnaryOp(t,e){this.AddOpToNativeFunc(t,1,i.ValueType.List,e)}toString(){return'Native "'+this.name+'"'}}e.NativeFunctionCall=h,h.Add="+",h.Subtract="-",h.Divide="/",h.Multiply="*",h.Mod="%",h.Negate="_",h.Equal="==",h.Greater=">",h.Less="<",h.GreaterThanOrEquals=">=",h.LessThanOrEquals="<=",h.NotEquals="!=",h.Not="!",h.And="&&",h.Or="||",h.Min="MIN",h.Max="MAX",h.Pow="POW",h.Floor="FLOOR",h.Ceiling="CEILING",h.Int="INT",h.Float="FLOAT",h.Has="?",h.Hasnt="!?",h.Intersect="^",h.ListMin="LIST_MIN",h.ListMax="LIST_MAX",h.All="LIST_ALL",h.Count="LIST_COUNT",h.ValueOfList="LIST_VALUE",h.Invert="LIST_INVERT",h._nativeFunctions=null},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Choice=void 0;const i=n(4),r=n(2),s=n(3);class a extends s.InkObject{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.originalThreadIndex=0}get pathStringOnChoice(){return null===this.targetPath?r.throwNullException("Choice.targetPath"):this.targetPath.toString()}set pathStringOnChoice(t){this.targetPath=new i.Path(t)}}e.Choice=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ListDefinitionsOrigin=void 0;const i=n(8),r=n(6),s=n(2);e.ListDefinitionsOrigin=class{constructor(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(let e of t){this._lists.set(e.name,e);for(let[t,n]of e.items){let e=i.InkListItem.fromSerializedKey(t),s=new r.ListValue(e,n);if(!e.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(e.itemName,s),this._allUnambiguousListValueCache.set(e.fullName,s)}}}get lists(){let t=[];for(let[,e]of this._lists)t.push(e);return t}TryListGetDefinition(t,e){if(null===t)return{result:e,exists:!1};let n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}FindSingleItemListWithName(t){if(null===t)return s.throwNullException("name");let e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PRNG=void 0;e.PRNG=class{constructor(t){this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=16807*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SimpleJson=void 0;class i{static TextToDictionary(t){return new i.Reader(t).ToDictionary()}static TextToArray(t){return new i.Reader(t).ToArray()}}e.SimpleJson=i,function(t){t.Reader=class{constructor(t){this._rootObject=JSON.parse(t)}ToDictionary(){return this._rootObject}ToArray(){return this._rootObject}};class e{constructor(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}WriteObject(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}WriteObjectStart(){this.StartNewObject(!0);let e={};if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Object))}WriteObjectEnd(){this.Assert(this.state===t.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}WriteProperty(t,e){if(this.WritePropertyStart(t),arguments[1]instanceof Function){(0,arguments[1])(this)}else{let t=arguments[1];this.Write(t)}this.WritePropertyEnd()}WriteIntProperty(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}WriteFloatProperty(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}WritePropertyStart(e){this.Assert(this.state===t.Writer.State.Object),this._propertyNameStack.push(e),this.IncrementChildCount(),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property))}WritePropertyEnd(){this.Assert(this.state===t.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}WritePropertyNameStart(){this.Assert(this.state===t.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property)),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.PropertyName))}WritePropertyNameEnd(){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}WritePropertyNameInner(e){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=e}WriteArrayStart(){this.StartNewObject(!0);let e=[];if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Array))}WriteArrayEnd(){this.Assert(this.state===t.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}Write(t,e=!0){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null string")}WriteInt(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}WriteFloat(t){null!==t&&(this.StartNewObject(!1),t==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):t==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(t)?this._addToCurrentObject(0):this._addToCurrentObject(t))}WriteNull(){this.StartNewObject(!1),this._addToCurrentObject(null)}WriteStringStart(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.String))}WriteStringEnd(){this.Assert(this.state==t.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}WriteStringInner(e,n=!0){this.Assert(this.state===t.Writer.State.String),null!==e?this._currentString+=e:console.error("Warning: trying to write a null string")}ToString(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}StartNewObject(e){e?this.Assert(this.state===t.Writer.State.None||this.state===t.Writer.State.Property||this.state===t.Writer.State.Array):this.Assert(this.state===t.Writer.State.Property||this.state===t.Writer.State.Array),this.state===t.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==t.Writer.State.Array&&this.state!==t.Writer.State.Property||this.IncrementChildCount()}get state(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:t.Writer.State.None}get childCount(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}get currentCollection(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}get currentPropertyName(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}IncrementChildCount(){this.Assert(this._stateStack.length>0);let t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}Assert(t){if(!t)throw Error("Assert failed while writing JSON")}_addToCurrentObject(e){this.Assert(null!==this.currentCollection),this.state===t.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(e)):this.state===t.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=e,this._propertyNameStack.pop())}}t.Writer=e,function(e){let n;!function(t){t[t.None=0]="None",t[t.Object=1]="Object",t[t.Array=2]="Array",t[t.Property=3]="Property",t[t.PropertyName=4]="PropertyName",t[t.String=5]="String"}(n=e.State||(e.State={}));e.StateElement=class{constructor(e){this.type=t.Writer.State.None,this.childCount=0,this.type=e}}}(e=t.Writer||(t.Writer={}))}(i=e.SimpleJson||(e.SimpleJson={}))},function(t,e,n){"use strict";t.exports=c;var i,r=n(9),s=r.LongBits,a=r.base64,o=r.utf8;function l(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}function u(){}function h(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function c(){this.len=0,this.head=new l(u,0,0),this.tail=this.head,this.states=null}var d=function(){return r.Buffer?function(){return(c.create=function(){return new i})()}:function(){return new c}};function p(t,e,n){e[n]=255&t}function f(t,e){this.len=t,this.next=void 0,this.val=e}function m(t,e,n){for(;t.hi;)e[n++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[n++]=127&t.lo|128,t.lo=t.lo>>>7;e[n++]=t.lo}function g(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}c.create=d(),c.alloc=function(t){return new r.Array(t)},r.Array!==Array&&(c.alloc=r.pool(c.alloc,r.Array.prototype.subarray)),c.prototype._push=function(t,e,n){return this.tail=this.tail.next=new l(t,e,n),this.len+=e,this},f.prototype=Object.create(l.prototype),f.prototype.fn=function(t,e,n){for(;t>127;)e[n++]=127&t|128,t>>>=7;e[n]=t},c.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new f((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},c.prototype.int32=function(t){return t<0?this._push(m,10,s.fromNumber(t)):this.uint32(t)},c.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},c.prototype.uint64=function(t){var e=s.from(t);return this._push(m,e.length(),e)},c.prototype.int64=c.prototype.uint64,c.prototype.sint64=function(t){var e=s.from(t).zzEncode();return this._push(m,e.length(),e)},c.prototype.bool=function(t){return this._push(p,1,t?1:0)},c.prototype.fixed32=function(t){return this._push(g,4,t>>>0)},c.prototype.sfixed32=c.prototype.fixed32,c.prototype.fixed64=function(t){var e=s.from(t);return this._push(g,4,e.lo)._push(g,4,e.hi)},c.prototype.sfixed64=c.prototype.fixed64,c.prototype.float=function(t){return this._push(r.float.writeFloatLE,4,t)},c.prototype.double=function(t){return this._push(r.float.writeDoubleLE,8,t)};var y=r.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var i=0;i<t.length;++i)e[n+i]=t[i]};c.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(p,1,0);if(r.isString(t)){var n=c.alloc(e=a.length(t));a.decode(t,n,0),t=n}return this.uint32(e)._push(y,e,t)},c.prototype.string=function(t){var e=o.length(t);return e?this.uint32(e)._push(o.write,e,t):this._push(p,1,0)},c.prototype.fork=function(){return this.states=new h(this),this.head=this.tail=new l(u,0,0),this.len=0,this},c.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new l(u,0,0),this.len=0),this},c.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this},c.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e},c._configure=function(t){i=t,c.create=d(),i._configure()}},function(t,e,n){"use strict";t.exports=l;var i,r=n(9),s=r.LongBits,a=r.utf8;function o(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function l(t){this.buf=t,this.pos=0,this.len=t.length}var u,h="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new l(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new l(t);throw Error("illegal buffer")},c=function(){return r.Buffer?function(t){return(l.create=function(t){return r.Buffer.isBuffer(t)?new i(t):h(t)})(t)}:h};function d(){var t=new s(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw o(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw o(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function p(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw o(this,8);return new s(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}l.create=c(),l.prototype._slice=r.Array.prototype.subarray||r.Array.prototype.slice,l.prototype.uint32=(u=4294967295,function(){if(u=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return u;if(u=(u|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return u;if(u=(u|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return u;if(u=(u|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return u;if(u=(u|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return u;if((this.pos+=5)>this.len)throw this.pos=this.len,o(this,10);return u}),l.prototype.int32=function(){return 0|this.uint32()},l.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},l.prototype.bool=function(){return 0!==this.uint32()},l.prototype.fixed32=function(){if(this.pos+4>this.len)throw o(this,4);return p(this.buf,this.pos+=4)},l.prototype.sfixed32=function(){if(this.pos+4>this.len)throw o(this,4);return 0|p(this.buf,this.pos+=4)},l.prototype.float=function(){if(this.pos+4>this.len)throw o(this,4);var t=r.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},l.prototype.double=function(){if(this.pos+8>this.len)throw o(this,4);var t=r.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},l.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw o(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)},l.prototype.string=function(){var t=this.bytes();return a.read(t,0,t.length)},l.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw o(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw o(this)}while(128&this.buf[this.pos++]);return this},l.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},l._configure=function(t){i=t,l.create=c(),i._configure();var e=r.Long?"toLong":"toNumber";r.merge(l.prototype,{int64:function(){return d.call(this)[e](!1)},uint64:function(){return d.call(this)[e](!0)},sint64:function(){return d.call(this).zzDecode()[e](!1)},fixed64:function(){return f.call(this)[e](!0)},sfixed64:function(){return f.call(this)[e](!1)}})}},function(t,e,n){!function(t){"use strict";class e{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){let t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof e.Component&&arguments[1]instanceof e){let t=arguments[0],e=arguments[1];this._components.push(t),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){let t=arguments[0],e=!!arguments[1];this._components=this._components.concat(t),this._isRelative=e}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return this._components.length>0?this._components[0]:null}get tail(){if(this._components.length>=2){let t=this._components.slice(1,this._components.length);return new e(t)}return e.self}get length(){return this._components.length}get lastComponent(){let t=this._components.length-1;return t>=0?this._components[t]:null}get containsNamedComponent(){for(let t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}static get self(){let t=new e;return t._isRelative=!0,t}GetComponent(t){return this._components[t]}PathByAppendingPath(t){let n=new e,i=0;for(let e=0;e<t._components.length&&t._components[e].isParent;++e)i++;for(let t=0;t<this._components.length-i;++t)n._components.push(this._components[t]);for(let e=i;e<t._components.length;++e)n._components.push(t._components[e]);return n}get componentsString(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString}set componentsString(t){if(this._components.length=0,this._componentsString=t,null==this._componentsString||""==this._componentsString)return;"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));let n=this._componentsString.split(".");for(let t of n)/^(\-|\+)?([0-9]+|Infinity)$/.test(t)?this._components.push(new e.Component(parseInt(t))):this._components.push(new e.Component(t))}toString(){return this.componentsString}Equals(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(let e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}PathByAppendingComponent(t){let n=new e;return n._components.push.apply(n._components,this._components),n._components.push(t),n}}var n,i,r;function s(t,e){return t instanceof e?h(t):null}function a(t,e){if(t instanceof e)return h(t);throw new Error(`${t} is not of type ${e}`)}function o(t){return t.hasValidName&&t.name?t:null}function l(t){return void 0===t?null:t}function u(t){return"object"==typeof t&&"function"==typeof t.Equals}function h(t,e){return t}e.parentId="^",function(t){class e{constructor(t){this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}get isIndex(){return this.index>=0}get isParent(){return this.name==t.parentId}static ToParent(){return new e(t.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}t.Component=e}(e||(e={})),function(t){function e(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),new Error("")}t.AssertType=function(t,n,i){e(t instanceof n,i)},t.Assert=e}(n||(n={}));class c extends Error{}function d(t){throw new c(t+" is null or undefined")}class p{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(t){if(null===t)return null;let e=this.rootContentContainer;if(e){let n=e.ContentAtPath(t).obj;if(n){let t=n.debugMetadata;if(null!==t)return t.startLineNumber}}return null}get path(){if(null==this._path)if(null==this.parent)this._path=new e;else{let t=[],n=this,i=s(n.parent,E);for(;null!==i;){let r=o(n);null!=r&&r.hasValidName?t.unshift(new e.Component(r.name)):t.unshift(new e.Component(i.content.indexOf(n))),n=i,i=s(i.parent,E)}this._path=new e(t)}return this._path}ResolvePath(t){if(null===t)return d("path");if(t.isRelative){let e=s(this,E);return null===e&&(n.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),e=s(this.parent,E),n.Assert(null!==e,"Expected parent to be a container"),n.Assert(t.GetComponent(0).isParent),t=t.tail),null===e?d("nearestContainer"):e.ContentAtPath(t)}{let e=this.rootContentContainer;return null===e?d("contentContainer"):e.ContentAtPath(t)}}ConvertPathToRelative(t){let n=this.path,i=Math.min(t.length,n.length),r=-1;for(let e=0;e<i;++e){let i=n.GetComponent(e),s=t.GetComponent(e);if(!i.Equals(s))break;r=e}if(-1==r)return t;let s=n.componentCount-1-r,a=[];for(let t=0;t<s;++t)a.push(e.Component.ToParent());for(let e=r+1;e<t.componentCount;++e)a.push(t.GetComponent(e));return new e(a,!0)}CompactPathString(t){let e=null,n=null;return t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),n.length<e.length?n:e}get rootContentContainer(){let t=this;for(;t.parent;)t=t.parent;return s(t,E)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}}class f{constructor(t){t=void 0!==t?t.toString():"",this.string=t}get Length(){return this.string.length}Append(t){null!==t&&(this.string+=t)}AppendLine(t){void 0!==t&&this.Append(t),this.string+="\n"}AppendFormat(t,...e){this.string+=t.replace(/{(\d+)}/g,(t,n)=>void 0!==e[n]?e[n]:t)}toString(){return this.string}}class m{constructor(){if(this.originName=null,this.itemName=null,void 0!==arguments[1]){let t=arguments[0],e=arguments[1];this.originName=t,this.itemName=e}else if(arguments[0]){let t=arguments[0].toString().split(".");this.originName=t[0],this.itemName=t[1]}}static get Null(){return new m(null,null)}get isNull(){return null==this.originName&&null==this.itemName}get fullName(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(t){if(t instanceof m){let e=t;return e.itemName==this.itemName&&e.originName==this.originName}return!1}copy(){return new m(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(t){let e=JSON.parse(t);if(!m.isLikeInkListItem(e))return m.Null;let n=e;return new m(n.originName,n.itemName)}static isLikeInkListItem(t){return!("object"!=typeof t||!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName")||"string"!=typeof t.originName&&null!==typeof t.originName||"string"!=typeof t.itemName&&null!==typeof t.itemName)}}class g extends Map{constructor(){if(super(arguments[0]instanceof g?arguments[0]:[]),this.origins=null,this._originNames=[],arguments[0]instanceof g){let t=arguments[0];t._originNames&&(this._originNames=t._originNames.slice())}else if("string"==typeof arguments[0]){let t=arguments[0],e=arguments[1];this.SetInitialOriginName(t);let n=e.listDefinitions.TryListGetDefinition(t,null);if(!n.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+t);this.origins=[n.result]}else if("object"==typeof arguments[0]&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let t=arguments[0];this.Add(t.Key,t.Value)}}AddItem(t){if(t instanceof m){let e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return d("this.origins");for(let t of this.origins)if(t.name==e.originName){let n=t.TryGetValueForItem(e,0);if(n.exists)return void this.Add(e,n.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}{let e=t,n=null;if(null===this.origins)return d("this.origins");for(let t of this.origins){if(null===e)return d("itemName");if(t.ContainsItemWithName(e)){if(null!=n)throw new Error("Could not add the item "+e+" to this list because it could come from either "+t.name+" or "+n.name);n=t}}if(null==n)throw new Error("Could not add the item "+e+" to this list because it isn't known to any list definitions previously associated with this list.");let i=new m(n.name,e),r=n.ValueForItem(i);this.Add(i,r)}}ContainsItemNamed(t){for(let[e]of this)if(m.fromSerializedKey(e).itemName==t)return!0;return!1}ContainsKey(t){return this.has(t.serialized())}Add(t,e){let n=t.serialized();if(this.has(n))throw new Error("The Map already contains an entry for "+t);this.set(n,e)}Remove(t){return this.delete(t.serialized())}get Count(){return this.size}get originOfMaxItem(){if(null==this.origins)return null;let t=this.maxItem.Key.originName,e=null;return this.origins.every(n=>n.name!=t||(e=n,!1)),e}get originNames(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(let[t]of this){let e=m.fromSerializedKey(t);if(null===e.originName)return d("item.originName");this._originNames.push(e.originName)}}return this._originNames}SetInitialOriginName(t){this._originNames=[t]}SetInitialOriginNames(t){this._originNames=null==t?null:t.slice()}get maxItem(){let t={Key:m.Null,Value:0};for(let[e,n]of this){let i=m.fromSerializedKey(e);(t.Key.isNull||n>t.Value)&&(t={Key:i,Value:n})}return t}get minItem(){let t={Key:m.Null,Value:0};for(let[e,n]of this){let i=m.fromSerializedKey(e);(t.Key.isNull||n<t.Value)&&(t={Key:i,Value:n})}return t}get inverse(){let t=new g;if(null!=this.origins)for(let e of this.origins)for(let[n,i]of e.items){let e=m.fromSerializedKey(n);this.ContainsKey(e)||t.Add(e,i)}return t}get all(){let t=new g;if(null!=this.origins)for(let e of this.origins)for(let[n,i]of e.items){let e=m.fromSerializedKey(n);t.set(e.serialized(),i)}return t}Union(t){let e=new g(this);for(let[n,i]of t)e.set(n,i);return e}Intersect(t){let e=new g;for(let[n,i]of this)t.has(n)&&e.set(n,i);return e}Without(t){let e=new g(this);for(let[n]of t)e.delete(n);return e}Contains(t){for(let[e]of t)if(!this.has(e))return!1;return!0}GreaterThan(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}GreaterThanOrEquals(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}LessThan(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}LessThanOrEquals(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}MaxAsList(){return this.Count>0?new g(this.maxItem):new g}MinAsList(){return this.Count>0?new g(this.minItem):new g}ListWithSubRange(t,e){if(0==this.Count)return new g;let n=this.orderedItems,i=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?i=t:t instanceof g&&t.Count>0&&(i=t.minItem.Value),Number.isInteger(e)?r=e:t instanceof g&&t.Count>0&&(r=e.maxItem.Value);let s=new g;s.SetInitialOriginNames(this.originNames);for(let t of n)t.Value>=i&&t.Value<=r&&s.Add(t.Key,t.Value);return s}Equals(t){if(t instanceof g==0)return!1;if(t.Count!=this.Count)return!1;for(let[e]of this)if(!t.has(e))return!1;return!0}get orderedItems(){let t=new Array;for(let[e,n]of this){let i=m.fromSerializedKey(e);t.push({Key:i,Value:n})}return t.sort((t,e)=>null===t.Key.originName?d("x.Key.originName"):null===e.Key.originName?d("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0),t}toString(){let t=this.orderedItems,e=new f;for(let n=0;n<t.length;n++){n>0&&e.Append(", ");let i=t[n].Key;if(null===i.itemName)return d("item.itemName");e.Append(i.itemName)}return e.toString()}valueOf(){return NaN}}class y extends Error{constructor(t){super(t),this.useEndLineNumber=!1,this.message=t,this.name="StoryException"}}function S(t,e,n){if(null===t)return{result:n,exists:!1};let i=t.get(e);return void 0===i?{result:n,exists:!1}:{result:i,exists:!0}}class C extends p{static Create(t,n){if(n){if(n===i.Int&&Number.isInteger(Number(t)))return new b(Number(t));if(n===i.Float&&!isNaN(t))return new _(Number(t))}return"boolean"==typeof t&&(t=t?1:0),"string"==typeof t?new w(String(t)):Number.isInteger(Number(t))?new b(Number(t)):isNaN(t)?t instanceof e?new P(a(t,e)):t instanceof g?new T(a(t,g)):null:new _(Number(t))}Copy(){return a(C.Create(this),p)}BadCastException(t){return new y("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}class v extends C{constructor(t){super(),this.value=t}get valueObject(){return this.value}toString(){return null===this.value?d("Value.value"):this.value.toString()}}class b extends v{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return i.Int}Cast(t){if(null===this.value)return d("Value.value");if(t==this.valueType)return this;if(t==i.Float)return new _(this.value);if(t==i.String)return new w(""+this.value);throw this.BadCastException(t)}}class _ extends v{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return i.Float}Cast(t){if(null===this.value)return d("Value.value");if(t==this.valueType)return this;if(t==i.Int)return new b(this.value);if(t==i.String)return new w(""+this.value);throw this.BadCastException(t)}}class w extends v{constructor(t){if(super(t||""),this._isNewline="\n"==this.value,this._isInlineWhitespace=!0,null===this.value)return d("Value.value");this.value.length>0&&this.value.split("").every(t=>" "==t||"\t"==t||(this._isInlineWhitespace=!1,!1))}get valueType(){return i.String}get isTruthy(){return null===this.value?d("Value.value"):this.value.length>0}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(t){if(t==this.valueType)return this;if(t==i.Int){let e=function(t,e=0){let n=parseInt(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(e.exists)return new b(e.result);throw this.BadCastException(t)}if(t==i.Float){let e=function(t,e=0){let n=parseFloat(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(e.exists)return new _(e.result);throw this.BadCastException(t)}throw this.BadCastException(t)}}class P extends v{constructor(t){super(t)}get valueType(){return i.DivertTarget}get targetPath(){return null===this.value?d("Value.value"):this.value}set targetPath(t){this.value=t}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a divert target")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"DivertTargetValue("+this.targetPath+")"}}class O extends v{constructor(t,e=-1){super(t),this._contextIndex=e}get contextIndex(){return this._contextIndex}set contextIndex(t){this._contextIndex=t}get variableName(){return null===this.value?d("Value.value"):this.value}set variableName(t){this.value=t}get valueType(){return i.VariablePointer}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new O(this.variableName,this.contextIndex)}}class T extends v{get isTruthy(){return null===this.value?d("this.value"):this.value.Count>0}get valueType(){return i.List}Cast(t){if(null===this.value)return d("Value.value");if(t==i.Int){let t=this.value.maxItem;return t.Key.isNull?new b(0):new b(t.Value)}if(t==i.Float){let t=this.value.maxItem;return t.Key.isNull?new _(0):new _(t.Value)}if(t==i.String){let t=this.value.maxItem;return t.Key.isNull?new w(""):new w(t.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}constructor(t,e){super(null),t||e?t instanceof g?this.value=new g(t):t instanceof m&&"number"==typeof e&&(this.value=new g({Key:t,Value:e})):this.value=new g}static RetainListOriginsForAssignment(t,e){let n=s(t,T),i=s(e,T);return i&&null===i.value?d("newList.value"):n&&null===n.value?d("oldList.value"):void(n&&i&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames))}}!function(t){t[t.Int=0]="Int",t[t.Float=1]="Float",t[t.List=2]="List",t[t.String=3]="String",t[t.DivertTarget=4]="DivertTarget",t[t.VariablePointer=5]="VariablePointer"}(i||(i={}));class N{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof E?this.obj:null}copy(){let t=new N;return t.obj=this.obj,t.approximate=this.approximate,t}}class E extends p{constructor(){super(...arguments),this.name="",this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return null!=this.name&&this.name.length>0}get content(){return this._content}set content(t){this.AddContent(t)}get namedOnlyContent(){let t=new Map;for(let[e,n]of this.namedContent){let i=a(n,p);t.set(e,i)}for(let e of this.content){let n=o(e);null!=n&&n.hasValidName&&t.delete(n.name)}return 0==t.size&&(t=null),t}set namedOnlyContent(t){let e=this.namedOnlyContent;if(null!=e)for(let[t]of e)this.namedContent.delete(t);if(null!=t)for(let[,e]of t){let t=o(e);null!=t&&this.AddToNamedContentOnly(t)}}get countFlags(){let t=0;return this.visitsShouldBeCounted&&(t|=E.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=E.CountFlags.Turns),this.countingAtStartOnly&&(t|=E.CountFlags.CountStartOnly),t==E.CountFlags.CountStartOnly&&(t=0),t}set countFlags(t){let e=t;(e&E.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&E.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&E.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let t=[],n=this;for(;n instanceof E;)n.content.length>0&&(t.push(new e.Component(0)),n=n.content[0]);return new e(t)}AddContent(t){if(t instanceof Array){let e=t;for(let t of e)this.AddContent(t)}else{let e=t;if(this._content.push(e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}}TryAddNamedContent(t){let e=o(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}AddToNamedContentOnly(t){n.AssertType(t,p,"Can only add Runtime.Objects to a Runtime.Container"),a(t,p).parent=this,this.namedContent.set(t.name,t)}ContentAtPath(t,e=0,n=-1){-1==n&&(n=t.length);let i=new N;i.approximate=!1;let r=this,a=this;for(let o=e;o<n;++o){let e=t.GetComponent(o);if(null==r){i.approximate=!0;break}let n=r.ContentWithPathComponent(e);if(null==n){i.approximate=!0;break}a=n,r=s(n,E)}return i.obj=a,i}InsertContent(t,e){if(this.content[e]=t,t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}AddContentsOfContainer(t){this.content=this.content.concat(t.content);for(let e of t.content)e.parent=this,this.TryAddNamedContent(e)}ContentWithPathComponent(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;{if(null===t.name)return d("component.name");let e=S(this.namedContent,t.name,null);return e.exists?a(e.result,p):null}}BuildStringOfHierarchy(){let t;if(0==arguments.length)return t=new f,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];let e=arguments[1],i=arguments[2];function r(){for(let n=0;n<4*e;++n)t.Append(" ")}r(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==i&&t.Append("  <---"),t.AppendLine(),e++;for(let n=0;n<this.content.length;++n){let s=this.content[n];s instanceof E?s.BuildStringOfHierarchy(t,e,i):(r(),s instanceof w?(t.Append('"'),t.Append(s.toString().replace("\n","\\n")),t.Append('"')):t.Append(s.toString())),n!=this.content.length-1&&t.Append(","),s instanceof E||s!=i||t.Append("  <---"),t.AppendLine()}let s=new Map;for(let[t,e]of this.namedContent)this.content.indexOf(a(e,p))>=0||s.set(t,e);if(s.size>0){r(),t.AppendLine("-- named: --");for(let[,r]of s)n.AssertType(r,E,"Can only print out named Containers"),r.BuildStringOfHierarchy(t,e,i),t.AppendLine()}e--,r(),t.Append("]")}}!function(t){let e;!function(t){t[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"}(e=t.CountFlags||(t.CountFlags={}))}(E||(E={}));class I extends p{toString(){return"Glue"}}class x extends p{constructor(t=x.CommandType.NotSet){super(),this._commandType=t}get commandType(){return this._commandType}Copy(){return new x(this.commandType)}static EvalStart(){return new x(x.CommandType.EvalStart)}static EvalOutput(){return new x(x.CommandType.EvalOutput)}static EvalEnd(){return new x(x.CommandType.EvalEnd)}static Duplicate(){return new x(x.CommandType.Duplicate)}static PopEvaluatedValue(){return new x(x.CommandType.PopEvaluatedValue)}static PopFunction(){return new x(x.CommandType.PopFunction)}static PopTunnel(){return new x(x.CommandType.PopTunnel)}static BeginString(){return new x(x.CommandType.BeginString)}static EndString(){return new x(x.CommandType.EndString)}static NoOp(){return new x(x.CommandType.NoOp)}static ChoiceCount(){return new x(x.CommandType.ChoiceCount)}static Turns(){return new x(x.CommandType.Turns)}static TurnsSince(){return new x(x.CommandType.TurnsSince)}static ReadCount(){return new x(x.CommandType.ReadCount)}static Random(){return new x(x.CommandType.Random)}static SeedRandom(){return new x(x.CommandType.SeedRandom)}static VisitIndex(){return new x(x.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new x(x.CommandType.SequenceShuffleIndex)}static StartThread(){return new x(x.CommandType.StartThread)}static Done(){return new x(x.CommandType.Done)}static End(){return new x(x.CommandType.End)}static ListFromInt(){return new x(x.CommandType.ListFromInt)}static ListRange(){return new x(x.CommandType.ListRange)}static ListRandom(){return new x(x.CommandType.ListRandom)}toString(){return this.commandType.toString()}}!function(t){let e;!function(t){t[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.Random=13]="Random",t[t.SeedRandom=14]="SeedRandom",t[t.VisitIndex=15]="VisitIndex",t[t.SequenceShuffleIndex=16]="SequenceShuffleIndex",t[t.StartThread=17]="StartThread",t[t.Done=18]="Done",t[t.End=19]="End",t[t.ListFromInt=20]="ListFromInt",t[t.ListRange=21]="ListRange",t[t.ListRandom=22]="ListRandom",t[t.ReadCount=23]="ReadCount",t[t.TOTAL_VALUES=24]="TOTAL_VALUES"}(e=t.CommandType||(t.CommandType={}))}(x||(x={})),function(t){t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(r||(r={}));class A{constructor(){this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}get isNull(){return null==this.container}get path(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new e.Component(this.index)):this.container.path}toString(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new A(this.container,this.index)}static StartOf(t){return new A(t,0)}static get Null(){return new A(null,-1)}}class k extends p{constructor(t){super(),this._targetPath=null,this._targetPointer=A.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,void 0!==t&&(this.pushesToStack=!0,this.stackPushType=t)}get targetPath(){if(null!=this._targetPath&&this._targetPath.isRelative){let t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath}set targetPath(t){this._targetPath=t,this._targetPointer=A.Null}get targetPointer(){if(this._targetPointer.isNull){let t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return d("this._targetPath");if(null===this._targetPath.lastComponent)return d("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return d("targetObj");this._targetPointer.container=t.parent instanceof E?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=A.StartOf(t instanceof E?t:null)}return this._targetPointer.copy()}get targetPathString(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)}set targetPathString(t){this.targetPath=null==t?null:new e(t)}get hasVariableTarget(){return null!=this.variableDivertName}Equals(t){let e=t;return e instanceof k&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:null===this.targetPath?d("this.targetPath"):this.targetPath.Equals(e.targetPath))}toString(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";{let t=new f,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==r.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}}class V extends p{constructor(t=!0){super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=t}get pathOnChoice(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){let t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice}set pathOnChoice(t){this._pathOnChoice=t}get choiceTarget(){return null===this._pathOnChoice?d("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return null===this.pathOnChoice?d("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(t){this.pathOnChoice=new e(t)}get flags(){let t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t}set flags(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}toString(){return null===this.pathOnChoice?d("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}class W extends p{constructor(t=null){super(),this.pathForCount=null,this.name=t}get containerForCount(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(t){this.pathForCount=null===t?null:new e(t)}toString(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}class F extends p{constructor(t,e){super(),this.variableName=t||null,this.isNewDeclaration=!!e,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}}class L extends p{}class R extends p{constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,0===arguments.length)R.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){let t=arguments[0];R.GenerateNativeFunctionsIfNecessary(),this.name=t}else if(2===arguments.length){let t=arguments[0],e=arguments[1];this._isPrototype=!0,this.name=t,this.numberOfParameters=e}}static CallWithName(t){return new R(t)}static CallExistsWithName(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}get name(){return null===this._name?d("NativeFunctionCall._name"):this._name}set name(t){this._name=t,this._isPrototype||(null===R._nativeFunctions?d("NativeFunctionCall._nativeFunctions"):this._prototype=R._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(t){this._numberOfParameters=t}Call(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");let e=!1;for(let n of t){if(n instanceof L)throw new y('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');n instanceof T&&(e=!0)}if(2==t.length&&e)return this.CallBinaryListOperation(t);let n=this.CoerceValuesToSingleType(t),r=n[0].valueType;return r==i.Int||r==i.Float||r==i.String||r==i.DivertTarget||r==i.List?this.CallType(n):null}CallType(t){let e=a(t[0],v),n=e.valueType,r=e,s=t.length;if(2==s||1==s){if(null===this._operationFuncs)return d("NativeFunctionCall._operationFuncs");let o=this._operationFuncs.get(n);if(!o){const t=i[n];throw new y("Cannot perform operation "+this.name+" on "+t)}if(2==s){let e=a(t[1],v),n=o;if(null===r.value||null===e.value)return d("NativeFunctionCall.Call BinaryOp values");let i=n(r.value,e.value);return v.Create(i)}{let t=o;if(null===r.value)return d("NativeFunctionCall.Call UnaryOp value");let n=t(r.value);return this.name===R.Int?v.Create(n,i.Int):this.name===R.Float?v.Create(n,i.Float):v.Create(n,e.valueType)}}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}CallBinaryListOperation(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof T&&t[1]instanceof b)return this.CallListIncrementOperation(t);let e=a(t[0],v),n=a(t[1],v);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==i.List&&n.valueType==i.List)){if(null===this._operationFuncs)return d("NativeFunctionCall._operationFuncs");let t=this._operationFuncs.get(i.Int);if(null===t)return d("NativeFunctionCall.CallBinaryListOperation op");let r=t(e.isTruthy?1:0,n.isTruthy?1:0);return new b(r)}if(e.valueType==i.List&&n.valueType==i.List)return this.CallType([e,n]);throw new y("Can not call use "+this.name+" operation on "+i[e.valueType]+" and "+i[n.valueType])}CallListIncrementOperation(t){let e=a(t[0],T),n=a(t[1],b),r=new g;if(null===e.value)return d("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[t,s]of e.value){let a=m.fromSerializedKey(t);if(null===this._operationFuncs)return d("NativeFunctionCall._operationFuncs");let o=this._operationFuncs.get(i.Int);if(null===n.value)return d("NativeFunctionCall.CallListIncrementOperation intVal.value");let l=o(s,n.value),u=null;if(null===e.value.origins)return d("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let t of e.value.origins)if(t.name==a.originName){u=t;break}if(null!=u){let t=u.TryGetItemWithValue(l,m.Null);t.exists&&r.Add(t.result,l)}}return new T(r)}CoerceValuesToSingleType(t){let e=i.Int,n=null;for(let r of t){let t=a(r,v);t.valueType>e&&(e=t.valueType),t.valueType==i.List&&(n=s(t,T))}let r=[];if(i[e]==i[i.List])for(let e of t){let t=a(e,v);if(t.valueType==i.List)r.push(t);else{if(t.valueType!=i.Int){const e=i[t.valueType];throw new y("Cannot mix Lists and "+e+" values in this operation")}{let e=parseInt(t.valueObject);if(n=a(n,T),null===n.value)return d("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");let i=n.value.originOfMaxItem;if(null===i)return d("NativeFunctionCall.CoerceValuesToSingleType list");let s=i.TryGetItemWithValue(e,m.Null);if(!s.exists)throw new y("Could not find List item with the value "+e+" in "+i.name);{let t=new T(s.result,e);r.push(t)}}}}else for(let n of t){let t=a(n,v).Cast(e);r.push(t)}return r}static Identity(t){return t}static GenerateNativeFunctionsIfNecessary(){if(null==this._nativeFunctions){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(t,e)=>t+e),this.AddIntBinaryOp(this.Subtract,(t,e)=>t-e),this.AddIntBinaryOp(this.Multiply,(t,e)=>t*e),this.AddIntBinaryOp(this.Divide,(t,e)=>Math.floor(t/e)),this.AddIntBinaryOp(this.Mod,(t,e)=>t%e),this.AddIntUnaryOp(this.Negate,t=>-t),this.AddIntBinaryOp(this.Equal,(t,e)=>t==e?1:0),this.AddIntBinaryOp(this.Greater,(t,e)=>t>e?1:0),this.AddIntBinaryOp(this.Less,(t,e)=>t<e?1:0),this.AddIntBinaryOp(this.GreaterThanOrEquals,(t,e)=>t>=e?1:0),this.AddIntBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e?1:0),this.AddIntBinaryOp(this.NotEquals,(t,e)=>t!=e?1:0),this.AddIntUnaryOp(this.Not,t=>0==t?1:0),this.AddIntBinaryOp(this.And,(t,e)=>0!=t&&0!=e?1:0),this.AddIntBinaryOp(this.Or,(t,e)=>0!=t||0!=e?1:0),this.AddIntBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddIntBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddIntBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddIntUnaryOp(this.Floor,R.Identity),this.AddIntUnaryOp(this.Ceiling,R.Identity),this.AddIntUnaryOp(this.Int,R.Identity),this.AddIntUnaryOp(this.Float,t=>t),this.AddFloatBinaryOp(this.Add,(t,e)=>t+e),this.AddFloatBinaryOp(this.Subtract,(t,e)=>t-e),this.AddFloatBinaryOp(this.Multiply,(t,e)=>t*e),this.AddFloatBinaryOp(this.Divide,(t,e)=>t/e),this.AddFloatBinaryOp(this.Mod,(t,e)=>t%e),this.AddFloatUnaryOp(this.Negate,t=>-t),this.AddFloatBinaryOp(this.Equal,(t,e)=>t==e?1:0),this.AddFloatBinaryOp(this.Greater,(t,e)=>t>e?1:0),this.AddFloatBinaryOp(this.Less,(t,e)=>t<e?1:0),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(t,e)=>t>=e?1:0),this.AddFloatBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e?1:0),this.AddFloatBinaryOp(this.NotEquals,(t,e)=>t!=e?1:0),this.AddFloatUnaryOp(this.Not,t=>0==t?1:0),this.AddFloatBinaryOp(this.And,(t,e)=>0!=t&&0!=e?1:0),this.AddFloatBinaryOp(this.Or,(t,e)=>0!=t||0!=e?1:0),this.AddFloatBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddFloatBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddFloatBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddFloatUnaryOp(this.Floor,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Ceiling,t=>Math.ceil(t)),this.AddFloatUnaryOp(this.Int,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Float,R.Identity),this.AddStringBinaryOp(this.Add,(t,e)=>t+e),this.AddStringBinaryOp(this.Equal,(t,e)=>t===e?1:0),this.AddStringBinaryOp(this.NotEquals,(t,e)=>t!==e?1:0),this.AddStringBinaryOp(this.Has,(t,e)=>t.includes(e)?1:0),this.AddStringBinaryOp(this.Hasnt,(t,e)=>t.includes(e)?0:1),this.AddListBinaryOp(this.Add,(t,e)=>t.Union(e)),this.AddListBinaryOp(this.Subtract,(t,e)=>t.Without(e)),this.AddListBinaryOp(this.Has,(t,e)=>t.Contains(e)?1:0),this.AddListBinaryOp(this.Hasnt,(t,e)=>t.Contains(e)?0:1),this.AddListBinaryOp(this.Intersect,(t,e)=>t.Intersect(e)),this.AddListBinaryOp(this.Equal,(t,e)=>t.Equals(e)?1:0),this.AddListBinaryOp(this.Greater,(t,e)=>t.GreaterThan(e)?1:0),this.AddListBinaryOp(this.Less,(t,e)=>t.LessThan(e)?1:0),this.AddListBinaryOp(this.GreaterThanOrEquals,(t,e)=>t.GreaterThanOrEquals(e)?1:0),this.AddListBinaryOp(this.LessThanOrEquals,(t,e)=>t.LessThanOrEquals(e)?1:0),this.AddListBinaryOp(this.NotEquals,(t,e)=>t.Equals(e)?0:1),this.AddListBinaryOp(this.And,(t,e)=>t.Count>0&&e.Count>0?1:0),this.AddListBinaryOp(this.Or,(t,e)=>t.Count>0||e.Count>0?1:0),this.AddListUnaryOp(this.Not,t=>0==t.Count?1:0),this.AddListUnaryOp(this.Invert,t=>t.inverse),this.AddListUnaryOp(this.All,t=>t.all),this.AddListUnaryOp(this.ListMin,t=>t.MinAsList()),this.AddListUnaryOp(this.ListMax,t=>t.MaxAsList()),this.AddListUnaryOp(this.Count,t=>t.Count),this.AddListUnaryOp(this.ValueOfList,t=>t.maxItem.Value);let t=(t,e)=>t.Equals(e)?1:0,e=(t,e)=>t.Equals(e)?0:1;this.AddOpToNativeFunc(this.Equal,2,i.DivertTarget,t),this.AddOpToNativeFunc(this.NotEquals,2,i.DivertTarget,e)}}AddOpFuncForType(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}static AddOpToNativeFunc(t,e,n,i){if(null===this._nativeFunctions)return d("NativeFunctionCall._nativeFunctions");let r=this._nativeFunctions.get(t);r||(r=new R(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(n,i)}static AddIntBinaryOp(t,e){this.AddOpToNativeFunc(t,2,i.Int,e)}static AddIntUnaryOp(t,e){this.AddOpToNativeFunc(t,1,i.Int,e)}static AddFloatBinaryOp(t,e){this.AddOpToNativeFunc(t,2,i.Float,e)}static AddFloatUnaryOp(t,e){this.AddOpToNativeFunc(t,1,i.Float,e)}static AddStringBinaryOp(t,e){this.AddOpToNativeFunc(t,2,i.String,e)}static AddListBinaryOp(t,e){this.AddOpToNativeFunc(t,2,i.List,e)}static AddListUnaryOp(t,e){this.AddOpToNativeFunc(t,1,i.List,e)}toString(){return'Native "'+this.name+'"'}}R.Add="+",R.Subtract="-",R.Divide="/",R.Multiply="*",R.Mod="%",R.Negate="_",R.Equal="==",R.Greater=">",R.Less="<",R.GreaterThanOrEquals=">=",R.LessThanOrEquals="<=",R.NotEquals="!=",R.Not="!",R.And="&&",R.Or="||",R.Min="MIN",R.Max="MAX",R.Pow="POW",R.Floor="FLOOR",R.Ceiling="CEILING",R.Int="INT",R.Float="FLOAT",R.Has="?",R.Hasnt="!?",R.Intersect="^",R.ListMin="LIST_MIN",R.ListMax="LIST_MAX",R.All="LIST_ALL",R.Count="LIST_COUNT",R.ValueOfList="LIST_VALUE",R.Invert="LIST_INVERT",R._nativeFunctions=null;class j extends p{constructor(t){super(),this.text=t.toString()||""}toString(){return"# "+this.text}}class M extends p{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.originalThreadIndex=0}get pathStringOnChoice(){return null===this.targetPath?d("Choice.targetPath"):this.targetPath.toString()}set pathStringOnChoice(t){this.targetPath=new e(t)}}class G{constructor(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}get name(){return this._name}get items(){if(null==this._items){this._items=new Map;for(let[t,e]of this._itemNameToValues){let n=new m(this.name,t);this._items.set(n.serialized(),e)}}return this._items}ValueForItem(t){if(!t.itemName)return 0;let e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}ContainsItem(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}ContainsItemWithName(t){return this._itemNameToValues.has(t)}TryGetItemWithValue(t,e){for(let[e,n]of this._itemNameToValues)if(n==t)return{result:new m(this.name,e),exists:!0};return{result:m.Null,exists:!1}}TryGetValueForItem(t,e){if(!t.itemName)return{result:0,exists:!1};let n=this._itemNameToValues.get(t.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}}class D{constructor(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(let e of t){this._lists.set(e.name,e);for(let[t,n]of e.items){let e=m.fromSerializedKey(t),i=new T(e,n);if(!e.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(e.itemName,i),this._allUnambiguousListValueCache.set(e.fullName,i)}}}get lists(){let t=[];for(let[,e]of this._lists)t.push(e);return t}TryListGetDefinition(t,e){if(null===t)return{result:e,exists:!1};let n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}FindSingleItemListWithName(t){if(null===t)return d("name");let e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}}class B{static JArrayToRuntimeObjList(t,e=!1){let n=t.length;e&&n--;let i=[];for(let e=0;e<n;e++){let n=t[e],r=this.JTokenToRuntimeObject(n);if(null===r)return d("runtimeObj");i.push(r)}return i}static WriteDictionaryRuntimeObjs(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WritePropertyStart(n),this.WriteRuntimeObject(t,i),t.WritePropertyEnd();t.WriteObjectEnd()}static WriteListRuntimeObjs(t,e){t.WriteArrayStart();for(let n of e)this.WriteRuntimeObject(t,n);t.WriteArrayEnd()}static WriteIntDictionary(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WriteIntProperty(n,i);t.WriteObjectEnd()}static WriteRuntimeObject(t,e){let n=s(e,E);if(n)return void this.WriteRuntimeContainer(t,n);let i=s(e,k);if(i){let e,n="->";return i.isExternal?n="x()":i.pushesToStack&&(i.stackPushType==r.Function?n="f()":i.stackPushType==r.Tunnel&&(n="->t->")),e=i.hasVariableTarget?i.variableDivertName:i.targetPathString,t.WriteObjectStart(),t.WriteProperty(n,e),i.hasVariableTarget&&t.WriteProperty("var",!0),i.isConditional&&t.WriteProperty("c",!0),i.externalArgs>0&&t.WriteIntProperty("exArgs",i.externalArgs),void t.WriteObjectEnd()}let a=s(e,V);if(a)return t.WriteObjectStart(),t.WriteProperty("*",a.pathStringOnChoice),t.WriteIntProperty("flg",a.flags),void t.WriteObjectEnd();let o=s(e,b);if(o)return void t.WriteInt(o.value);let l=s(e,_);if(l)return void t.WriteFloat(l.value);let u=s(e,w);if(u)return void(u.isNewline?t.Write("\n",!1):(t.WriteStringStart(),t.WriteStringInner("^"),t.WriteStringInner(u.value),t.WriteStringEnd()));let h=s(e,T);if(h)return void this.WriteInkList(t,h);let c=s(e,P);if(c)return t.WriteObjectStart(),null===c.value?d("divTargetVal.value"):(t.WriteProperty("^->",c.value.componentsString),void t.WriteObjectEnd());let p=s(e,O);if(p)return t.WriteObjectStart(),t.WriteProperty("^var",p.value),t.WriteIntProperty("ci",p.contextIndex),void t.WriteObjectEnd();if(s(e,I))return void t.Write("<>");let f=s(e,x);if(f)return void t.Write(B._controlCommandNames[f.commandType]);let m=s(e,R);if(m){let e=m.name;return"^"==e&&(e="L^"),void t.Write(e)}let g=s(e,W);if(g){t.WriteObjectStart();let e=g.pathStringForCount;return null!=e?t.WriteProperty("CNT?",e):t.WriteProperty("VAR?",g.name),void t.WriteObjectEnd()}let y=s(e,F);if(y){t.WriteObjectStart();let e=y.isGlobal?"VAR=":"temp=";return t.WriteProperty(e,y.variableName),y.isNewDeclaration||t.WriteProperty("re",!0),void t.WriteObjectEnd()}if(s(e,L))return void t.Write("void");let S=s(e,j);if(S)return t.WriteObjectStart(),t.WriteProperty("#",S.text),void t.WriteObjectEnd();let C=s(e,M);if(!C)throw new Error("Failed to convert runtime object to Json token: "+e);this.WriteChoice(t,C)}static JObjectToDictionaryRuntimeObjs(t){let e=new Map;for(let n in t)if(t.hasOwnProperty(n)){let i=this.JTokenToRuntimeObject(t[n]);if(null===i)return d("inkObject");e.set(n,i)}return e}static JObjectToIntDictionary(t){let e=new Map;for(let n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}static JTokenToRuntimeObject(t){if("number"==typeof t&&!isNaN(t))return v.Create(t);if("string"==typeof t){let e=t.toString(),n=e[0];if("^"==n)return new w(e.substring(1));if("\n"==n&&1==e.length)return new w("\n");if("<>"==e)return new I;for(let t=0;t<B._controlCommandNames.length;++t)if(e==B._controlCommandNames[t])return new x(t);if("L^"==e&&(e="^"),R.CallExistsWithName(e))return R.CallWithName(e);if("->->"==e)return x.PopTunnel();if("~ret"==e)return x.PopFunction();if("void"==e)return new L}if("object"==typeof t&&!Array.isArray(t)){let n,i=t;if(i["^->"])return n=i["^->"],new P(new e(n.toString()));if(i["^var"]){n=i["^var"];let t=new O(n.toString());return"ci"in i&&(n=i.ci,t.contextIndex=parseInt(n)),t}let s=!1,a=!1,o=r.Function,l=!1;if((n=i["->"])?s=!0:(n=i["f()"])?(s=!0,a=!0,o=r.Function):(n=i["->t->"])?(s=!0,a=!0,o=r.Tunnel):(n=i["x()"])&&(s=!0,l=!0,a=!1,o=r.Function),s){let t=new k;t.pushesToStack=a,t.stackPushType=o,t.isExternal=l;let e=n.toString();return(n=i.var)?t.variableDivertName=e:t.targetPathString=e,t.isConditional=!!i.c,l&&(n=i.exArgs)&&(t.externalArgs=parseInt(n)),t}if(n=i["*"]){let t=new V;return t.pathStringOnChoice=n.toString(),(n=i.flg)&&(t.flags=parseInt(n)),t}if(n=i["VAR?"])return new W(n.toString());if(n=i["CNT?"]){let t=new W;return t.pathStringForCount=n.toString(),t}let u=!1,h=!1;if((n=i["VAR="])?(u=!0,h=!0):(n=i["temp="])&&(u=!0,h=!1),u){let t=n.toString(),e=!i.re,r=new F(t,e);return r.isGlobal=h,r}if(void 0!==i["#"])return n=i["#"],new j(n.toString());if(n=i.list){let t=n,e=new g;if(n=i.origins){let t=n;e.SetInitialOriginNames(t)}for(let n in t)if(t.hasOwnProperty(n)){let i=t[n],r=new m(n),s=parseInt(i);e.Add(r,s)}return new T(e)}if(null!=i.originalChoicePath)return this.JObjectToChoice(i)}if(Array.isArray(t))return this.JArrayToContainer(t);if(null==t)return null;throw new Error("Failed to convert token to runtime object: "+JSON.stringify(t))}static WriteRuntimeContainer(t,e,n=!1){if(t.WriteArrayStart(),null===e)return d("container");for(let n of e.content)this.WriteRuntimeObject(t,n);let i=e.namedOnlyContent,r=e.countFlags,a=null!=e.name&&!n,o=null!=i||r>0||a;if(o&&t.WriteObjectStart(),null!=i)for(let[e,n]of i){let i=e,r=s(n,E);t.WritePropertyStart(i),this.WriteRuntimeContainer(t,r,!0),t.WritePropertyEnd()}a&&t.WriteProperty("#n",e.name),o?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}static JArrayToContainer(t){let e=new E;e.content=this.JArrayToRuntimeObjList(t,!0);let n=t[t.length-1];if(null!=n){let t=new Map;for(let i in n)if("#f"==i)e.countFlags=parseInt(n[i]);else if("#n"==i)e.name=n[i].toString();else{let e=this.JTokenToRuntimeObject(n[i]),r=s(e,E);r&&(r.name=i),t.set(i,e)}e.namedOnlyContent=t}return e}static JObjectToChoice(t){let e=new M;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}static WriteChoice(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),t.WriteObjectEnd()}static WriteInkList(t,e){let n=e.value;if(null===n)return d("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();for(let[e,i]of n){let n=m.fromSerializedKey(e),r=i;if(null===n.itemName)return d("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(n.originName?n.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(n.itemName),t.WritePropertyNameEnd(),t.Write(r),t.WritePropertyEnd()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),0==n.Count&&null!=n.originNames&&n.originNames.length>0){t.WritePropertyStart("origins"),t.WriteArrayStart();for(let e of n.originNames)t.Write(e);t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}static ListDefinitionsToJToken(t){let e={};for(let n of t.lists){let t={};for(let[e,i]of n.items){let n=m.fromSerializedKey(e);if(null===n.itemName)return d("item.itemName");t[n.itemName]=i}e[n.name]=t}return e}static JTokenToListDefinitions(t){let e=t,n=[];for(let t in e)if(e.hasOwnProperty(t)){let i=t.toString(),r=e[t],s=new Map;for(let n in r)if(e.hasOwnProperty(t)){let t=r[n];s.set(n,parseInt(t))}let a=new G(i,s);n.push(a)}return new D(n)}}B._controlCommandNames=(()=>{let t=[];t[x.CommandType.EvalStart]="ev",t[x.CommandType.EvalOutput]="out",t[x.CommandType.EvalEnd]="/ev",t[x.CommandType.Duplicate]="du",t[x.CommandType.PopEvaluatedValue]="pop",t[x.CommandType.PopFunction]="~ret",t[x.CommandType.PopTunnel]="->->",t[x.CommandType.BeginString]="str",t[x.CommandType.EndString]="/str",t[x.CommandType.NoOp]="nop",t[x.CommandType.ChoiceCount]="choiceCnt",t[x.CommandType.Turns]="turn",t[x.CommandType.TurnsSince]="turns",t[x.CommandType.ReadCount]="readc",t[x.CommandType.Random]="rnd",t[x.CommandType.SeedRandom]="srnd",t[x.CommandType.VisitIndex]="visit",t[x.CommandType.SequenceShuffleIndex]="seq",t[x.CommandType.StartThread]="thread",t[x.CommandType.Done]="done",t[x.CommandType.End]="end",t[x.CommandType.ListFromInt]="listInt",t[x.CommandType.ListRange]="range",t[x.CommandType.ListRandom]="lrnd";for(let e=0;e<x.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t})();class U{constructor(){if(this._threadCounter=0,this._startOfRoot=A.Null,arguments[0]instanceof X){let t=arguments[0];this._startOfRoot=A.StartOf(t.rootContentContainer),this.Reset()}else{let t=arguments[0];this._threads=[];for(let e of t._threads)this._threads.push(e.Copy());this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot}}get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){let t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(t){n.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}get canPop(){return this.callStack.length>1}Reset(){this._threads=[],this._threads.push(new U.Thread),this._threads[0].callstack.push(new U.Element(r.Tunnel,this._startOfRoot))}SetJsonToken(t,e){this._threads.length=0;let n=t.threads;for(let t of n){let n=t,i=new U.Thread(n,e);this._threads.push(i)}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=A.StartOf(e.rootContentContainer)}WriteJson(t){t.WriteObject(t=>{t.WritePropertyStart("threads"),t.WriteArrayStart();for(let e of this._threads)e.WriteJson(t);t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(this._threadCounter),t.WritePropertyEnd()})}PushThread(){let t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}ForkThread(){let t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}PopThread(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==r.FunctionEvaluationFromGame}Push(t,e=0,n=0){let i=new U.Element(t,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=e,i.functionStartInOutputStream=n,this.callStack.push(i)}CanPop(t=null){return!!this.canPop&&(null==t||this.currentElement.type==t)}Pop(t=null){if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(t,e=-1){-1==e&&(e=this.currentElementIndex+1);let n=S(this.callStack[e-1].temporaryVariables,t,null);return n.exists?n.result:null}SetTemporaryVariable(t,e,n,i=-1){-1==i&&(i=this.currentElementIndex+1);let r=this.callStack[i-1];if(!n&&!r.temporaryVariables.get(t))throw new y("Could not find temporary variable to set: "+t);let s=S(r.temporaryVariables,t,null);s.exists&&T.RetainListOriginsForAssignment(s.result,e),r.temporaryVariables.set(t,e)}ContextForVariableNamed(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}ThreadWithIndex(t){let e=this._threads.filter(e=>{if(e.threadIndex==t)return e});return e.length>0?e[0]:null}get callStack(){return this.currentThread.callstack}get callStackTrace(){let t=new f;for(let e=0;e<this._threads.length;e++){let n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,i?"(current) ":"");for(let e=0;e<n.callstack.length;e++){n.callstack[e].type==r.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");let i=n.callstack[e].currentPointer;if(!i.isNull){if(t.Append("<SOMEWHERE IN "),null===i.container)return d("pointer.container");t.Append(i.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}!function(t){class n{constructor(t,e,n=!1){this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=e.copy(),this.inExpressionEvaluation=n,this.temporaryVariables=new Map,this.type=t}Copy(){let t=new n(this.type,this.currentPointer,this.inExpressionEvaluation);return t.temporaryVariables=new Map(this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOutputStream=this.functionStartInOutputStream,t}}t.Element=n;class i{constructor(){if(this.threadIndex=0,this.previousPointer=A.Null,this.callstack=[],arguments[0]&&arguments[1]){let t=arguments[0],i=arguments[1];this.threadIndex=parseInt(t.threadIndex);let r=t.callstack;for(let t of r){let r,s=t,a=parseInt(s.type),o=A.Null,l=s.cPath;if(void 0!==l){r=l.toString();let t=i.ContentAtPath(new e(r));if(o.container=t.container,o.index=parseInt(s.idx),null==t.obj)throw new Error("When loading state, internal story location couldn't be found: "+r+". Has the story changed since this save data was created?");if(t.approximate){if(null===o.container)return d("pointer.container");i.Warning("When loading state, exact internal story location couldn't be found: '"+r+"', so it was approximated to '"+o.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}let u=!!s.exp,h=new n(a,o,u),c=s.temp;void 0!==c?h.temporaryVariables=B.JObjectToDictionaryRuntimeObjs(c):h.temporaryVariables.clear(),this.callstack.push(h)}let s=t.previousContentObject;if(void 0!==s){let t=new e(s.toString());this.previousPointer=i.PointerAtPath(t)}}}Copy(){let t=new i;t.threadIndex=this.threadIndex;for(let e of this.callstack)t.callstack.push(e.Copy());return t.previousPointer=this.previousPointer.copy(),t}WriteJson(t){t.WriteObjectStart(),t.WritePropertyStart("callstack"),t.WriteArrayStart();for(let e of this.callstack){if(t.WriteObjectStart(),!e.currentPointer.isNull){if(null===e.currentPointer.container)return d("el.currentPointer.container");t.WriteProperty("cPath",e.currentPointer.container.path.componentsString),t.WriteIntProperty("idx",e.currentPointer.index)}t.WriteProperty("exp",e.inExpressionEvaluation),t.WriteIntProperty("type",e.type),e.temporaryVariables.size>0&&(t.WritePropertyStart("temp"),B.WriteDictionaryRuntimeObjs(t,e.temporaryVariables),t.WritePropertyEnd()),t.WriteObjectEnd()}if(t.WriteArrayEnd(),t.WritePropertyEnd(),t.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){let e=this.previousPointer.Resolve();if(null===e)return d("this.previousPointer.Resolve()");t.WriteProperty("previousContentObject",e.path.toString())}t.WriteObjectEnd()}}t.Thread=i}(U||(U={}));class K{constructor(t,e){this.variableChangedEventCallbacks=[],this.patch=null,this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:(t,e)=>e in t?t[e]:t.$(e),set:(t,e,n)=>(e in t?t[e]=n:t.$(e,n),!0)})}catch(t){}}variableChangedEvent(t,e){for(let n of this.variableChangedEventCallbacks)n(t,e)}get batchObservingVariableChanges(){return this._batchObservingVariableChanges}set batchObservingVariableChanges(t){if(this._batchObservingVariableChanges=t,t)this._changedVariablesForBatchObs=new Set;else if(null!=this._changedVariablesForBatchObs){for(let t of this._changedVariablesForBatchObs){let e=this._globalVariables.get(t);e?this.variableChangedEvent(t,e):d("currentValue")}this._changedVariablesForBatchObs=null}}get callStack(){return this._callStack}set callStack(t){this._callStack=t}$(t,e){if(void 0===e){let e=null;return null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists)?e.result.valueObject:(e=this._globalVariables.get(t),void 0===e&&(e=this._defaultGlobalVariables.get(t)),void 0!==e?e.valueObject:null)}{if(void 0===this._defaultGlobalVariables.get(t))throw new y("Cannot assign to a variable ("+t+") that hasn't been declared in the story");let n=v.Create(e);if(null==n)throw new y(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,n)}}ApplyPatch(){if(null===this.patch)return d("this.patch");for(let[t,e]of this.patch.globals)this._globalVariables.set(t,e);if(null!==this._changedVariablesForBatchObs)for(let t of this.patch.changedVariables)this._changedVariablesForBatchObs.add(t);this.patch=null}SetJsonToken(t){this._globalVariables.clear();for(let[e,n]of this._defaultGlobalVariables){let i=t[e];if(void 0!==i){let t=B.JTokenToRuntimeObject(i);if(null===t)return d("tokenInkObject");this._globalVariables.set(e,t)}else this._globalVariables.set(e,n)}}WriteJson(t){t.WriteObjectStart();for(let[e,n]of this._globalVariables){let i=e,r=n;if(K.dontSaveDefaultValues&&this._defaultGlobalVariables.has(i)){let t=this._defaultGlobalVariables.get(i);if(this.RuntimeObjectsEqual(r,t))continue}t.WritePropertyStart(i),B.WriteRuntimeObject(t,r),t.WritePropertyEnd()}t.WriteObjectEnd()}RuntimeObjectsEqual(t,e){if(null===t)return d("obj1");if(null===e)return d("obj2");if(t.constructor!==e.constructor)return!1;let n=s(t,b);if(null!==n)return n.value===a(e,b).value;let i=s(t,_);if(null!==i)return i.value===a(e,_).value;let r=s(t,v),o=s(e,v);if(null!==r&&null!==o)return u(r.valueObject)&&u(o.valueObject)?r.valueObject.Equals(o.valueObject):r.valueObject===o.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}GetVariableWithName(t,e=-1){let n=this.GetRawVariableWithName(t,e),i=s(n,O);return null!==i&&(n=this.ValueAtVariablePointer(i)),n}TryGetDefaultVariableValue(t){let e=S(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}GlobalVariableExistsWithName(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}GetRawVariableWithName(t,e){let n=null;if(0==e||-1==e){let e=null;if(null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists))return e.result;if(e=S(this._globalVariables,t,null),e.exists)return e.result;if(null!==this._defaultGlobalVariables&&(e=S(this._defaultGlobalVariables,t,null),e.exists))return e.result;if(null===this._listDefsOrigin)return d("VariablesState._listDefsOrigin");let n=this._listDefsOrigin.FindSingleItemListWithName(t);if(n)return n}return n=this._callStack.GetTemporaryVariableWithName(t,e),n}ValueAtVariablePointer(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}Assign(t,e){let n=t.variableName;if(null===n)return d("name");let i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(n),t.isNewDeclaration){let t=s(e,O);null!==t&&(e=this.ResolveVariablePointer(t))}else{let t=null;do{t=s(this.GetRawVariableWithName(n,i),O),null!=t&&(n=t.variableName,i=t.contextIndex,r=0==i)}while(null!=t)}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(t,e){let n=a(t,T),i=a(e,T);n.value&&i.value&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}SetGlobal(t,e){let n=null;if(null===this.patch&&(n=S(this._globalVariables,t,null)),null!==this.patch&&(n=this.patch.TryGetGlobal(t,null),n.exists||(n=S(this._globalVariables,t,null))),T.RetainListOriginsForAssignment(n.result,e),null===t)return d("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==n&&e!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return d("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}ResolveVariablePointer(t){let e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));let n=s(this.GetRawVariableWithName(t.variableName,e),O);return null!=n?n:new O(t.variableName,e)}GetContextIndexOfVariableNamed(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}ObserveVariableChange(t){this.variableChangedEventCallbacks.push(t)}}K.dontSaveDefaultValues=!0;class J{constructor(t){this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=16807*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}class q{constructor(){if(this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]){let t=arguments[0];this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}get globals(){return this._globals}get changedVariables(){return this._changedVariables}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}TryGetGlobal(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}SetGlobal(t,e){this._globals.set(t,e)}AddChangedVariable(t){return this._changedVariables.add(t)}TryGetVisitCount(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}SetVisitCount(t,e){this._visitCounts.set(t,e)}SetTurnIndex(t,e){this._turnIndices.set(t,e)}TryGetTurnIndex(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}class H{static TextToDictionary(t){return new H.Reader(t).ToDictionary()}static TextToArray(t){return new H.Reader(t).ToArray()}}!function(t){t.Reader=class{constructor(t){this._rootObject=JSON.parse(t)}ToDictionary(){return this._rootObject}ToArray(){return this._rootObject}};class e{constructor(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}WriteObject(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}WriteObjectStart(){this.StartNewObject(!0);let e={};if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Object))}WriteObjectEnd(){this.Assert(this.state===t.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}WriteProperty(t,e){if(this.WritePropertyStart(t),arguments[1]instanceof Function)(0,arguments[1])(this);else{let t=arguments[1];this.Write(t)}this.WritePropertyEnd()}WriteIntProperty(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}WriteFloatProperty(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}WritePropertyStart(e){this.Assert(this.state===t.Writer.State.Object),this._propertyNameStack.push(e),this.IncrementChildCount(),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property))}WritePropertyEnd(){this.Assert(this.state===t.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}WritePropertyNameStart(){this.Assert(this.state===t.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property)),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.PropertyName))}WritePropertyNameEnd(){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}WritePropertyNameInner(e){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=e}WriteArrayStart(){this.StartNewObject(!0);let e=[];if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Array))}WriteArrayEnd(){this.Assert(this.state===t.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}Write(t,e=!0){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null string")}WriteInt(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}WriteFloat(t){null!==t&&(this.StartNewObject(!1),t==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):t==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(t)?this._addToCurrentObject(0):this._addToCurrentObject(t))}WriteNull(){this.StartNewObject(!1),this._addToCurrentObject(null)}WriteStringStart(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.String))}WriteStringEnd(){this.Assert(this.state==t.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}WriteStringInner(e,n=!0){this.Assert(this.state===t.Writer.State.String),null!==e?this._currentString+=e:console.error("Warning: trying to write a null string")}ToString(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}StartNewObject(e){e?this.Assert(this.state===t.Writer.State.None||this.state===t.Writer.State.Property||this.state===t.Writer.State.Array):this.Assert(this.state===t.Writer.State.Property||this.state===t.Writer.State.Array),this.state===t.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==t.Writer.State.Array&&this.state!==t.Writer.State.Property||this.IncrementChildCount()}get state(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:t.Writer.State.None}get childCount(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}get currentCollection(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}get currentPropertyName(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}IncrementChildCount(){this.Assert(this._stateStack.length>0);let t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}Assert(t){if(!t)throw Error("Assert failed while writing JSON")}_addToCurrentObject(e){this.Assert(null!==this.currentCollection),this.state===t.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(e)):this.state===t.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=e,this._propertyNameStack.pop())}}t.Writer=e,function(e){let n;!function(t){t[t.None=0]="None",t[t.Object=1]="Object",t[t.Array=2]="Array",t[t.Property=3]="Property",t[t.PropertyName=4]="PropertyName",t[t.String=5]="String"}(n=e.State||(e.State={})),e.StateElement=class{constructor(e){this.type=t.Writer.State.None,this.childCount=0,this.type=e}}}(e=t.Writer||(t.Writer={}))}(H||(H={}));class z{constructor(t){this.kInkSaveStateVersion=8,this.kMinCompatibleLoadVersion=8,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=A.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this.story=t,this._outputStream=[],this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new U(t),this._variablesState=new K(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;let e=(new Date).getTime();this.storySeed=new J(e).next()%100,this.previousRandom=0,this._currentChoices=[],this.GoToStart()}ToJson(t=!1){let e=new H.Writer;return this.WriteJson(e),e.ToString()}toJson(t=!1){return this.ToJson(t)}LoadJson(t){let e=H.TextToDictionary(t);this.LoadJsonObj(e)}VisitCountAtPathString(t){let n;if(null!==this._patch){let i=this.story.ContentAtPath(new e(t)).container;if(null===i)throw new Error("Content at path not found: "+t);if(n=this._patch.TryGetVisitCount(i,0),n.exists)return n.result}return n=S(this._visitCounts,t,null),n.exists?n.result:0}VisitCountForContainer(t){if(null===t)return d("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){let e=this._patch.TryGetVisitCount(t,0);if(e.exists)return e.result}let e=t.path.toString(),n=S(this._visitCounts,e,null);return n.exists?n.result:0}IncrementVisitCountForContainer(t){if(null!==this._patch){let e=this.VisitCountForContainer(t);return e++,void this._patch.SetVisitCount(t,e)}let e=t.path.toString(),n=S(this._visitCounts,e,null);n.exists?this._visitCounts.set(e,n.result+1):this._visitCounts.set(e,1)}RecordTurnIndexVisitToContainer(t){if(null!==this._patch)return void this._patch.SetTurnIndex(t,this.currentTurnIndex);let e=t.path.toString();this._turnIndices.set(e,this.currentTurnIndex)}TurnsSinceForContainer(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){let e=this._patch.TryGetTurnIndex(t,0);if(e.exists)return this.currentTurnIndex-e.result}let e=t.path.toString(),n=S(this._turnIndices,e,0);return n.exists?this.currentTurnIndex-n.result:-1}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._outputStream}get currentChoices(){return this.canContinue?[]:this._currentChoices}get generatedChoices(){return this._currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}set variablesState(t){this._variablesState=t}get evaluationStack(){return this._evaluationStack}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}get currentTurnIndex(){return this._currentTurnIndex}set currentTurnIndex(t){this._currentTurnIndex=t}get currentPathString(){let t=this.currentPointer;return t.isNull?null:null===t.path?d("pointer.path"):t.path.toString()}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(t){this.callStack.currentElement.currentPointer=t.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(t){this.callStack.currentThread.previousPointer=t.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return null!=this.currentErrors&&this.currentErrors.length>0}get hasWarning(){return null!=this.currentWarnings&&this.currentWarnings.length>0}get currentText(){if(this._outputStreamTextDirty){let t=new f;for(let e of this._outputStream){let n=s(e,w);null!==n&&t.Append(n.value)}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(t){let e=new f,n=-1,i=0;for(let r=0;r<t.length;r++){let s=t.charAt(r),a=" "==s||"\t"==s;a&&-1==n&&(n=r),a||("\n"!=s&&n>0&&n!=i&&e.Append(" "),n=-1),"\n"==s&&(i=r+1),a||e.Append(s)}return e.toString()}get currentTags(){if(this._outputStreamTagsDirty){this._currentTags=[];for(let t of this._outputStream){let e=s(t,j);null!==e&&this._currentTags.push(e.text)}this._outputStreamTagsDirty=!1}return this._currentTags}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(t){this.callStack.currentElement.inExpressionEvaluation=t}GoToStart(){this.callStack.currentElement.currentPointer=A.StartOf(this.story.mainContentContainer)}CopyAndStartPatching(){let t=new z(this.story);return t._patch=new q(this._patch),t.outputStream.push.apply(t.outputStream,this._outputStream),t.OutputStreamDirty(),t._currentChoices.push.apply(t._currentChoices,this._currentChoices),this.hasError&&(t._currentErrors=[],t._currentErrors.push.apply(t._currentErrors,this.currentErrors||[])),this.hasWarning&&(t._currentWarnings=[],t._currentWarnings.push.apply(t._currentWarnings,this.currentWarnings||[])),t.callStack=new U(this.callStack),t.variablesState=this.variablesState,t.variablesState.callStack=t.callStack,t.variablesState.patch=t._patch,t.evaluationStack.push.apply(t.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(t.divertedPointer=this.divertedPointer.copy()),t.previousPointer=this.previousPointer.copy(),t._visitCounts=this._visitCounts,t._turnIndices=this._turnIndices,t.currentTurnIndex=this.currentTurnIndex,t.storySeed=this.storySeed,t.previousRandom=this.previousRandom,t.didSafeExit=this.didSafeExit,t}RestoreAfterPatch(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}ApplyAnyPatch(){if(null!==this._patch){this.variablesState.ApplyPatch();for(let[t,e]of this._patch.visitCounts)this.ApplyCountChanges(t,e,!0);for(let[t,e]of this._patch.turnIndices)this.ApplyCountChanges(t,e,!1);this._patch=null}}ApplyCountChanges(t,e,n){(n?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}WriteJson(t){t.WriteObjectStart();let e=!1;for(let n of this._currentChoices){if(null===n.threadAtGeneration)return d("c.threadAtGeneration");n.originalThreadIndex=n.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(n.originalThreadIndex)&&(e||(e=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(n.originalThreadIndex),n.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}if(e&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("callstackThreads",t=>this.callStack.WriteJson(t)),t.WriteProperty("variablesState",t=>this.variablesState.WriteJson(t)),t.WriteProperty("evalStack",t=>B.WriteListRuntimeObjs(t,this.evaluationStack)),t.WriteProperty("outputStream",t=>B.WriteListRuntimeObjs(t,this._outputStream)),t.WriteProperty("currentChoices",t=>{t.WriteArrayStart();for(let e of this._currentChoices)B.WriteChoice(t,e);t.WriteArrayEnd()}),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return d("divertedPointer");t.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}t.WriteProperty("visitCounts",t=>B.WriteIntDictionary(t,this._visitCounts)),t.WriteProperty("turnIndices",t=>B.WriteIntDictionary(t,this._turnIndices)),t.WriteIntProperty("turnIdx",this.currentTurnIndex),t.WriteIntProperty("storySeed",this.storySeed),t.WriteIntProperty("previousRandom",this.previousRandom),t.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),t.WriteIntProperty("inkFormatVersion",X.inkVersionCurrent),t.WriteObjectEnd()}LoadJsonObj(t){let n=t,i=n.inkSaveVersion;if(null==i)throw new y("ink save format incorrect, can't load.");if(parseInt(i)<this.kMinCompatibleLoadVersion)throw new y("Ink save format isn't compatible with the current version (saw '"+i+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(n.callstackThreads,this.story),this.variablesState.SetJsonToken(n.variablesState),this._evaluationStack=B.JArrayToRuntimeObjList(n.evalStack),this._outputStream=B.JArrayToRuntimeObjList(n.outputStream),this.OutputStreamDirty(),this._currentChoices=B.JArrayToRuntimeObjList(n.currentChoices);let r=n.currentDivertTarget;if(null!=r){let t=new e(r.toString());this.divertedPointer=this.story.PointerAtPath(t)}this._visitCounts=B.JObjectToIntDictionary(n.visitCounts),this._turnIndices=B.JObjectToIntDictionary(n.turnIndices),this.currentTurnIndex=parseInt(n.turnIdx),this.storySeed=parseInt(n.storySeed),this.previousRandom=parseInt(n.previousRandom);let s=n.choiceThreads;for(let t of this._currentChoices){let e=this.callStack.ThreadWithIndex(t.originalThreadIndex);if(null!=e)t.threadAtGeneration=e.Copy();else{let e=s[t.originalThreadIndex.toString()];t.threadAtGeneration=new U.Thread(e,this.story)}}}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(t=null){this._outputStream.length=0,null!==t&&this._outputStream.push.apply(this._outputStream,t),this.OutputStreamDirty()}PushToOutputStream(t){let e=s(t,w);if(null!==e){let t=this.TrySplittingHeadTailWhitespace(e);if(null!==t){for(let e of t)this.PushToOutputStreamIndividual(e);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}PopFromOutputStream(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(t){let e=t.value;if(null===e)return d("single.value");let n=-1,i=-1;for(let t=0;t<e.length;++t){let r=e[t];if("\n"!=r){if(" "==r||"\t"==r)continue;break}-1==n&&(n=t),i=t}let r=-1,s=-1;for(let t=0;t<e.length;++t){let n=e[t];if("\n"!=n){if(" "==n||"\t"==n)continue;break}-1==r&&(r=t),s=t}if(-1==n&&-1==r)return null;let a=[],o=0,l=e.length;if(-1!=n){if(n>0){let t=new w(e.substring(0,n));a.push(t)}a.push(new w("\n")),o=i+1}if(-1!=r&&(l=s),l>o){let t=e.substring(o,l-o);a.push(new w(t))}if(-1!=r&&s>i&&(a.push(new w("\n")),r<e.length-1)){let t=e.length-r-1,n=new w(e.substring(r+1,t));a.push(n)}return a}PushToOutputStreamIndividual(t){let e=s(t,I),n=s(t,w),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){let t=-1,e=this.callStack.currentElement;e.type==r.Function&&(t=e.functionStartInOutputStream);let s=-1;for(let e=this._outputStream.length-1;e>=0;e--){let n=this._outputStream[e],i=n instanceof x?n:null;if(null!=(n instanceof I?n:null)){s=e;break}if(null!=i&&i.commandType==x.CommandType.BeginString){e>=t&&(t=-1);break}}let a=-1;if(a=-1!=s&&-1!=t?Math.min(t,s):-1!=s?s:t,-1!=a){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(s>-1&&this.RemoveExistingGlue(),t>-1)){let t=this.callStack.elements;for(let e=t.length-1;e>=0;e--){let n=t[e];if(n.type!=r.Function)break;n.functionStartInOutputStream=-1}}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(null===t)return d("obj");this._outputStream.push(t),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let t=-1,e=this._outputStream.length-1;for(;e>=0;){let n=this._outputStream[e],i=s(n,x),r=s(n,w);if(null!=i||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this._outputStream.length;)s(this._outputStream[e],w)?this._outputStream.splice(e,1):e++;this.OutputStreamDirty()}RemoveExistingGlue(){for(let t=this._outputStream.length-1;t>=0;t--){let e=this._outputStream[t];if(e instanceof I)this._outputStream.splice(t,1);else if(e instanceof x)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(this._outputStream.length>0)for(let t=this._outputStream.length-1;t>=0&&!(this._outputStream[t]instanceof x);t--){let e=this._outputStream[t];if(e instanceof w){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(let t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof w)return!0;return!1}get inStringEvaluation(){for(let t=this._outputStream.length-1;t>=0;t--){let e=s(this._outputStream[t],x);if(e instanceof x&&e.commandType==x.CommandType.BeginString)return!0}return!1}PushEvaluationStack(t){let e=s(t,T);if(e){let t=e.value;if(null===t)return d("rawList");if(null!=t.originNames){t.origins||(t.origins=[]),t.origins.length=0;for(let e of t.originNames){if(null===this.story.listDefinitions)return d("StoryState.story.listDefinitions");let n=this.story.listDefinitions.TryListGetDefinition(e,null);if(null===n.result)return d("StoryState def.result");t.origins.indexOf(n.result)<0&&t.origins.push(n.result)}}}if(null===t)return d("obj");this.evaluationStack.push(t)}PopEvaluationStack(t){if(void 0===t)return l(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return l(this.evaluationStack.splice(this.evaluationStack.length-t,t))}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){this.callStack.Reset(),this._currentChoices.length=0,this.currentPointer=A.Null,this.previousPointer=A.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){n.Assert(this.callStack.currentElement.type==r.Function);let t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(let e=this._outputStream.length-1;e>=t;e--){let t=this._outputStream[e],n=s(t,w),i=s(t,x);if(null!=n){if(i)break;if(!n.isNewline&&!n.isInlineWhitespace)break;this._outputStream.splice(e,1),this.OutputStreamDirty()}}}PopCallStack(t=null){this.callStack.currentElement.type==r.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}SetChosenPath(t,e){this._currentChoices.length=0;let n=this.story.PointerAtPath(t);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,e&&this.currentTurnIndex++}StartFunctionEvaluationFromGame(t,e){this.callStack.Push(r.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=A.StartOf(t),this.PassArgumentsToEvaluationStack(e)}PassArgumentsToEvaluationStack(t){if(null!=t)for(let e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string");this.PushEvaluationStack(v.Create(t[e]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==r.FunctionEvaluationFromGame&&(this.currentPointer=A.Null,this.didSafeExit=!0,!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=r.FunctionEvaluationFromGame)throw new y("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;this.evaluationStack.length>t;){let t=this.PopEvaluationStack();null===e&&(e=t)}if(this.PopCallStack(r.FunctionEvaluationFromGame),e){if(e instanceof L)return null;let t=a(e,v);return t.valueType==i.DivertTarget?t.valueObject.toString():t.valueObject}return null}AddError(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}class ${constructor(){this.startTime=void 0}get ElapsedMilliseconds(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}Start(){this.startTime=(new Date).getTime()}Stop(){this.startTime=void 0}}Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});class X extends p{constructor(){let t;super(),this.inkVersionMinimumCompatible=18,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateSnapshotAtLastNewline=null,this._recursiveContinueCount=0,this._asyncSaving=!1,this._profiler=null;let e=null,n=null;if(arguments[0]instanceof E)t=arguments[0],void 0!==arguments[1]&&(e=arguments[1]),this._mainContentContainer=t;else if("string"==typeof arguments[0]){let t=arguments[0];n=H.TextToDictionary(t)}else n=arguments[0];if(null!=e&&(this._listDefinitions=new D(e)),this._externals=new Map,null!==n){let t=n,e=t.inkVersion;if(null==e)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");let i=parseInt(e);if(i>X.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(i<this.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");i!=X.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");let r,s=t.root;if(null==s)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(r=t.listDefs)&&(this._listDefinitions=B.JTokenToListDefinitions(r)),this._mainContentContainer=a(B.JTokenToRuntimeObject(s),E),this.ResetState()}}get currentChoices(){let t=[];if(null===this._state)return d("this._state");for(let e of this._state.currentChoices)e.isInvisibleDefault||(e.index=t.length,t.push(e));return t}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}ToJson(t){let e=!1;if(t||(e=!0,t=new H.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",X.inkVersionCurrent),t.WriteProperty("root",t=>B.WriteRuntimeContainer(t,this._mainContentContainer)),null!=this._listDefinitions){t.WritePropertyStart("listDefs"),t.WriteObjectStart();for(let e of this._listDefinitions.lists){t.WritePropertyStart(e.name),t.WriteObjectStart();for(let[n,i]of e.items){let e=m.fromSerializedKey(n),r=i;t.WriteIntProperty(e.itemName,r)}t.WriteObjectEnd(),t.WritePropertyEnd()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),e)return t.ToString()}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new z(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(null===this._state)return d("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return d("this._state");this._state.ForceEnd()}ResetGlobals(){if(this._mainContentContainer.namedContent.get("global decl")){let t=this.state.currentPointer.copy();this.ChoosePath(new e("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}ContinueInternal(t=0){null!=this._profiler&&this._profiler.PreContinue();let e=t>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new y("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}let n=new $;n.Start();let i=!1;do{try{i=this.ContinueSingleStep()}catch(t){if(!(t instanceof y))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}if(i)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);n.Stop(),!i&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(r.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(r.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}ContinueSingleStep(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return d("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return d("this.state.currentTags");let t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==X.OutputStateChange.ExtendedBeyondNewline)return this.RestoreStateSnapshot(),!0;t==X.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(t,e,n,i){if(null===t)return d("prevText");if(null===e)return d("currText");let r=e.length>=t.length&&"\n"==e.charAt(t.length-1);if(n==i&&t.length==e.length&&r)return X.OutputStateChange.NoChange;if(!r)return X.OutputStateChange.NewlineRemoved;if(i>n)return X.OutputStateChange.ExtendedBeyondNewline;for(let n=t.length;n<e.length;n++){let t=e.charAt(n);if(" "!=t&&"\t"!=t)return X.OutputStateChange.ExtendedBeyondNewline}return X.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");let t=new f;for(;this.canContinue;)t.Append(this.Continue());return t.toString()}ContentAtPath(t){return this.mainContentContainer.ContentAtPath(t)}KnotContainerWithName(t){let e=this.mainContentContainer.namedContent.get(t);return e instanceof E?e:null}PointerAtPath(t){if(0==t.length)return A.Null;let e=new A,n=t.length,i=null;return null===t.lastComponent?d("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}StateSnapshot(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}RestoreStateSnapshot(){null===this._stateSnapshotAtLastNewline&&d("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}DiscardSnapshot(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}CopyStateForBackgroundThreadSave(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");let t=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,t}BackgroundSaveComplete(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}Step(){let t=!0,e=this.state.currentPointer.copy();if(e.isNull)return;let n=s(e.Resolve(),E);for(;n&&(this.VisitContainer(n,!0),0!=n.content.length);)e=A.StartOf(n),n=s(e.Resolve(),E);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);let i=e.Resolve(),r=this.PerformLogicAndFlowControl(i);if(this.state.currentPointer.isNull)return;r&&(t=!1);let a=s(i,V);if(a){let e=this.ProcessChoice(a);e&&this.state.generatedChoices.push(e),i=null,t=!1}if(i instanceof E&&(t=!1),t){let t=s(i,O);if(t&&-1==t.contextIndex){let e=this.state.callStack.ContextForVariableNamed(t.variableName);i=new O(t.variableName,e)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent();let o=s(i,x);o&&o.commandType==x.CommandType.StartThread&&this.state.callStack.PushThread()}VisitContainer(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}VisitChangedContainersDueToDivert(){let t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(e.isNull||-1==e.index)return;if(this._prevContainers.length=0,!t.isNull){let e=s(t.Resolve(),E)||s(t.container,E);for(;e;)this._prevContainers.push(e),e=s(e.parent,E)}let n=e.Resolve();if(null==n)return;let i=s(n.parent,E);for(;i&&(this._prevContainers.indexOf(i)<0||i.countingAtStartOnly);){let t=i.content.length>0&&n==i.content[0];this.VisitContainer(i,t),n=i,i=s(i.parent,E)}}ProcessChoice(t){let e=!0;if(t.hasCondition){let t=this.state.PopEvaluationStack();this.IsTruthy(t)||(e=!1)}let n="",i="";if(t.hasChoiceOnlyContent&&(i=a(this.state.PopEvaluationStack(),w).value||""),t.hasStartContent&&(n=a(this.state.PopEvaluationStack(),w).value||""),t.onceOnly&&this.state.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;let r=new M;return r.targetPath=t.pathOnChoice,r.sourcePath=t.path.toString(),r.isInvisibleDefault=t.isInvisibleDefault,r.threadAtGeneration=this.state.callStack.ForkThread(),r.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),r}IsTruthy(t){if(t instanceof v){let e=t;if(e instanceof P){let t=e;return this.Error("Shouldn't use a divert target (to "+t.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}PerformLogicAndFlowControl(t){if(null==t)return!1;if(t instanceof k){let e=t;if(e.isConditional){let t=this.state.PopEvaluationStack();if(!this.IsTruthy(t))return!0}if(e.hasVariableTarget){let t=e.variableDivertName,n=this.state.variablesState.GetVariableWithName(t);if(null==n)this.Error("Tried to divert using a target from a variable that could not be found ("+t+")");else if(!(n instanceof P)){let e=s(n,b),i="Tried to divert to a target from a variable, but the variable ("+t+") didn't contain a divert target, it ";e instanceof b&&0==e.value?i+="was empty/null (the value 0).":i+="contained '"+n+"'.",this.Error(i)}let i=a(n,P);this.state.divertedPointer=this.PointerAtPath(i.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof x){let e=t;switch(e.commandType){case x.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case x.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case x.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){let t=this.state.PopEvaluationStack();if(!(t instanceof L)){let e=new w(t.toString());this.state.PushToOutputStream(e)}}break;case x.CommandType.NoOp:break;case x.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case x.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case x.CommandType.PopFunction:case x.CommandType.PopTunnel:let t=e.commandType==x.CommandType.PopFunction?r.Function:r.Tunnel,n=null;if(t==r.Tunnel){let t=this.state.PopEvaluationStack();n=s(t,P),null===n&&this.Assert(t instanceof L,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==t&&this.state.callStack.canPop)this.state.PopCallStack(),n&&(this.state.divertedPointer=this.PointerAtPath(n.targetPath));else{let e=new Map;e.set(r.Function,"function return statement (~ return)"),e.set(r.Tunnel,"tunnel onwards statement (->->)");let n=e.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(n="end of flow (-> END or choice)");let i="Found "+e.get(t)+", when expected "+n;this.Error(i)}break;case x.CommandType.BeginString:this.state.PushToOutputStream(e),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case x.CommandType.EndString:let i=[],o=0;for(let t=this.state.outputStream.length-1;t>=0;--t){let e=this.state.outputStream[t];o++;let n=s(e,x);if(n&&n.commandType==x.CommandType.BeginString)break;e instanceof w&&i.push(e)}this.state.PopFromOutputStream(o),i=i.reverse();let l=new f;for(let t of i)l.Append(t.toString());this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new w(l.toString()));break;case x.CommandType.ChoiceCount:let u=this.state.generatedChoices.length;this.state.PushEvaluationStack(new b(u));break;case x.CommandType.Turns:this.state.PushEvaluationStack(new b(this.state.currentTurnIndex+1));break;case x.CommandType.TurnsSince:case x.CommandType.ReadCount:let h=this.state.PopEvaluationStack();if(!(h instanceof P)){let t="";h instanceof b&&(t=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+h+t);break}let c,p=a(h,P),S=s(this.ContentAtPath(p.targetPath).correctObj,E);null!=S?c=e.commandType==x.CommandType.TurnsSince?this.state.TurnsSinceForContainer(S):this.state.VisitCountForContainer(S):(c=e.commandType==x.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+e.toString()+" lookup at "+p.targetPath.toString())),this.state.PushEvaluationStack(new b(c));break;case x.CommandType.Random:{let t=s(this.state.PopEvaluationStack(),b),e=s(this.state.PopEvaluationStack(),b);if(null==e||e instanceof b==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==t||e instanceof b==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===t.value)return d("maxInt.value");if(null===e.value)return d("minInt.value");let n=t.value-e.value+1;n<=0&&this.Error("RANDOM was called with minimum as "+e.value+" and maximum as "+t.value+". The maximum must be larger");let i=this.state.storySeed+this.state.previousRandom,r=new J(i).next(),a=r%n+e.value;this.state.PushEvaluationStack(new b(a)),this.state.previousRandom=r;break}case x.CommandType.SeedRandom:let C=s(this.state.PopEvaluationStack(),b);if(null==C||C instanceof b==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===C.value)return d("minInt.value");this.state.storySeed=C.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new L);break;case x.CommandType.VisitIndex:let _=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new b(_));break;case x.CommandType.SequenceShuffleIndex:let O=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new b(O));break;case x.CommandType.StartThread:break;case x.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=A.Null);break;case x.CommandType.End:this.state.ForceEnd();break;case x.CommandType.ListFromInt:let N=s(this.state.PopEvaluationStack(),b),I=a(this.state.PopEvaluationStack(),w);if(null===N)throw new y("Passed non-integer when creating a list element from a numerical value.");let k=null;if(null===this.listDefinitions)return d("this.listDefinitions");let V=this.listDefinitions.TryListGetDefinition(I.value,null);if(!V.exists)throw new y("Failed to find LIST called "+I.value);{if(null===N.value)return d("minInt.value");let t=V.result.TryGetItemWithValue(N.value,m.Null);t.exists&&(k=new T(t.result,N.value))}null==k&&(k=new T),this.state.PushEvaluationStack(k);break;case x.CommandType.ListRange:let W=s(this.state.PopEvaluationStack(),v),F=s(this.state.PopEvaluationStack(),v),R=s(this.state.PopEvaluationStack(),T);if(null===R||null===F||null===W)throw new y("Expected list, minimum and maximum for LIST_RANGE");if(null===R.value)return d("targetList.value");let j=R.value.ListWithSubRange(F.valueObject,W.valueObject);this.state.PushEvaluationStack(new T(j));break;case x.CommandType.ListRandom:{let t=this.state.PopEvaluationStack();if(null===t)throw new y("Expected list for LIST_RANDOM");let e=t.value,n=null;if(null===e)throw d("list");if(0==e.Count)n=new g;else{let t=this.state.storySeed+this.state.previousRandom,i=new J(t).next(),r=i%e.Count,s=e.entries();for(let t=0;t<=r-1;t++)s.next();let a=s.next().value,o={Key:m.fromSerializedKey(a[0]),Value:a[1]};if(null===o.Key.originName)return d("randomItem.Key.originName");n=new g(o.Key.originName,this),n.Add(o.Key,o.Value),this.state.previousRandom=i}this.state.PushEvaluationStack(new T(n));break}default:this.Error("unhandled ControlCommand: "+e)}return!0}if(t instanceof F){let e=t,n=this.state.PopEvaluationStack();return this.state.variablesState.Assign(e,n),!0}if(t instanceof W){let e=t,n=null;if(null!=e.pathForCount){let t=e.containerForCount,i=this.state.VisitCountForContainer(t);n=new b(i)}else n=this.state.variablesState.GetVariableWithName(e.name),null==n&&(this.Warning("Variable not found: '"+e.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),n=new b(0));return this.state.PushEvaluationStack(n),!0}if(t instanceof R){let e=t,n=this.state.PopEvaluationStack(e.numberOfParameters),i=e.Call(n);return this.state.PushEvaluationStack(i),!0}return!1}ChoosePathString(t,n=!0,i=[]){if(this.IfAsyncWeCant("call ChoosePathString right now"),n)this.ResetCallstack();else if(this.state.callStack.currentElement.type==r.Function){let e="",n=this.state.callStack.currentElement.currentPointer.container;throw null!=n&&(e="("+n.path.toString()+") "),new Error("Story was running a function "+e+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(i),this.ChoosePath(new e(t))}IfAsyncWeCant(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(t,e=!0){this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(t){t=t;let e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");let n=e[t];return null===n.threadAtGeneration?d("choiceToChoose.threadAtGeneration"):null===n.targetPath?d("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}HasFunction(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}EvaluateFunction(t,e=[],n=!1){if(this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");let i=this.KnotContainerWithName(t);if(null==i)throw new Error("Function doesn't exist: '"+t+"'");let r=[];r.push.apply(r,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);let s=new f;for(;this.canContinue;)s.Append(this.Continue());let a=s.toString();this._state.ResetOutput(r);let o=this.state.CompleteFunctionEvaluationFromGame();return n?{returned:o,output:a}:o}EvaluateExpression(t){let e=this.state.callStack.elements.length;this.state.callStack.Push(r.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();let n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}CallExternalFunction(t,e){if(null===t)return d("funcName");let n=this._externals.get(t),i=null;if(void 0===n){if(this.allowExternalFunctionFallbacks)return i=this.KnotContainerWithName(t),this.Assert(null!==i,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(r.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=A.StartOf(i));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}let s=[];for(let t=0;t<e;++t){let t=a(this.state.PopEvaluationStack(),v).valueObject;s.push(t)}s.reverse();let o=n(s),l=null;null!=o?(l=v.Create(o),this.Assert(null!==l,"Could not create ink value from returned object of type "+typeof o)):l=new L,this.state.PushEvaluationStack(l)}BindExternalFunctionGeneral(t,e){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,e)}TryCoerce(t){return t}BindExternalFunction(t,e){this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,t=>{this.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");let n=[];for(let e=0,i=t.length;e<i;e++)n[e]=this.TryCoerce(t[e]);return e.apply(null,n)})}UnbindExternalFunction(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}ValidateExternalBindings(){let t=null,e=null,n=arguments[1]||new Set;if(arguments[0]instanceof E&&(t=arguments[0]),arguments[0]instanceof p&&(e=arguments[0]),null===t&&null===e)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,0==n.size)this._hasValidatedExternals=!0;else{let t="Error: Missing function binding for external";t+=n.size>1?"s":"",t+=": '",t+=Array.from(n).join("', '"),t+="' ",t+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(t)}else if(null!=t){for(let e of t.content){let t=e;null!=t&&t.hasValidName||this.ValidateExternalBindings(e,n)}for(let[,e]of t.namedContent)this.ValidateExternalBindings(s(e,p),n)}else if(null!=e){let t=s(e,k);if(t&&t.isExternal){let e=t.targetPathString;if(null===e)return d("name");this._externals.has(e)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(e)||n.add(e)}}}ObserveVariable(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new y("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}ObserveVariables(t,e){for(let n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}RemoveVariableObserver(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(void 0!==e){if(this._variableObservers.has(e)){let n=this._variableObservers.get(e);null!==t?n.splice(n.indexOf(t),1):this._variableObservers.delete(e)}}else if(null!==t){let e=this._variableObservers.keys();for(let n of e){let e=this._variableObservers.get(n);e.splice(e.indexOf(t),1)}}}VariableStateDidChangeEvent(t,e){if(null===this._variableObservers)return;let n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof v))throw new Error("Tried to get the value of a variable that isn't a standard type");let i=a(e,v);for(let e of n)e(t,i.valueObject)}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}TagsAtStartOfFlowContainerWithPathString(t){let n=new e(t),i=this.ContentAtPath(n).container;if(null===i)return d("flowContainer");for(;;){let t=i.content[0];if(!(t instanceof E))break;i=t}let r=null;for(let t of i.content){let e=s(t,j);if(!e)break;null==r&&(r=[]),r.push(e.text)}return r}BuildStringOfHierarchy(){let t=new f;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}BuildStringOfContainer(t){let e=new f;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=A.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){let t=!1;this.state.callStack.CanPop(r.Function)?(this.state.PopCallStack(r.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new L),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return d("pointer.container");for(;e.index>=e.container.content.length;){t=!1;let n=s(e.container.parent,E);if(n instanceof E==0)break;let i=n.content.indexOf(e.container);if(-1==i)break;if(e=new A(n,i),e.index++,t=!0,null===e.container)return d("pointer.container")}return t||(e=A.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){let t=this._state.currentChoices,e=t.filter(t=>t.isInvisibleDefault);if(0==e.length||t.length>e.length)return!1;let n=e[0];return null===n.targetPath?d("choice.targetPath"):null===n.threadAtGeneration?d("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.targetPath,!1),!0)}NextSequenceShuffleIndex(){let t=s(this.state.PopEvaluationStack(),b);if(!(t instanceof b))return this.Error("expected number of elements in sequence for shuffle index"),0;let e=this.state.currentPointer.container;if(null===e)return d("seqContainer");if(null===t.value)return d("numElementsIntVal.value");let n=t.value,i=a(this.state.PopEvaluationStack(),b).value;if(null===i)return d("seqCount");let r=i/n,o=i%n,l=e.path.toString(),u=0;for(let t=0,e=l.length;t<e;t++)u+=l.charCodeAt(t)||0;let h=u+r+this.state.storySeed,c=new J(Math.floor(h)),p=[];for(let t=0;t<n;++t)p.push(t);for(let t=0;t<=o;++t){let e=c.next()%p.length,n=p[e];if(p.splice(e,1),t==o)return n}throw new Error("Should never reach here")}Error(t,e=!1){let n=new y(t);throw n.useEndLineNumber=e,n}Warning(t){this.AddError(t,!0)}AddError(t,e=!1,n=!1){let i=this.currentDebugMetadata,r=e?"WARNING":"ERROR";if(null!=i){let e=n?i.endLineNumber:i.startLineNumber;t="RUNTIME "+r+": '"+i.fileName+"' line "+e+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}Assert(t,e=null){if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let n=this.state.callStack.elements.length-1;n>=0;--n)if(e=this.state.callStack.elements[n].currentPointer,!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let e=this.state.outputStream.length-1;e>=0;--e)if(t=this.state.outputStream[e].debugMetadata,null!==t)return t;return null}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}X.inkVersionCurrent=19,function(t){let e;!function(t){t[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"}(e=t.OutputStateChange||(t.OutputStateChange={}))}(X||(X={})),t.InkList=g,t.Story=X,Object.defineProperty(t,"__esModule",{value:!0})}(e)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SearchResult=void 0;const i=n(12);class r{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof i.Container?this.obj:null}copy(){let t=new r;return t.obj=this.obj,t.approximate=this.approximate,t}}e.SearchResult=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ListDefinition=void 0;const i=n(8);e.ListDefinition=class{constructor(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}get name(){return this._name}get items(){if(null==this._items){this._items=new Map;for(let[t,e]of this._itemNameToValues){let n=new i.InkListItem(this.name,t);this._items.set(n.serialized(),e)}}return this._items}ValueForItem(t){if(!t.itemName)return 0;let e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}ContainsItem(t){return!!t.itemName&&(t.originName==this.name&&this._itemNameToValues.has(t.itemName))}ContainsItemWithName(t){return this._itemNameToValues.has(t)}TryGetItemWithValue(t,e){for(let[e,n]of this._itemNameToValues)if(n==t)return{result:new i.InkListItem(this.name,e),exists:!0};return{result:i.InkListItem.Null,exists:!1}}TryGetValueForItem(t,e){if(!t.itemName)return{result:0,exists:!1};let n=this._itemNameToValues.get(t.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.StoryState=void 0;const i=n(38),r=n(39),s=n(6),a=n(14),o=n(21),l=n(22),u=n(4),h=n(20),c=n(11),d=n(10),p=n(16),f=n(30),m=n(18),g=n(17),y=n(13),S=n(7),C=n(15),v=n(2),b=n(19),_=n(40),w=n(31);class P{constructor(t){this.kInkSaveStateVersion=8,this.kMinCompatibleLoadVersion=8,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=g.Pointer.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this.story=t,this._outputStream=[],this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new i.CallStack(t),this._variablesState=new r.VariablesState(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;let e=(new Date).getTime();this.storySeed=new f.PRNG(e).next()%100,this.previousRandom=0,this._currentChoices=[],this.GoToStart()}ToJson(t=!1){let e=new w.SimpleJson.Writer;return this.WriteJson(e),e.ToString()}toJson(t=!1){return this.ToJson(t)}LoadJson(t){let e=w.SimpleJson.TextToDictionary(t);this.LoadJsonObj(e)}VisitCountAtPathString(t){let e;if(null!==this._patch){let n=this.story.ContentAtPath(new u.Path(t)).container;if(null===n)throw new Error("Content at path not found: "+t);if(e=this._patch.TryGetVisitCount(n,0),e.exists)return e.result}return e=y.tryGetValueFromMap(this._visitCounts,t,null),e.exists?e.result:0}VisitCountForContainer(t){if(null===t)return v.throwNullException("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){let e=this._patch.TryGetVisitCount(t,0);if(e.exists)return e.result}let e=t.path.toString(),n=y.tryGetValueFromMap(this._visitCounts,e,null);return n.exists?n.result:0}IncrementVisitCountForContainer(t){if(null!==this._patch){let e=this.VisitCountForContainer(t);return e++,void this._patch.SetVisitCount(t,e)}let e=t.path.toString(),n=y.tryGetValueFromMap(this._visitCounts,e,null);n.exists?this._visitCounts.set(e,n.result+1):this._visitCounts.set(e,1)}RecordTurnIndexVisitToContainer(t){if(null!==this._patch)return void this._patch.SetTurnIndex(t,this.currentTurnIndex);let e=t.path.toString();this._turnIndices.set(e,this.currentTurnIndex)}TurnsSinceForContainer(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){let e=this._patch.TryGetTurnIndex(t,0);if(e.exists)return this.currentTurnIndex-e.result}let e=t.path.toString(),n=y.tryGetValueFromMap(this._turnIndices,e,0);return n.exists?this.currentTurnIndex-n.result:-1}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._outputStream}get currentChoices(){return this.canContinue?[]:this._currentChoices}get generatedChoices(){return this._currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}set variablesState(t){this._variablesState=t}get evaluationStack(){return this._evaluationStack}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}get currentTurnIndex(){return this._currentTurnIndex}set currentTurnIndex(t){this._currentTurnIndex=t}get currentPathString(){let t=this.currentPointer;return t.isNull?null:null===t.path?v.throwNullException("pointer.path"):t.path.toString()}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(t){this.callStack.currentElement.currentPointer=t.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(t){this.callStack.currentThread.previousPointer=t.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return null!=this.currentErrors&&this.currentErrors.length>0}get hasWarning(){return null!=this.currentWarnings&&this.currentWarnings.length>0}get currentText(){if(this._outputStreamTextDirty){let t=new d.StringBuilder;for(let e of this._outputStream){let n=S.asOrNull(e,s.StringValue);null!==n&&t.Append(n.value)}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(t){let e=new d.StringBuilder,n=-1,i=0;for(let r=0;r<t.length;r++){let s=t.charAt(r),a=" "==s||"\t"==s;a&&-1==n&&(n=r),a||("\n"!=s&&n>0&&n!=i&&e.Append(" "),n=-1),"\n"==s&&(i=r+1),a||e.Append(s)}return e.toString()}get currentTags(){if(this._outputStreamTagsDirty){this._currentTags=[];for(let t of this._outputStream){let e=S.asOrNull(t,o.Tag);null!==e&&this._currentTags.push(e.text)}this._outputStreamTagsDirty=!1}return this._currentTags}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(t){this.callStack.currentElement.inExpressionEvaluation=t}GoToStart(){this.callStack.currentElement.currentPointer=g.Pointer.StartOf(this.story.mainContentContainer)}CopyAndStartPatching(){let t=new P(this.story);return t._patch=new _.StatePatch(this._patch),t.outputStream.push.apply(t.outputStream,this._outputStream),t.OutputStreamDirty(),t._currentChoices.push.apply(t._currentChoices,this._currentChoices),this.hasError&&(t._currentErrors=[],t._currentErrors.push.apply(t._currentErrors,this.currentErrors||[])),this.hasWarning&&(t._currentWarnings=[],t._currentWarnings.push.apply(t._currentWarnings,this.currentWarnings||[])),t.callStack=new i.CallStack(this.callStack),t.variablesState=this.variablesState,t.variablesState.callStack=t.callStack,t.variablesState.patch=t._patch,t.evaluationStack.push.apply(t.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(t.divertedPointer=this.divertedPointer.copy()),t.previousPointer=this.previousPointer.copy(),t._visitCounts=this._visitCounts,t._turnIndices=this._turnIndices,t.currentTurnIndex=this.currentTurnIndex,t.storySeed=this.storySeed,t.previousRandom=this.previousRandom,t.didSafeExit=this.didSafeExit,t}RestoreAfterPatch(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}ApplyAnyPatch(){if(null!==this._patch){this.variablesState.ApplyPatch();for(let[t,e]of this._patch.visitCounts)this.ApplyCountChanges(t,e,!0);for(let[t,e]of this._patch.turnIndices)this.ApplyCountChanges(t,e,!1);this._patch=null}}ApplyCountChanges(t,e,n){(n?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}WriteJson(t){t.WriteObjectStart();let e=!1;for(let n of this._currentChoices){if(null===n.threadAtGeneration)return v.throwNullException("c.threadAtGeneration");n.originalThreadIndex=n.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(n.originalThreadIndex)&&(e||(e=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(n.originalThreadIndex),n.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}if(e&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("callstackThreads",t=>this.callStack.WriteJson(t)),t.WriteProperty("variablesState",t=>this.variablesState.WriteJson(t)),t.WriteProperty("evalStack",t=>p.JsonSerialisation.WriteListRuntimeObjs(t,this.evaluationStack)),t.WriteProperty("outputStream",t=>p.JsonSerialisation.WriteListRuntimeObjs(t,this._outputStream)),t.WriteProperty("currentChoices",t=>{t.WriteArrayStart();for(let e of this._currentChoices)p.JsonSerialisation.WriteChoice(t,e);t.WriteArrayEnd()}),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return v.throwNullException("divertedPointer");t.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}t.WriteProperty("visitCounts",t=>p.JsonSerialisation.WriteIntDictionary(t,this._visitCounts)),t.WriteProperty("turnIndices",t=>p.JsonSerialisation.WriteIntDictionary(t,this._turnIndices)),t.WriteIntProperty("turnIdx",this.currentTurnIndex),t.WriteIntProperty("storySeed",this.storySeed),t.WriteIntProperty("previousRandom",this.previousRandom),t.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),t.WriteIntProperty("inkFormatVersion",b.Story.inkVersionCurrent),t.WriteObjectEnd()}LoadJsonObj(t){let e=t,n=e.inkSaveVersion;if(null==n)throw new c.StoryException("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new c.StoryException("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(e.callstackThreads,this.story),this.variablesState.SetJsonToken(e.variablesState),this._evaluationStack=p.JsonSerialisation.JArrayToRuntimeObjList(e.evalStack),this._outputStream=p.JsonSerialisation.JArrayToRuntimeObjList(e.outputStream),this.OutputStreamDirty(),this._currentChoices=p.JsonSerialisation.JArrayToRuntimeObjList(e.currentChoices);let r=e.currentDivertTarget;if(null!=r){let t=new u.Path(r.toString());this.divertedPointer=this.story.PointerAtPath(t)}this._visitCounts=p.JsonSerialisation.JObjectToIntDictionary(e.visitCounts),this._turnIndices=p.JsonSerialisation.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom);let s=e.choiceThreads;for(let t of this._currentChoices){let e=this.callStack.ThreadWithIndex(t.originalThreadIndex);if(null!=e)t.threadAtGeneration=e.Copy();else{let e=s[t.originalThreadIndex.toString()];t.threadAtGeneration=new i.CallStack.Thread(e,this.story)}}}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(t=null){this._outputStream.length=0,null!==t&&this._outputStream.push.apply(this._outputStream,t),this.OutputStreamDirty()}PushToOutputStream(t){let e=S.asOrNull(t,s.StringValue);if(null!==e){let t=this.TrySplittingHeadTailWhitespace(e);if(null!==t){for(let e of t)this.PushToOutputStreamIndividual(e);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}PopFromOutputStream(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(t){let e=t.value;if(null===e)return v.throwNullException("single.value");let n=-1,i=-1;for(let t=0;t<e.length;++t){let r=e[t];if("\n"!=r){if(" "==r||"\t"==r)continue;break}-1==n&&(n=t),i=t}let r=-1,a=-1;for(let t=0;t<e.length;++t){let n=e[t];if("\n"!=n){if(" "==n||"\t"==n)continue;break}-1==r&&(r=t),a=t}if(-1==n&&-1==r)return null;let o=[],l=0,u=e.length;if(-1!=n){if(n>0){let t=new s.StringValue(e.substring(0,n));o.push(t)}o.push(new s.StringValue("\n")),l=i+1}if(-1!=r&&(u=a),u>l){let t=e.substring(l,u-l);o.push(new s.StringValue(t))}if(-1!=r&&a>i&&(o.push(new s.StringValue("\n")),r<e.length-1)){let t=e.length-r-1,n=new s.StringValue(e.substring(r+1,t));o.push(n)}return o}PushToOutputStreamIndividual(t){let e=S.asOrNull(t,l.Glue),n=S.asOrNull(t,s.StringValue),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){let t=-1,e=this.callStack.currentElement;e.type==a.PushPopType.Function&&(t=e.functionStartInOutputStream);let r=-1;for(let e=this._outputStream.length-1;e>=0;e--){let n=this._outputStream[e],i=n instanceof h.ControlCommand?n:null;if(null!=(n instanceof l.Glue?n:null)){r=e;break}if(null!=i&&i.commandType==h.ControlCommand.CommandType.BeginString){e>=t&&(t=-1);break}}let s=-1;if(s=-1!=r&&-1!=t?Math.min(t,r):-1!=r?r:t,-1!=s){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(r>-1&&this.RemoveExistingGlue(),t>-1)){let t=this.callStack.elements;for(let e=t.length-1;e>=0;e--){let n=t[e];if(n.type!=a.PushPopType.Function)break;n.functionStartInOutputStream=-1}}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(null===t)return v.throwNullException("obj");this._outputStream.push(t),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let t=-1,e=this._outputStream.length-1;for(;e>=0;){let n=this._outputStream[e],i=S.asOrNull(n,h.ControlCommand),r=S.asOrNull(n,s.StringValue);if(null!=i||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this._outputStream.length;){S.asOrNull(this._outputStream[e],s.StringValue)?this._outputStream.splice(e,1):e++}this.OutputStreamDirty()}RemoveExistingGlue(){for(let t=this._outputStream.length-1;t>=0;t--){let e=this._outputStream[t];if(e instanceof l.Glue)this._outputStream.splice(t,1);else if(e instanceof h.ControlCommand)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(this._outputStream.length>0)for(let t=this._outputStream.length-1;t>=0;t--){if(this._outputStream[t]instanceof h.ControlCommand)break;let e=this._outputStream[t];if(e instanceof s.StringValue){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(let t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof s.StringValue)return!0;return!1}get inStringEvaluation(){for(let t=this._outputStream.length-1;t>=0;t--){let e=S.asOrNull(this._outputStream[t],h.ControlCommand);if(e instanceof h.ControlCommand&&e.commandType==h.ControlCommand.CommandType.BeginString)return!0}return!1}PushEvaluationStack(t){let e=S.asOrNull(t,s.ListValue);if(e){let t=e.value;if(null===t)return v.throwNullException("rawList");if(null!=t.originNames){t.origins||(t.origins=[]),t.origins.length=0;for(let e of t.originNames){if(null===this.story.listDefinitions)return v.throwNullException("StoryState.story.listDefinitions");let n=this.story.listDefinitions.TryListGetDefinition(e,null);if(null===n.result)return v.throwNullException("StoryState def.result");t.origins.indexOf(n.result)<0&&t.origins.push(n.result)}}}if(null===t)return v.throwNullException("obj");this.evaluationStack.push(t)}PopEvaluationStack(t){if(void 0===t){let t=this.evaluationStack.pop();return S.nullIfUndefined(t)}{if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");let e=this.evaluationStack.splice(this.evaluationStack.length-t,t);return S.nullIfUndefined(e)}}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){this.callStack.Reset(),this._currentChoices.length=0,this.currentPointer=g.Pointer.Null,this.previousPointer=g.Pointer.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){C.Debug.Assert(this.callStack.currentElement.type==a.PushPopType.Function);let t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(let e=this._outputStream.length-1;e>=t;e--){let t=this._outputStream[e],n=S.asOrNull(t,s.StringValue),i=S.asOrNull(t,h.ControlCommand);if(null!=n){if(i)break;if(!n.isNewline&&!n.isInlineWhitespace)break;this._outputStream.splice(e,1),this.OutputStreamDirty()}}}PopCallStack(t=null){this.callStack.currentElement.type==a.PushPopType.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}SetChosenPath(t,e){this._currentChoices.length=0;let n=this.story.PointerAtPath(t);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,e&&this.currentTurnIndex++}StartFunctionEvaluationFromGame(t,e){this.callStack.Push(a.PushPopType.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=g.Pointer.StartOf(t),this.PassArgumentsToEvaluationStack(e)}PassArgumentsToEvaluationStack(t){if(null!=t)for(let e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string");this.PushEvaluationStack(s.Value.Create(t[e]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==a.PushPopType.FunctionEvaluationFromGame&&(this.currentPointer=g.Pointer.Null,this.didSafeExit=!0,!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=a.PushPopType.FunctionEvaluationFromGame)throw new c.StoryException("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;this.evaluationStack.length>t;){let t=this.PopEvaluationStack();null===e&&(e=t)}if(this.PopCallStack(a.PushPopType.FunctionEvaluationFromGame),e){if(e instanceof m.Void)return null;let t=S.asOrThrows(e,s.Value);return t.valueType==s.ValueType.DivertTarget?t.valueObject.toString():t.valueObject}return null}AddError(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}e.StoryState=P},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CallStack=void 0;const i=n(14),r=n(4),s=n(19),a=n(11),o=n(16),l=n(6),u=n(10),h=n(17),c=n(15),d=n(13),p=n(2);class f{constructor(){if(this._threadCounter=0,this._startOfRoot=h.Pointer.Null,arguments[0]instanceof s.Story){let t=arguments[0];this._startOfRoot=h.Pointer.StartOf(t.rootContentContainer),this.Reset()}else{let t=arguments[0];this._threads=[];for(let e of t._threads)this._threads.push(e.Copy());this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot}}get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){let t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(t){c.Debug.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}get canPop(){return this.callStack.length>1}Reset(){this._threads=[],this._threads.push(new f.Thread),this._threads[0].callstack.push(new f.Element(i.PushPopType.Tunnel,this._startOfRoot))}SetJsonToken(t,e){this._threads.length=0;let n=t.threads;for(let t of n){let n=t,i=new f.Thread(n,e);this._threads.push(i)}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=h.Pointer.StartOf(e.rootContentContainer)}WriteJson(t){t.WriteObject(t=>{t.WritePropertyStart("threads"),t.WriteArrayStart();for(let e of this._threads)e.WriteJson(t);t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(this._threadCounter),t.WritePropertyEnd()})}PushThread(){let t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}ForkThread(){let t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}PopThread(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==i.PushPopType.FunctionEvaluationFromGame}Push(t,e=0,n=0){let i=new f.Element(t,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=e,i.functionStartInOutputStream=n,this.callStack.push(i)}CanPop(t=null){return!!this.canPop&&(null==t||this.currentElement.type==t)}Pop(t=null){if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(t,e=-1){-1==e&&(e=this.currentElementIndex+1);let n=this.callStack[e-1],i=d.tryGetValueFromMap(n.temporaryVariables,t,null);return i.exists?i.result:null}SetTemporaryVariable(t,e,n,i=-1){-1==i&&(i=this.currentElementIndex+1);let r=this.callStack[i-1];if(!n&&!r.temporaryVariables.get(t))throw new a.StoryException("Could not find temporary variable to set: "+t);let s=d.tryGetValueFromMap(r.temporaryVariables,t,null);s.exists&&l.ListValue.RetainListOriginsForAssignment(s.result,e),r.temporaryVariables.set(t,e)}ContextForVariableNamed(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}ThreadWithIndex(t){let e=this._threads.filter(e=>{if(e.threadIndex==t)return e});return e.length>0?e[0]:null}get callStack(){return this.currentThread.callstack}get callStackTrace(){let t=new u.StringBuilder;for(let e=0;e<this._threads.length;e++){let n=this._threads[e],r=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,r?"(current) ":"");for(let e=0;e<n.callstack.length;e++){n.callstack[e].type==i.PushPopType.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");let r=n.callstack[e].currentPointer;if(!r.isNull){if(t.Append("<SOMEWHERE IN "),null===r.container)return p.throwNullException("pointer.container");t.Append(r.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}e.CallStack=f,function(t){class e{constructor(t,e,n=!1){this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=e.copy(),this.inExpressionEvaluation=n,this.temporaryVariables=new Map,this.type=t}Copy(){let t=new e(this.type,this.currentPointer,this.inExpressionEvaluation);return t.temporaryVariables=new Map(this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOutputStream=this.functionStartInOutputStream,t}}t.Element=e;class n{constructor(){if(this.threadIndex=0,this.previousPointer=h.Pointer.Null,this.callstack=[],arguments[0]&&arguments[1]){let t=arguments[0],n=arguments[1];this.threadIndex=parseInt(t.threadIndex);let i=t.callstack;for(let t of i){let i,s=t,a=parseInt(s.type),l=h.Pointer.Null,u=s.cPath;if(void 0!==u){i=u.toString();let t=n.ContentAtPath(new r.Path(i));if(l.container=t.container,l.index=parseInt(s.idx),null==t.obj)throw new Error("When loading state, internal story location couldn't be found: "+i+". Has the story changed since this save data was created?");if(t.approximate){if(null===l.container)return p.throwNullException("pointer.container");n.Warning("When loading state, exact internal story location couldn't be found: '"+i+"', so it was approximated to '"+l.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}let c=!!s.exp,d=new e(a,l,c),f=s.temp;void 0!==f?d.temporaryVariables=o.JsonSerialisation.JObjectToDictionaryRuntimeObjs(f):d.temporaryVariables.clear(),this.callstack.push(d)}let s=t.previousContentObject;if(void 0!==s){let t=new r.Path(s.toString());this.previousPointer=n.PointerAtPath(t)}}}Copy(){let t=new n;t.threadIndex=this.threadIndex;for(let e of this.callstack)t.callstack.push(e.Copy());return t.previousPointer=this.previousPointer.copy(),t}WriteJson(t){t.WriteObjectStart(),t.WritePropertyStart("callstack"),t.WriteArrayStart();for(let e of this.callstack){if(t.WriteObjectStart(),!e.currentPointer.isNull){if(null===e.currentPointer.container)return p.throwNullException("el.currentPointer.container");t.WriteProperty("cPath",e.currentPointer.container.path.componentsString),t.WriteIntProperty("idx",e.currentPointer.index)}t.WriteProperty("exp",e.inExpressionEvaluation),t.WriteIntProperty("type",e.type),e.temporaryVariables.size>0&&(t.WritePropertyStart("temp"),o.JsonSerialisation.WriteDictionaryRuntimeObjs(t,e.temporaryVariables),t.WritePropertyEnd()),t.WriteObjectEnd()}if(t.WriteArrayEnd(),t.WritePropertyEnd(),t.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){let e=this.previousPointer.Resolve();if(null===e)return p.throwNullException("this.previousPointer.Resolve()");t.WriteProperty("previousContentObject",e.path.toString())}t.WriteObjectEnd()}}t.Thread=n}(f=e.CallStack||(e.CallStack={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.VariablesState=void 0;const i=n(6),r=n(11),s=n(16),a=n(7),o=n(13),l=n(2);class u{constructor(t,e){this.variableChangedEventCallbacks=[],this.patch=null,this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:(t,e)=>e in t?t[e]:t.$(e),set:(t,e,n)=>(e in t?t[e]=n:t.$(e,n),!0)})}catch(t){}}variableChangedEvent(t,e){for(let n of this.variableChangedEventCallbacks)n(t,e)}get batchObservingVariableChanges(){return this._batchObservingVariableChanges}set batchObservingVariableChanges(t){if(this._batchObservingVariableChanges=t,t)this._changedVariablesForBatchObs=new Set;else if(null!=this._changedVariablesForBatchObs){for(let t of this._changedVariablesForBatchObs){let e=this._globalVariables.get(t);e?this.variableChangedEvent(t,e):l.throwNullException("currentValue")}this._changedVariablesForBatchObs=null}}get callStack(){return this._callStack}set callStack(t){this._callStack=t}$(t,e){if(void 0===e){let e=null;return null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists)?e.result.valueObject:(e=this._globalVariables.get(t),void 0===e&&(e=this._defaultGlobalVariables.get(t)),void 0!==e?e.valueObject:null)}{if(void 0===this._defaultGlobalVariables.get(t))throw new r.StoryException("Cannot assign to a variable ("+t+") that hasn't been declared in the story");let n=i.Value.Create(e);if(null==n)throw null==e?new r.StoryException("Cannot pass null to VariableState"):new r.StoryException("Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,n)}}ApplyPatch(){if(null===this.patch)return l.throwNullException("this.patch");for(let[t,e]of this.patch.globals)this._globalVariables.set(t,e);if(null!==this._changedVariablesForBatchObs)for(let t of this.patch.changedVariables)this._changedVariablesForBatchObs.add(t);this.patch=null}SetJsonToken(t){this._globalVariables.clear();for(let[e,n]of this._defaultGlobalVariables){let i=t[e];if(void 0!==i){let t=s.JsonSerialisation.JTokenToRuntimeObject(i);if(null===t)return l.throwNullException("tokenInkObject");this._globalVariables.set(e,t)}else this._globalVariables.set(e,n)}}WriteJson(t){t.WriteObjectStart();for(let[e,n]of this._globalVariables){let i=e,r=n;if(u.dontSaveDefaultValues&&this._defaultGlobalVariables.has(i)){let t=this._defaultGlobalVariables.get(i);if(this.RuntimeObjectsEqual(r,t))continue}t.WritePropertyStart(i),s.JsonSerialisation.WriteRuntimeObject(t,r),t.WritePropertyEnd()}t.WriteObjectEnd()}RuntimeObjectsEqual(t,e){if(null===t)return l.throwNullException("obj1");if(null===e)return l.throwNullException("obj2");if(t.constructor!==e.constructor)return!1;let n=a.asOrNull(t,i.IntValue);if(null!==n)return n.value===a.asOrThrows(e,i.IntValue).value;let r=a.asOrNull(t,i.FloatValue);if(null!==r)return r.value===a.asOrThrows(e,i.FloatValue).value;let s=a.asOrNull(t,i.Value),o=a.asOrNull(e,i.Value);if(null!==s&&null!==o)return a.isEquatable(s.valueObject)&&a.isEquatable(o.valueObject)?s.valueObject.Equals(o.valueObject):s.valueObject===o.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}GetVariableWithName(t,e=-1){let n=this.GetRawVariableWithName(t,e),r=a.asOrNull(n,i.VariablePointerValue);return null!==r&&(n=this.ValueAtVariablePointer(r)),n}TryGetDefaultVariableValue(t){let e=o.tryGetValueFromMap(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}GlobalVariableExistsWithName(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}GetRawVariableWithName(t,e){let n=null;if(0==e||-1==e){let e=null;if(null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists))return e.result;if(e=o.tryGetValueFromMap(this._globalVariables,t,null),e.exists)return e.result;if(null!==this._defaultGlobalVariables&&(e=o.tryGetValueFromMap(this._defaultGlobalVariables,t,null),e.exists))return e.result;if(null===this._listDefsOrigin)return l.throwNullException("VariablesState._listDefsOrigin");let n=this._listDefsOrigin.FindSingleItemListWithName(t);if(n)return n}return n=this._callStack.GetTemporaryVariableWithName(t,e),n}ValueAtVariablePointer(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}Assign(t,e){let n=t.variableName;if(null===n)return l.throwNullException("name");let r=-1,s=!1;if(s=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(n),t.isNewDeclaration){let t=a.asOrNull(e,i.VariablePointerValue);if(null!==t){e=this.ResolveVariablePointer(t)}}else{let t=null;do{t=a.asOrNull(this.GetRawVariableWithName(n,r),i.VariablePointerValue),null!=t&&(n=t.variableName,r=t.contextIndex,s=0==r)}while(null!=t)}s?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,r)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(t,e){let n=a.asOrThrows(t,i.ListValue),r=a.asOrThrows(e,i.ListValue);n.value&&r.value&&0==r.value.Count&&r.value.SetInitialOriginNames(n.value.originNames)}SetGlobal(t,e){let n=null;if(null===this.patch&&(n=o.tryGetValueFromMap(this._globalVariables,t,null)),null!==this.patch&&(n=this.patch.TryGetGlobal(t,null),n.exists||(n=o.tryGetValueFromMap(this._globalVariables,t,null))),i.ListValue.RetainListOriginsForAssignment(n.result,e),null===t)return l.throwNullException("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==n&&e!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return l.throwNullException("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}ResolveVariablePointer(t){let e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));let n=this.GetRawVariableWithName(t.variableName,e),r=a.asOrNull(n,i.VariablePointerValue);return null!=r?r:new i.VariablePointerValue(t.variableName,e)}GetContextIndexOfVariableNamed(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}ObserveVariableChange(t){this.variableChangedEventCallbacks.push(t)}}e.VariablesState=u,u.dontSaveDefaultValues=!0},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.StatePatch=void 0;e.StatePatch=class{constructor(){if(this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]){let t=arguments[0];this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}get globals(){return this._globals}get changedVariables(){return this._changedVariables}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}TryGetGlobal(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}SetGlobal(t,e){this._globals.set(t,e)}AddChangedVariable(t){return this._changedVariables.add(t)}TryGetVisitCount(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}SetVisitCount(t,e){this._visitCounts.set(t,e)}SetTurnIndex(t,e){this._turnIndices.set(t,e)}TryGetTurnIndex(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Stopwatch=void 0;e.Stopwatch=class{constructor(){this.startTime=void 0}get ElapsedMilliseconds(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}Start(){this.startTime=(new Date).getTime()}Stop(){this.startTime=void 0}}},function(t,e,n){"use strict";t.exports=n(43)},function(t,e,n){"use strict";var i=e;function r(){i.util._configure(),i.Writer._configure(i.BufferWriter),i.Reader._configure(i.BufferReader)}i.build="minimal",i.Writer=n(32),i.BufferWriter=n(53),i.Reader=n(33),i.BufferReader=n(54),i.util=n(9),i.rpc=n(55),i.roots=n(57),i.configure=r,r()},function(t,e){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e,n){"use strict";t.exports=function(t,e){var n=new Array(arguments.length-1),i=0,r=2,s=!0;for(;r<arguments.length;)n[i++]=arguments[r++];return new Promise((function(r,a){n[i]=function(t){if(s)if(s=!1,t)a(t);else{for(var e=new Array(arguments.length-1),n=0;n<e.length;)e[n++]=arguments[n];r.apply(null,e)}};try{t.apply(e||null,n)}catch(t){s&&(s=!1,a(t))}}))}},function(t,e,n){"use strict";var i=e;i.length=function(t){var e=t.length;if(!e)return 0;for(var n=0;--e%4>1&&"="===t.charAt(e);)++n;return Math.ceil(3*t.length)/4-n};for(var r=new Array(64),s=new Array(123),a=0;a<64;)s[r[a]=a<26?a+65:a<52?a+71:a<62?a-4:a-59|43]=a++;i.encode=function(t,e,n){for(var i,s=null,a=[],o=0,l=0;e<n;){var u=t[e++];switch(l){case 0:a[o++]=r[u>>2],i=(3&u)<<4,l=1;break;case 1:a[o++]=r[i|u>>4],i=(15&u)<<2,l=2;break;case 2:a[o++]=r[i|u>>6],a[o++]=r[63&u],l=0}o>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,a)),o=0)}return l&&(a[o++]=r[i],a[o++]=61,1===l&&(a[o++]=61)),s?(o&&s.push(String.fromCharCode.apply(String,a.slice(0,o))),s.join("")):String.fromCharCode.apply(String,a.slice(0,o))};i.decode=function(t,e,n){for(var i,r=n,a=0,o=0;o<t.length;){var l=t.charCodeAt(o++);if(61===l&&a>1)break;if(void 0===(l=s[l]))throw Error("invalid encoding");switch(a){case 0:i=l,a=1;break;case 1:e[n++]=i<<2|(48&l)>>4,i=l,a=2;break;case 2:e[n++]=(15&i)<<4|(60&l)>>2,i=l,a=3;break;case 3:e[n++]=(3&i)<<6|l,a=0}}if(1===a)throw Error("invalid encoding");return n-r},i.test=function(t){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(t)}},function(t,e,n){"use strict";function i(){this._listeners={}}t.exports=i,i.prototype.on=function(t,e,n){return(this._listeners[t]||(this._listeners[t]=[])).push({fn:e,ctx:n||this}),this},i.prototype.off=function(t,e){if(void 0===t)this._listeners={};else if(void 0===e)this._listeners[t]=[];else for(var n=this._listeners[t],i=0;i<n.length;)n[i].fn===e?n.splice(i,1):++i;return this},i.prototype.emit=function(t){var e=this._listeners[t];if(e){for(var n=[],i=1;i<arguments.length;)n.push(arguments[i++]);for(i=0;i<e.length;)e[i].fn.apply(e[i++].ctx,n)}return this}},function(t,e,n){"use strict";function i(t){return"undefined"!=typeof Float32Array?function(){var e=new Float32Array([-0]),n=new Uint8Array(e.buffer),i=128===n[3];function r(t,i,r){e[0]=t,i[r]=n[0],i[r+1]=n[1],i[r+2]=n[2],i[r+3]=n[3]}function s(t,i,r){e[0]=t,i[r]=n[3],i[r+1]=n[2],i[r+2]=n[1],i[r+3]=n[0]}function a(t,i){return n[0]=t[i],n[1]=t[i+1],n[2]=t[i+2],n[3]=t[i+3],e[0]}function o(t,i){return n[3]=t[i],n[2]=t[i+1],n[1]=t[i+2],n[0]=t[i+3],e[0]}t.writeFloatLE=i?r:s,t.writeFloatBE=i?s:r,t.readFloatLE=i?a:o,t.readFloatBE=i?o:a}():function(){function e(t,e,n,i){var r=e<0?1:0;if(r&&(e=-e),0===e)t(1/e>0?0:2147483648,n,i);else if(isNaN(e))t(2143289344,n,i);else if(e>34028234663852886e22)t((r<<31|2139095040)>>>0,n,i);else if(e<11754943508222875e-54)t((r<<31|Math.round(e/1401298464324817e-60))>>>0,n,i);else{var s=Math.floor(Math.log(e)/Math.LN2);t((r<<31|s+127<<23|8388607&Math.round(e*Math.pow(2,-s)*8388608))>>>0,n,i)}}function n(t,e,n){var i=t(e,n),r=2*(i>>31)+1,s=i>>>23&255,a=8388607&i;return 255===s?a?NaN:r*(1/0):0===s?1401298464324817e-60*r*a:r*Math.pow(2,s-150)*(a+8388608)}t.writeFloatLE=e.bind(null,r),t.writeFloatBE=e.bind(null,s),t.readFloatLE=n.bind(null,a),t.readFloatBE=n.bind(null,o)}(),"undefined"!=typeof Float64Array?function(){var e=new Float64Array([-0]),n=new Uint8Array(e.buffer),i=128===n[7];function r(t,i,r){e[0]=t,i[r]=n[0],i[r+1]=n[1],i[r+2]=n[2],i[r+3]=n[3],i[r+4]=n[4],i[r+5]=n[5],i[r+6]=n[6],i[r+7]=n[7]}function s(t,i,r){e[0]=t,i[r]=n[7],i[r+1]=n[6],i[r+2]=n[5],i[r+3]=n[4],i[r+4]=n[3],i[r+5]=n[2],i[r+6]=n[1],i[r+7]=n[0]}function a(t,i){return n[0]=t[i],n[1]=t[i+1],n[2]=t[i+2],n[3]=t[i+3],n[4]=t[i+4],n[5]=t[i+5],n[6]=t[i+6],n[7]=t[i+7],e[0]}function o(t,i){return n[7]=t[i],n[6]=t[i+1],n[5]=t[i+2],n[4]=t[i+3],n[3]=t[i+4],n[2]=t[i+5],n[1]=t[i+6],n[0]=t[i+7],e[0]}t.writeDoubleLE=i?r:s,t.writeDoubleBE=i?s:r,t.readDoubleLE=i?a:o,t.readDoubleBE=i?o:a}():function(){function e(t,e,n,i,r,s){var a=i<0?1:0;if(a&&(i=-i),0===i)t(0,r,s+e),t(1/i>0?0:2147483648,r,s+n);else if(isNaN(i))t(0,r,s+e),t(2146959360,r,s+n);else if(i>17976931348623157e292)t(0,r,s+e),t((a<<31|2146435072)>>>0,r,s+n);else{var o;if(i<22250738585072014e-324)t((o=i/5e-324)>>>0,r,s+e),t((a<<31|o/4294967296)>>>0,r,s+n);else{var l=Math.floor(Math.log(i)/Math.LN2);1024===l&&(l=1023),t(4503599627370496*(o=i*Math.pow(2,-l))>>>0,r,s+e),t((a<<31|l+1023<<20|1048576*o&1048575)>>>0,r,s+n)}}}function n(t,e,n,i,r){var s=t(i,r+e),a=t(i,r+n),o=2*(a>>31)+1,l=a>>>20&2047,u=4294967296*(1048575&a)+s;return 2047===l?u?NaN:o*(1/0):0===l?5e-324*o*u:o*Math.pow(2,l-1075)*(u+4503599627370496)}t.writeDoubleLE=e.bind(null,r,0,4),t.writeDoubleBE=e.bind(null,s,4,0),t.readDoubleLE=n.bind(null,a,0,4),t.readDoubleBE=n.bind(null,o,4,0)}(),t}function r(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}function s(t,e,n){e[n]=t>>>24,e[n+1]=t>>>16&255,e[n+2]=t>>>8&255,e[n+3]=255&t}function a(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0}function o(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}t.exports=i(i)},function(module,exports,__webpack_require__){"use strict";function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(t){}return null}module.exports=inquire},function(t,e,n){"use strict";var i=e;i.length=function(t){for(var e=0,n=0,i=0;i<t.length;++i)(n=t.charCodeAt(i))<128?e+=1:n<2048?e+=2:55296==(64512&n)&&56320==(64512&t.charCodeAt(i+1))?(++i,e+=4):e+=3;return e},i.read=function(t,e,n){if(n-e<1)return"";for(var i,r=null,s=[],a=0;e<n;)(i=t[e++])<128?s[a++]=i:i>191&&i<224?s[a++]=(31&i)<<6|63&t[e++]:i>239&&i<365?(i=((7&i)<<18|(63&t[e++])<<12|(63&t[e++])<<6|63&t[e++])-65536,s[a++]=55296+(i>>10),s[a++]=56320+(1023&i)):s[a++]=(15&i)<<12|(63&t[e++])<<6|63&t[e++],a>8191&&((r||(r=[])).push(String.fromCharCode.apply(String,s)),a=0);return r?(a&&r.push(String.fromCharCode.apply(String,s.slice(0,a))),r.join("")):String.fromCharCode.apply(String,s.slice(0,a))},i.write=function(t,e,n){for(var i,r,s=n,a=0;a<t.length;++a)(i=t.charCodeAt(a))<128?e[n++]=i:i<2048?(e[n++]=i>>6|192,e[n++]=63&i|128):55296==(64512&i)&&56320==(64512&(r=t.charCodeAt(a+1)))?(i=65536+((1023&i)<<10)+(1023&r),++a,e[n++]=i>>18|240,e[n++]=i>>12&63|128,e[n++]=i>>6&63|128,e[n++]=63&i|128):(e[n++]=i>>12|224,e[n++]=i>>6&63|128,e[n++]=63&i|128);return n-s}},function(t,e,n){"use strict";t.exports=function(t,e,n){var i=n||8192,r=i>>>1,s=null,a=i;return function(n){if(n<1||n>r)return t(n);a+n>i&&(s=t(i),a=0);var o=e.call(s,a,a+=n);return 7&a&&(a=1+(7|a)),o}}},function(t,e,n){"use strict";t.exports=r;var i=n(9);function r(t,e){this.lo=t>>>0,this.hi=e>>>0}var s=r.zero=new r(0,0);s.toNumber=function(){return 0},s.zzEncode=s.zzDecode=function(){return this},s.length=function(){return 1};var a=r.zeroHash="\0\0\0\0\0\0\0\0";r.fromNumber=function(t){if(0===t)return s;var e=t<0;e&&(t=-t);var n=t>>>0,i=(t-n)/4294967296>>>0;return e&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new r(n,i)},r.from=function(t){if("number"==typeof t)return r.fromNumber(t);if(i.isString(t)){if(!i.Long)return r.fromNumber(parseInt(t,10));t=i.Long.fromString(t)}return t.low||t.high?new r(t.low>>>0,t.high>>>0):s},r.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+4294967296*n)}return this.lo+4294967296*this.hi},r.prototype.toLong=function(t){return i.Long?new i.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var o=String.prototype.charCodeAt;r.fromHash=function(t){return t===a?s:new r((o.call(t,0)|o.call(t,1)<<8|o.call(t,2)<<16|o.call(t,3)<<24)>>>0,(o.call(t,4)|o.call(t,5)<<8|o.call(t,6)<<16|o.call(t,7)<<24)>>>0)},r.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},r.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},r.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},r.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10}},function(t,e,n){"use strict";t.exports=s;var i=n(32);(s.prototype=Object.create(i.prototype)).constructor=s;var r=n(9);function s(){i.call(this)}function a(t,e,n){t.length<40?r.utf8.write(t,e,n):e.utf8Write?e.utf8Write(t,n):e.write(t,n)}s._configure=function(){s.alloc=r._Buffer_allocUnsafe,s.writeBytesBuffer=r.Buffer&&r.Buffer.prototype instanceof Uint8Array&&"set"===r.Buffer.prototype.set.name?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var i=0;i<t.length;)e[n++]=t[i++]}},s.prototype.bytes=function(t){r.isString(t)&&(t=r._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(s.writeBytesBuffer,e,t),this},s.prototype.string=function(t){var e=r.Buffer.byteLength(t);return this.uint32(e),e&&this._push(a,e,t),this},s._configure()},function(t,e,n){"use strict";t.exports=s;var i=n(33);(s.prototype=Object.create(i.prototype)).constructor=s;var r=n(9);function s(t){i.call(this,t)}s._configure=function(){r.Buffer&&(s.prototype._slice=r.Buffer.prototype.slice)},s.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},s._configure()},function(t,e,n){"use strict";e.Service=n(56)},function(t,e,n){"use strict";t.exports=r;var i=n(9);function r(t,e,n){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");i.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(n)}(r.prototype=Object.create(i.EventEmitter.prototype)).constructor=r,r.prototype.rpcCall=function t(e,n,r,s,a){if(!s)throw TypeError("request must be specified");var o=this;if(!a)return i.asPromise(t,o,e,n,r,s);if(o.rpcImpl)try{return o.rpcImpl(e,n[o.requestDelimited?"encodeDelimited":"encode"](s).finish(),(function(t,n){if(t)return o.emit("error",t,e),a(t);if(null!==n){if(!(n instanceof r))try{n=r[o.responseDelimited?"decodeDelimited":"decode"](n)}catch(t){return o.emit("error",t,e),a(t)}return o.emit("data",n,e),a(null,n)}o.end(!0)}))}catch(t){return o.emit("error",t,e),void setTimeout((function(){a(t)}),0)}else setTimeout((function(){a(Error("already ended"))}),0)},r.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},function(t,e,n){"use strict";t.exports={}},function(t,e){t.exports=i;var n=null;try{n=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(t){}function i(t,e,n){this.low=0|t,this.high=0|e,this.unsigned=!!n}function r(t){return!0===(t&&t.__isLong__)}i.prototype.__isLong__,Object.defineProperty(i.prototype,"__isLong__",{value:!0}),i.isLong=r;var s={},a={};function o(t,e){var n,i,r;return e?(r=0<=(t>>>=0)&&t<256)&&(i=a[t])?i:(n=u(t,(0|t)<0?-1:0,!0),r&&(a[t]=n),n):(r=-128<=(t|=0)&&t<128)&&(i=s[t])?i:(n=u(t,t<0?-1:0,!1),r&&(s[t]=n),n)}function l(t,e){if(isNaN(t))return e?S:y;if(e){if(t<0)return S;if(t>=f)return w}else{if(t<=-m)return P;if(t+1>=m)return _}return t<0?l(-t,e).neg():u(t%p|0,t/p|0,e)}function u(t,e,n){return new i(t,e,n)}i.fromInt=o,i.fromNumber=l,i.fromBits=u;var h=Math.pow;function c(t,e,n){if(0===t.length)throw Error("empty string");if("NaN"===t||"Infinity"===t||"+Infinity"===t||"-Infinity"===t)return y;if("number"==typeof e?(n=e,e=!1):e=!!e,(n=n||10)<2||36<n)throw RangeError("radix");var i;if((i=t.indexOf("-"))>0)throw Error("interior hyphen");if(0===i)return c(t.substring(1),e,n).neg();for(var r=l(h(n,8)),s=y,a=0;a<t.length;a+=8){var o=Math.min(8,t.length-a),u=parseInt(t.substring(a,a+o),n);if(o<8){var d=l(h(n,o));s=s.mul(d).add(l(u))}else s=(s=s.mul(r)).add(l(u))}return s.unsigned=e,s}function d(t,e){return"number"==typeof t?l(t,e):"string"==typeof t?c(t,e):u(t.low,t.high,"boolean"==typeof e?e:t.unsigned)}i.fromString=c,i.fromValue=d;var p=4294967296,f=p*p,m=f/2,g=o(1<<24),y=o(0);i.ZERO=y;var S=o(0,!0);i.UZERO=S;var C=o(1);i.ONE=C;var v=o(1,!0);i.UONE=v;var b=o(-1);i.NEG_ONE=b;var _=u(-1,2147483647,!1);i.MAX_VALUE=_;var w=u(-1,-1,!0);i.MAX_UNSIGNED_VALUE=w;var P=u(0,-2147483648,!1);i.MIN_VALUE=P;var O=i.prototype;O.toInt=function(){return this.unsigned?this.low>>>0:this.low},O.toNumber=function(){return this.unsigned?(this.high>>>0)*p+(this.low>>>0):this.high*p+(this.low>>>0)},O.toString=function(t){if((t=t||10)<2||36<t)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(P)){var e=l(t),n=this.div(e),i=n.mul(e).sub(this);return n.toString(t)+i.toInt().toString(t)}return"-"+this.neg().toString(t)}for(var r=l(h(t,6),this.unsigned),s=this,a="";;){var o=s.div(r),u=(s.sub(o.mul(r)).toInt()>>>0).toString(t);if((s=o).isZero())return u+a;for(;u.length<6;)u="0"+u;a=""+u+a}},O.getHighBits=function(){return this.high},O.getHighBitsUnsigned=function(){return this.high>>>0},O.getLowBits=function(){return this.low},O.getLowBitsUnsigned=function(){return this.low>>>0},O.getNumBitsAbs=function(){if(this.isNegative())return this.eq(P)?64:this.neg().getNumBitsAbs();for(var t=0!=this.high?this.high:this.low,e=31;e>0&&0==(t&1<<e);e--);return 0!=this.high?e+33:e+1},O.isZero=function(){return 0===this.high&&0===this.low},O.eqz=O.isZero,O.isNegative=function(){return!this.unsigned&&this.high<0},O.isPositive=function(){return this.unsigned||this.high>=0},O.isOdd=function(){return 1==(1&this.low)},O.isEven=function(){return 0==(1&this.low)},O.equals=function(t){return r(t)||(t=d(t)),(this.unsigned===t.unsigned||this.high>>>31!=1||t.high>>>31!=1)&&(this.high===t.high&&this.low===t.low)},O.eq=O.equals,O.notEquals=function(t){return!this.eq(t)},O.neq=O.notEquals,O.ne=O.notEquals,O.lessThan=function(t){return this.comp(t)<0},O.lt=O.lessThan,O.lessThanOrEqual=function(t){return this.comp(t)<=0},O.lte=O.lessThanOrEqual,O.le=O.lessThanOrEqual,O.greaterThan=function(t){return this.comp(t)>0},O.gt=O.greaterThan,O.greaterThanOrEqual=function(t){return this.comp(t)>=0},O.gte=O.greaterThanOrEqual,O.ge=O.greaterThanOrEqual,O.compare=function(t){if(r(t)||(t=d(t)),this.eq(t))return 0;var e=this.isNegative(),n=t.isNegative();return e&&!n?-1:!e&&n?1:this.unsigned?t.high>>>0>this.high>>>0||t.high===this.high&&t.low>>>0>this.low>>>0?-1:1:this.sub(t).isNegative()?-1:1},O.comp=O.compare,O.negate=function(){return!this.unsigned&&this.eq(P)?P:this.not().add(C)},O.neg=O.negate,O.add=function(t){r(t)||(t=d(t));var e=this.high>>>16,n=65535&this.high,i=this.low>>>16,s=65535&this.low,a=t.high>>>16,o=65535&t.high,l=t.low>>>16,h=0,c=0,p=0,f=0;return p+=(f+=s+(65535&t.low))>>>16,c+=(p+=i+l)>>>16,h+=(c+=n+o)>>>16,h+=e+a,u((p&=65535)<<16|(f&=65535),(h&=65535)<<16|(c&=65535),this.unsigned)},O.subtract=function(t){return r(t)||(t=d(t)),this.add(t.neg())},O.sub=O.subtract,O.multiply=function(t){if(this.isZero())return y;if(r(t)||(t=d(t)),n)return u(n.mul(this.low,this.high,t.low,t.high),n.get_high(),this.unsigned);if(t.isZero())return y;if(this.eq(P))return t.isOdd()?P:y;if(t.eq(P))return this.isOdd()?P:y;if(this.isNegative())return t.isNegative()?this.neg().mul(t.neg()):this.neg().mul(t).neg();if(t.isNegative())return this.mul(t.neg()).neg();if(this.lt(g)&&t.lt(g))return l(this.toNumber()*t.toNumber(),this.unsigned);var e=this.high>>>16,i=65535&this.high,s=this.low>>>16,a=65535&this.low,o=t.high>>>16,h=65535&t.high,c=t.low>>>16,p=65535&t.low,f=0,m=0,S=0,C=0;return S+=(C+=a*p)>>>16,m+=(S+=s*p)>>>16,S&=65535,m+=(S+=a*c)>>>16,f+=(m+=i*p)>>>16,m&=65535,f+=(m+=s*c)>>>16,m&=65535,f+=(m+=a*h)>>>16,f+=e*p+i*c+s*h+a*o,u((S&=65535)<<16|(C&=65535),(f&=65535)<<16|(m&=65535),this.unsigned)},O.mul=O.multiply,O.divide=function(t){if(r(t)||(t=d(t)),t.isZero())throw Error("division by zero");var e,i,s;if(n)return this.unsigned||-2147483648!==this.high||-1!==t.low||-1!==t.high?u((this.unsigned?n.div_u:n.div_s)(this.low,this.high,t.low,t.high),n.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?S:y;if(this.unsigned){if(t.unsigned||(t=t.toUnsigned()),t.gt(this))return S;if(t.gt(this.shru(1)))return v;s=S}else{if(this.eq(P))return t.eq(C)||t.eq(b)?P:t.eq(P)?C:(e=this.shr(1).div(t).shl(1)).eq(y)?t.isNegative()?C:b:(i=this.sub(t.mul(e)),s=e.add(i.div(t)));if(t.eq(P))return this.unsigned?S:y;if(this.isNegative())return t.isNegative()?this.neg().div(t.neg()):this.neg().div(t).neg();if(t.isNegative())return this.div(t.neg()).neg();s=y}for(i=this;i.gte(t);){e=Math.max(1,Math.floor(i.toNumber()/t.toNumber()));for(var a=Math.ceil(Math.log(e)/Math.LN2),o=a<=48?1:h(2,a-48),c=l(e),p=c.mul(t);p.isNegative()||p.gt(i);)p=(c=l(e-=o,this.unsigned)).mul(t);c.isZero()&&(c=C),s=s.add(c),i=i.sub(p)}return s},O.div=O.divide,O.modulo=function(t){return r(t)||(t=d(t)),n?u((this.unsigned?n.rem_u:n.rem_s)(this.low,this.high,t.low,t.high),n.get_high(),this.unsigned):this.sub(this.div(t).mul(t))},O.mod=O.modulo,O.rem=O.modulo,O.not=function(){return u(~this.low,~this.high,this.unsigned)},O.and=function(t){return r(t)||(t=d(t)),u(this.low&t.low,this.high&t.high,this.unsigned)},O.or=function(t){return r(t)||(t=d(t)),u(this.low|t.low,this.high|t.high,this.unsigned)},O.xor=function(t){return r(t)||(t=d(t)),u(this.low^t.low,this.high^t.high,this.unsigned)},O.shiftLeft=function(t){return r(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?u(this.low<<t,this.high<<t|this.low>>>32-t,this.unsigned):u(0,this.low<<t-32,this.unsigned)},O.shl=O.shiftLeft,O.shiftRight=function(t){return r(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?u(this.low>>>t|this.high<<32-t,this.high>>t,this.unsigned):u(this.high>>t-32,this.high>=0?0:-1,this.unsigned)},O.shr=O.shiftRight,O.shiftRightUnsigned=function(t){if(r(t)&&(t=t.toInt()),0===(t&=63))return this;var e=this.high;return t<32?u(this.low>>>t|e<<32-t,e>>>t,this.unsigned):u(32===t?e:e>>>t-32,0,this.unsigned)},O.shru=O.shiftRightUnsigned,O.shr_u=O.shiftRightUnsigned,O.toSigned=function(){return this.unsigned?u(this.low,this.high,!1):this},O.toUnsigned=function(){return this.unsigned?this:u(this.low,this.high,!0)},O.toBytes=function(t){return t?this.toBytesLE():this.toBytesBE()},O.toBytesLE=function(){var t=this.high,e=this.low;return[255&e,e>>>8&255,e>>>16&255,e>>>24,255&t,t>>>8&255,t>>>16&255,t>>>24]},O.toBytesBE=function(){var t=this.high,e=this.low;return[t>>>24,t>>>16&255,t>>>8&255,255&t,e>>>24,e>>>16&255,e>>>8&255,255&e]},i.fromBytes=function(t,e,n){return n?i.fromBytesLE(t,e):i.fromBytesBE(t,e)},i.fromBytesLE=function(t,e){return new i(t[0]|t[1]<<8|t[2]<<16|t[3]<<24,t[4]|t[5]<<8|t[6]<<16|t[7]<<24,e)},i.fromBytesBE=function(t,e){return new i(t[4]<<24|t[5]<<16|t[6]<<8|t[7],t[0]<<24|t[1]<<16|t[2]<<8|t[3],e)}},function(t,e,n){"use strict";n.r(e);var i=n(0);class r{static Instance(t){return null==this.instance&&(this.instance=new t),this.instance}}r.instance=null;var s=n(5);class a extends r{constructor(){super(),this._pkgMap=new Map}async loadScene(t,e=i.UnityEngine.SceneManagement.LoadSceneMode.Single){try{let n=i.NiceTS.ResourceManager.LoadScene(t,e,t=>{F.log("load scene: "+t)});return await Object(s.$promise)(n)}catch(e){return F.error(`Load Scene :${t} : ${e}`),null}}async unloadScene(t){try{let e=i.NiceTS.ResourceManager.UnloadScene(t);return await Object(s.$promise)(e)}catch(t){return F.error("Unload scene  : "+t),null}}unloadSceneByName(t){i.NiceTS.ResourceManager.UnloadSceneByName(t)}async loadPrefab(t){try{let e=i.NiceTS.ResourceManager.LoadPrefab(t);return await Object(s.$promise)(e)}catch(e){return F.error(`Load prefab :${t} : ${e}`),null}}async loadTextAsset(t){try{let e=i.NiceTS.ResourceManager.LoadTextAsset(t);return await Object(s.$promise)(e)}catch(e){return F.error(`Load textasset :${t} : ${e}`),null}}async loadTextBytes(t){try{let e=i.NiceTS.ResourceManager.LoadTextBytes(t);return await Object(s.$promise)(e)}catch(e){F.error(`LoadTextBytes :${t} : ${e}`)}}async loadSprite(t){try{let e=i.NiceTS.ResourceManager.LoadSprite(t);return await Object(s.$promise)(e)}catch(e){return F.error(`Load sprite :${t} : ${e}`),null}}releaseAddressGO(t){i.NiceTS.ResourceManager.ReleaseAddressGO(t)}}class o extends r{constructor(){super(),this.__cacheTransRoot=null,this.__goPool=new Map,this.__instCache=new Map;let t=i.UnityEngine.GameObject.Find("GameObjectCacheRoot");null==t&&(t=new i.UnityEngine.GameObject("GameObjectCacheRoot"),i.UnityEngine.Object.DontDestroyOnLoad(t)),this.__cacheTransRoot=t.transform}checkHasCached(t){let e=this.__instCache.get(t);return null!=e&&e.length>0||null!=this.__goPool.get(t)}cacheAndInstGameObject(t,e,n=1){if(this.__goPool.set(t,e),n>0){let r=this.__instCache.get(t);for(let t=0;t<n;t++){let t=i.UnityEngine.GameObject.Instantiate(e);t.transform.SetParent(this.__cacheTransRoot),t.SetActive(!1),r.push(t)}}}tryGetFromCache(t){if(!this.checkHasCached(t))return null;let e=this.__instCache.get(t);if(null!=e&&e.length>0){return e.pop()}let n=this.__goPool.get(t);if(null!=n){return i.UnityEngine.GameObject.Instantiate(n)}return null}async preLoadGameObjectAsync(t,e,n,...i){if(this.checkHasCached(t))return void(null!=n&&n(i));let r=await a.Instance(a).loadPrefab(t);null!=r&&this.cacheAndInstGameObject(t,r,e),null!=n&&n(i)}async getGameObjectAsync(t,e,...n){let i=this.tryGetFromCache(t);null==i&&await this.preLoadGameObjectAsync(t,1,e,n),i=this.tryGetFromCache(t),i.SetActive(!0)}recycleGameObject(t,e){e.transform.SetParent(this.__cacheTransRoot),e.SetActive(!1);let n=this.__instCache.get(t)||new Array;n.push(e),this.__instCache.set(t,n)}cleanup(t=!1){this.__instCache.forEach((t,e)=>{for(let e of t)null!=e&&i.UnityEngine.GameObject.Destroy(e)}),this.__instCache.clear(),t&&(this.__goPool.forEach((t,e)=>{null!=t&&a.Instance(a).releaseAddressGO(t)}),this.__goPool.clear())}}var l=n(19);class u{BindInkMethods(t){this.bindInkMethodOnce(t,"GetCharacterName",this.getCharacterName),this.bindInkMethodOnceGeneral(t,"GetCharacterNameByMutiParams",this.getCharacterNameMutiParams)}getCharacterName(){return"Justin Test Puerts"}getCharacterNameMutiParams(t,e,n){return"Justin Muti Params"}bindInkMethodOnce(t,e,n){try{t.BindExternalFunction(e,n)}catch(t){F.warn(t)}}bindInkMethodOnceGeneral(t,e,n){try{t.BindExternalFunctionGeneral(e,n)}catch(t){F.warn(t)}}unbindInkMethod(t,e){try{t.UnbindExternalFunction(e)}catch(t){F.warn(t)}}}class h{}class c{constructor(){this.listenerMap=new Map}addListener(t,e,n){let i=this.listenerMap.get(t);void 0===i&&(i=new h,i.obj=e,i.listeners=new Array),i.listeners.push(n),this.listenerMap.set(t,i)}getListener(t){return this.listenerMap.get(t)}broadcast(t,...e){let n=this.listenerMap.get(t);if(void 0!==n)for(let t of n.listeners)t.apply(n.obj,e)}removeListenerByType(t){this.listenerMap.delete(t)}removeListener(t,e){let n=this.listenerMap.get(t);if(void 0!==n)for(let t=0;t<n.listeners.length;t++)n.listeners[t]==e&&n.listeners.splice(t,1)}clearup(){this.listenerMap.clear()}}class d extends r{constructor(){super(...arguments),this.storyMessage=new c}addListener(t,e,n){this.storyMessage.addListener(t,e,n)}removeListener(t,e){this.storyMessage.removeListener(t,e)}removeListenerByCode(t){this.storyMessage.removeListenerByType(t)}clearup(){this.storyMessage.clearup()}broadcastContentReady(t,e,n,i,r){this.storyMessage.broadcast(t,e,n,i,r)}broadcastChoicesPresented(t,e){this.storyMessage.broadcast(t,e)}broadcastStoryFinished(t){this.storyMessage.broadcast(t)}}d.ONCONTENTREADY=1001,d.ONCHOICESPRESENTED=1002,d.ONSTORYFINISHED=1003;class p{constructor(t){this._allInkCommands=new Map,this.setupInkCommands(),this.createStroy(t),this.load()}load(){}createStroy(t){this._currentStory=new l.Story(t)}beginStory(t){if(null==this._currentStory)return void F.warn("Trying to AdvanceStory in InkWriter when no story has been created");this._currentStory.ChoosePathString(t,!0),(new u).BindInkMethods(this._currentStory),this.advanceStory()}giveReward(){return F.log("give reward..."),!0}setupInkCommands(){this._allInkCommands.set("GIVE_REWARD",this.giveReward)}handleCommand(t,e){return this._allInkCommands.has(t)?this._allInkCommands.get(t)(e):(F.error("Could not find InkCommand with name:"+t),!0)}parseCommandName(t){let e=t.indexOf(p.COMMAND_PREFIX),n=t.indexOf(p.COMMAND_DELIMITER);-1==n&&(n=t.length);let i=n-(e+p.COMMAND_PREFIX.length);return t.substr(e+p.COMMAND_PREFIX.length,i).trim()}parseCommandArgs(t){let e=t.indexOf(p.COMMAND_DELIMITER);if(-1==e)return[];let n=t.length-(e+1),i=t.substr(e+1,n).trim().split(p.COMMAND_ARG_DELIMITER);for(let t=0;t<i.length;t++)i[t]=i[t].trim();return i}extractSpeaker(t){if(t.startsWith(p.COMMAND_PREFIX))return["0",t.trim()];let e=t.split(":",2);if(e.length>1){return[e[0].trim(),e[1].trim()]}return["0",t.trim()]}saveCurrentStory(){this._currentStory.state.toJson()}canContinue(){return this._currentStory.canContinue}advanceStory(){if(null==this._currentStory)F.warn("Trying to AdvanceStory in InkWriter when no story has been created");else if(this._currentStory.canContinue){let t,e,n=this._currentStory.Continue().trim();if(""==n)return void this.advanceStory();[t,e]=this.extractSpeaker(n);let i=null,r=null;e.startsWith(p.COMMAND_PREFIX)?(i=this.parseCommandName(e),r=this.parseCommandArgs(e),null!=i&&""!=i&&this.handleCommand(i,r)&&this.advanceStory()):d.Instance(d).broadcastContentReady(d.ONCONTENTREADY,e,t,this._currentStory.currentTags,this._currentStory.currentChoices)}else this._currentStory.currentChoices.length>0?d.Instance(d).broadcastChoicesPresented(d.ONCHOICESPRESENTED,this._currentStory.currentChoices):d.Instance(d).broadcastStoryFinished(d.ONSTORYFINISHED)}selectChoice(t){null!=this._currentStory?(this._currentStory.ChooseChoiceIndex(t),this.advanceStory()):F.warn("Trying to ChooseChoice in InkWriter when no story has begun")}getVariable(t){return this._currentStory.variablesState.GetVariableWithName(t)}setVariable(t,e){this._currentStory.variablesState.$(t,e)}}p.DEBUG_STORY_ID="DEBUG_STORY",p.COMMAND_PREFIX=">>>",p.COMMAND_DELIMITER=":",p.COMMAND_ARG_DELIMITER=",";class f extends r{get inkWriter(){return this._inkWriter}constructor(){super(),this.storyAddress="Story/TestStory.json"}async initialize(){if(null==this._inkWriter){var t=(await a.Instance(a).loadTextAsset(this.storyAddress)).text;this._inkWriter=new p(t)}}beginStory(t){this._inkWriter.beginStory(t)}canContinue(){return this._inkWriter.canContinue}advanceStory(){this._inkWriter.advanceStory()}selectChoice(t){this._inkWriter.selectChoice(t.index)}loadCurrent(){null!=this._inkWriter&&this._inkWriter.load()}getVariable(t){return this._inkWriter.getVariable(t)}setVariable(t,e){this.inkWriter.setVariable(t,e)}}var m,g,y=n(1);class S{}class C{static decode(t,e){let n=this.map[t].decode(e),i=new S;return i.rpcId=n.RpcId,i.msgObj=n,i}static encode(t,e){return this.map[t].encode(e).finish()}}C.MSG_C2R_Login=1e3,C.MSG_R2C_Login=1001,C.MSG_C2G_LoginGate=1002,C.MSG_G2C_LoginGate=1003,C.MSG_C2GS_Test=2001,C.MSG_GS2C_Test=2002,C.map={1e3:{decode:y.nice_ts.C2R_Login.decode,encode:y.nice_ts.C2R_Login.encode},1001:{decode:y.nice_ts.R2C_Login.decode,encode:y.nice_ts.R2C_Login.encode},1002:{decode:y.nice_ts.C2G_LoginGate.decode,encode:y.nice_ts.C2G_LoginGate.encode},1003:{decode:y.nice_ts.G2C_LoginGate.decode,encode:y.nice_ts.G2C_LoginGate.encode},2001:{decode:y.nice_ts.C2GS_Test.decode,encode:y.nice_ts.C2GS_Test.encode},2002:{decode:y.nice_ts.GS2C_Test.decode,encode:y.nice_ts.GS2C_Test.encode}};class v{}v.ERR_SocketConnSucc=1e5,v.ERR_ConnectGateKeyError=100006,v.ERR_PeerDisconnect=102008,v.ERR_SocketCantSend=102009,v.ERR_SocketError=102010,v.ERR_SocketConnError=102011;class b{static encodeInt(t){let e=new Uint8Array(4);return e[0]=t>>>24,e[1]=t>>>16,e[2]=t>>>8,e[3]=255&t,e}static decodeInt(t){return t[0]<<24|t[1]<<16|t[2]<<8|t[3]}static encodeShort(t){let e=new Uint8Array(2);return e[0]=t>>>8,e[1]=255&t,e}static decodeShort(t){return t[0]<<8|t[1]}static encodeByte(t){let e=new Uint8Array(1);return e[0]=255&t,e}static decodeByte(t){return t[0]}}class _{constructor(){this.retryTimes=0}}class w extends r{constructor(){super(),this.id=0,this.reSendInterval=1e4,this.timeoutInterval=5e3,this.maxReSendTimes=5,this._rpcId=1,this.requestCallback=new Map,this.listeners=new Map,this._serverId=-1,this._serverType=1}get rpcId(){return++this._rpcId}connectChannel(t,e){return this.channel=i.NiceTS.TService.Instance.GetChannel(),this.channel.errorCallback=(t,n)=>{n==v.ERR_SocketConnSucc&&(this.timeoutIimer=setInterval(()=>{this.checkTimeoutMsg()},this.timeoutInterval)),e(t,n)},this.channel.readCallback=t=>{this.onReceive(t)},this.channel.Connect(t),this}listen(t,e){this.listeners.set(t,e)}send(t,e,n,i){let r=b.encodeInt(e),s=b.encodeShort(t),a=b.encodeShort(this._serverId),o=b.encodeByte(this._serverType),l=new Uint8Array(9+n.length);if(l.set(r),l.set(s,4),l.set(a,6),l.set(o,8),l.set(n,9),null!=i){let t=new _;t.sendTime=(new Date).getTime(),t.callback=i,t.bytes=l,this.requestCallback.set(e,t)}this.channel.Send(l)}reSend(t){this.channel.Send(t)}onReceive(t){let e=new Uint8Array(t),n=b.decodeInt(e.subarray(0,4)),i=b.decodeShort(e.subarray(4,6)),r=b.decodeShort(e.subarray(6,8)),s=b.decodeByte(e.subarray(8,9));this._serverId=r,this._serverType=s;let a=e.subarray(9);try{let t=C.decode(i,a);if(null!=n&&this.requestCallback.has(n)){this.requestCallback.get(n).callback(t.msgObj),this.requestCallback.delete(n)}else if(this.listeners.has(i)){this.listeners.get(i)(t.msgObj)}}catch(t){F.error("parse msg error, opcode:"+i)}}checkTimeoutMsg(){let t=(new Date).getTime();this.requestCallback.forEach((e,n)=>{e.retryTimes>=this.maxReSendTimes?(F.log(`Message resend too more, opcode:${n}, lastsend:${e.sendTime}`),this.requestCallback.delete(n)):t-e.sendTime>=this.reSendInterval&&(e.retryTimes++,e.sendTime=t,this.reSend(e.bytes),F.log(`resend message:, opcode:${n}, retry times:${e.retryTimes}`))})}disconnect(){clearInterval(this.timeoutIimer),this.channel.Dispose()}}class P extends r{constructor(){super()}async get(t){try{let e=i.NiceTS.HttpManager.Get(t);return await Object(s.$promise)(e)}catch(e){return F.error(`Get error :${t} : ${e}`),null}}async post(t,e){try{let n=i.NiceTS.HttpManager.Post(t,e);return await Object(s.$promise)(n)}catch(e){return F.error(`Post error :${t} : ${e}`),null}}}class O extends r{get realmRpcID(){return this.sessionReam.rpcId}get gateRpcID(){return this.sessionGate.rpcId}async connectRealmServer(){return new Promise(t=>{this.sessionReam=w.Instance(w).connectChannel(V.realmServerIP+":"+V.realmServerPort,(e,n)=>{n==v.ERR_SocketConnSucc?(this.sessionReam.id=e.Id,t(!0)):(t(!1),F.error("login reamserver err, code: "+n+",id:"+e.Id))})})}disconnectRealmServer(){this.sessionReam.disconnect(),this.sessionReam=null}async sendRealmMsg(t,e){let n=this.sessionReam.rpcId;return new Promise(i=>{let r=C.encode(t,e);this.sessionReam.send(t,n,r,t=>{i(t)})})}async connectGateServer(t){return new Promise(e=>{this.sessionGate=w.Instance(w).connectChannel(t,(t,n)=>{F.log("login Gate Server: "+n),n==v.ERR_SocketConnSucc?(this.sessionGate.id=t.Id,e(!0)):(e(!1),F.error("gate server err, code: "+n+",id:"+t.Id))})})}disconnectGateServer(){this.sessionGate.disconnect(),this.sessionGate=null}async sendGateMsg(t,e){let n=this.sessionGate.rpcId;return new Promise(i=>{let r=C.encode(t,e);this.sessionGate.send(t,n,r,t=>{i(t)})})}}class T{}T.PackageName="common",T.PackageBytes="common_fui.bytes",T.UILoadingPage="LoadingPage",T.UIUIGuideWin="UIGuideWin",T.UIUINoticeWin="UINoticeWin";class N{}N.MSG_SELECT_SERVER=1e3,N.MSG_SCENE_PROGRESS=1001;class E{}E.LoadingScene="LoadingScene",E.LaunchScene="LaunchScene",E.HomeScene="HomeScene",E.LoginScene="LoginScene",E.PveScene="PveScene";class I extends r{constructor(){super(),this.currentScene=null}async loadScene(t){try{W.UIManager.openLoading(T.PackageName,T.UILoadingPage),this.currentScene&&(this.currentScene.onLeave(),this.currentScene.onDestroy());let e=await W.ResManager.loadScene(t);this.currentScene=class{static createScene(t){switch(t){case E.LoginScene:case E.HomeScene:case E.PveScene:}return null}}.createScene(t),this.currentScene.setSceneInstance(e),this.currentScene.onEnter();let n=setInterval(()=>{let t=this.currentScene.finishCount/this.currentScene.totalCount;F.log("progress:"+t+" = "+this.currentScene.finishCount+" = "+this.currentScene.totalCount),W.UIMessageManger.broadcast(N.MSG_SCENE_PROGRESS,100*t)},100);await this.currentScene.loadAssetsAsync(),clearInterval(n),W.UIManager.closeAllPanels(),await this.currentScene.onComplete(),W.UIManager.closeLoading()}catch(t){F.log("load scene excep:"+t)}}}class x{}class A extends r{constructor(){super(),this.m_pageTrackStack=new Array,this.m_listLoadedPanel=new Array}distroyPanel(t){t.isOpen&&t.close(),t.dispose()}distroyAllLoadedPanel(){for(let t=this.m_listLoadedPanel.length-1;t>=0;t--){let e=this.m_listLoadedPanel[t];this.distroyPanel(e),this.m_listLoadedPanel.splice(t,1)}}clean(){this.distroyAllLoadedPanel(),this.m_pageTrackStack.length=0,this.m_listLoadedPanel.length=0}getPanelUI(t){for(const e of this.m_listLoadedPanel)if(e.name==t)return F.log("find panel in cache: "+t),e;return null}async open(t,e,n){let i=this.getPanelUI(e);return null!=i&&i._internalOpen(n),i}async openPageWorker(t,e,n){return this.m_currentPage=new x,this.m_currentPage.pkg=t,this.m_currentPage.name=e,this.m_currentPage.arg=n,this.distroyAllLoadedPanel(),this.m_currentPage}async openPageInScene(t,e,n){let i=await this.openPageWorker(t,e,n);this.m_lastScensePage&&this.distroyPanel(this.m_lastScensePage.ui),this.m_lastScensePage=i}async openPage(t,e,n){let i=this.m_pageTrackStack.length;for(let n=i-1;n>=0;n--){let r=this.m_pageTrackStack[n];if(r.pkg==t&&r.name==e){this.distroyAllLoadedPanel(),this.distroyPanel(this.m_currentPage.ui),r.ui.visible=!0,r.ui.onShow(r.arg);for(let t=i-1;t>n;t--){let e=this.m_pageTrackStack[t];this.distroyPanel(e.ui),this.m_pageTrackStack.slice(t,1)}return this.m_currentPage=this.m_pageTrackStack.pop(),this.m_currentPage}}null!=this.m_currentPage&&this.m_currentPage.name!=e&&this.m_pageTrackStack.push(this.m_currentPage);for(let t of this.m_pageTrackStack)t.ui.visible=!1;await this.openPageWorker(t,e,n)}async goBackPage(){if(this.m_pageTrackStack.length>0){this.distroyAllLoadedPanel(),this.distroyPanel(this.m_currentPage.ui);let t=this.m_pageTrackStack.pop();t.ui.visible=!0,this.m_currentPage=t,t.ui.onShow(t.arg)}else await this.enterMainPage()}enterMainPage(){for(let t of this.m_pageTrackStack)this.distroyPanel(t.ui);this.m_pageTrackStack.length=0}async openLoading(t,e,n){this.m_loadingPage,this.m_loadingPage._internalOpen(n)}closeLoading(t){this.m_loadingPage&&this.m_loadingPage.close(t)}async openWindow(t,e,n){return await this.open(t,e,n)}closeWindow(t,e){}async openWidget(t,e,n){return await this.open(t,e,n)}closeWidget(t,e){}closeAllPanels(){this.distroyAllLoadedPanel();for(let t=this.m_pageTrackStack.length-1;t>=0;t--){let e=this.m_pageTrackStack[t];this.distroyPanel(e.ui),this.m_pageTrackStack.slice(t,1)}}}class k extends r{constructor(){super(...arguments),this.uiMessage=new c}addListener(t,e,n){this.uiMessage.addListener(t,e,n)}removeListener(t,e){this.uiMessage.removeListener(t,e)}removeListenerByCode(t){this.uiMessage.removeListenerByType(t)}clearup(){this.uiMessage.clearup()}broadcast(t,e){this.uiMessage.broadcast(t,e)}}class V{}V.debug=!0,V.realmServerIP="127.0.0.1",V.realmServerPort=9001;class W{}W.UIManager=A.Instance(A),W.UIMessageManger=k.Instance(k),W.SceneManager=I.Instance(I),W.GameObjectPool=o.Instance(o),W.ResManager=a.Instance(a),W.StoryManager=f.Instance(f),W.SessionManager=O.Instance(O),W.GameSession=w.Instance(w),W.StoryMessageManager=d.Instance(d),W.HttpManager=P.Instance(P),function(t){t[t.Error=0]="Error",t[t.Assert=1]="Assert",t[t.Warning=2]="Warning",t[t.Log=3]="Log",t[t.Exception=4]="Exception"}(m||(m={}));class F{static getPrintStack(t,e,...n){let r="";for(let t=0;t<n.length;t++){const e=n[t];"object"==typeof e&&F.LOG_OBJECT_TO_JSON?r+=JSON.stringify(e):r+=e,t<n.length-1&&(r+=" ")}if(e||i.UnityEngine.Application.isEditor){var s=(new Error).stack.split("\n");for(let t=3;t<s.length;t++){r+="\n",r+=s[t]}}return F.unity_log_target||(F.unity_log_target=new i.UnityEngine.Object),r}static log(...t){if(!V.debug)return;let e=F.getPrintStack(m.Log,!0,t);console.log(e)}static warn(...t){if(!V.debug)return;let e=F.getPrintStack(m.Warning,!0,t);console.warn(e)}static error(...t){if(!V.debug)return;let e=F.getPrintStack(m.Error,!0,t);console.error(e)}static trace(...t){if(!V.debug)return;let e=F.getPrintStack(m.Log,!0,t);console.log(e)}static LOG_OBJECT_TO_JSON(...t){return!1}}F.unity_log_target=null;class L{static prefixInteger(t,e){return(Array(e).join("0")+t).slice(-e)}static getTimeString1(t){if(t<=0)return"00:00:00";{let e=Math.floor(t/3600),n=this.prefixInteger(e,2),i=Math.floor(t/60)%60,r=t%60;return`${n}:${this.prefixInteger(i,2)}:${this.prefixInteger(r,2)}`}}static getTimeString(t){if(t<=0)return"00:00:00";{let e=Math.floor(t/3600),n=this.prefixInteger(e,2),i=Math.floor(t/60)%60;return`${n}:${this.prefixInteger(i,2)}`}}static getTimeMinuteString(t){if(t<=0)return"00:00:00";{let e=Math.floor(t/60)%60;return""+this.prefixInteger(e,2)}}static getTimeSecondString(t){if(t<=0)return"00:00:00";{let e=t%60;return""+this.prefixInteger(e,2)}}static getWeekOfMonthFirstDay(t){let e=new Date(t);return e.setDate(1),e.getDay()}static isLeapYear(t){return t%4==0&&t%100!=0||t%400==0}static getMonthDays_(t,e){return 2==e?this.isLeapYear(t)?29:28:this.months[e]}static getMonthDays(t){let e=new Date(t);return this.getMonthDays_(e.getFullYear(),e.getMonth())}static async sleep(t){return new Promise(e=>{setTimeout(()=>{e("")},t)})}static test(){let t=this.getTimeString1(5e3);F.log(t);let e=this.getTimeString(5e3);F.log(e);let n=this.getTimeMinuteString(5e3);F.log(n);let i=this.getTimeSecondString(5e3);F.log(i);let r=(new Date).getTime(),s=this.getWeekOfMonthFirstDay(r);F.log("getWeekOfMonthFirstDay: "+s+" ,time:"+r);let a=this.getMonthDays(r);F.log("getMonthDays: "+a)}}L.months=[31,28,31,30,31,30,31,31,30,31,30,31];class R extends r{constructor(){super(),this.num=0,F.log("SingletonTest call constructor")}add(){this.num+=1}test(){return this.num}}class j{constructor(t,e,n,i,r,s,a,o,l,u,h,c,d,p,f,m,g,y,S){this._id=t,this._Name=e,this._Description=n,this._CoolTime=i,this._CostSP=r,this._AttackDistance=s,this._AttackAngle=a,this._AttackTargetTags=o,this._ImpactType=l,this._NextBattlerId=u,this._AtkRatio=h,this._DurationTime=c,this._AtkInterval=d,this._SkillPrefab=p,this._AnimationName=f,this._HitFxPrefab=m,this._Level=g,this._AttackType=y,this._SelectorType=S}}class M extends r{constructor(){super(),this.trs=new Map,this.trs.set(1001,new j(1001,"降龙十八掌","带有强力攻击技能",10,178,1,30,["Enemy"],["CostSP","Damage"],0,2,2,1,"Effect/Prefab/UI/ef_ui_TaskFinish.prefab","skill1","Effect/Prefab/UI/ef_ui_TaskFinish.prefab",1,1,1)),this.trs.set(1002,new j(1002,"暴雨梨花","带有强力攻击技能",10,178,1,30,["Enemy"],["CostSP","Damage"],0,2,2,1,"Effect/Prefab/UI/ef_ui_TaskFinish.prefab","skill2","Effect/Prefab/UI/ef_ui_TaskFinish.prefab",1,1,1)),this.trs.set(1003,new j(1003,"排山倒海","带有强力攻击技能",10,178,1,30,["Enemy"],["CostSP","Damage"],0,2,2,1,"Effect/Prefab/UI/ef_ui_TaskFinish.prefab","skill3","Effect/Prefab/UI/ef_ui_TaskFinish.prefab",1,1,1)),this.trs.set(1004,new j(1004,"葵花点穴手","带有强力攻击技能",10,178,1,30,["Enemy"],["CostSP","Damage"],0,2,2,1,"Effect/Prefab/UI/ef_ui_TaskFinish.prefab","skill4","Effect/Prefab/UI/ef_ui_TaskFinish.prefab",1,1,1))}}class G extends r{constructor(){super(...arguments),this.redhintsMessage=new c}addListener(t,e,n){this.redhintsMessage.addListener(t,e,n)}removeListener(t,e){this.redhintsMessage.removeListener(t,e)}removeListenerByCode(t){this.redhintsMessage.removeListenerByType(t)}clearup(){this.redhintsMessage.clearup()}broadcast(t,e){this.redhintsMessage.broadcast(t,e)}}!function(t){t[t.none=0]="none",t[t.chat=1]="chat",t[t.chat_world=2]="chat_world",t[t.chat_family=3]="chat_family",t[t.chat_system=4]="chat_system"}(g||(g={}));class D extends r{constructor(){super(),this.init()}init(){this._data=[0],this._parentIndex=[0],this._childNum=[0],this._childIndex=[0],this.setParent(g.chat_world,g.chat),this.setParent(g.chat_family,g.chat),this.setParent(g.chat_system,g.chat)}setRedHintOpenOrClose(t,e){this._childNum[t]>0?F.log("红点数据设置错误：不能直接对高级的红点数据操作"):this.doSetRedHintOpenOrClose(t,e?1:0)}setParent(t,e){this._parentIndex[e]!=t?this._parentIndex[t]?F.log("重复设置"):(this._parentIndex[t]=e,isNaN(this._childNum[e])&&(this._childNum[e]=0),this._childNum[e]++,this._childIndex[t]=this._childNum[e]):F.log("关系反了")}doSetRedHintOpenOrClose(t,e){if(this._data[t]!=e){this._data[t]=e;let n=this._parentIndex[t];if(n){let i=this._childIndex[t];this.doSetRedHintOpenOrClose(n,e>0?this._data[n]|this.addV(i):this._data[n]&this.subV(i))}G.Instance(G).broadcast(t,e)}}addV(t){return 1<<t-1}subV(t){return~this.addV(t)}checkRedIsOpen(t){return this._data[t]>0}}D.RED_HINT_VALUE_CHANGED="RED_HINT_VALUE_CHANGED";var B=n(34);class U extends r{constructor(){super(...arguments),this.autoID=0}create(t){let e=new t;return e.uuid=++this.autoID,e.onAwake(null),e}createWithData(t,e){let n=new e;return n.uuid=++this.autoID,n.onAwake(t),n}}class K{constructor(){this._arr=new Array,this._map=new Map}add(t,e){return this._map.set(t,e),this._arr.push(e),e}get(t){return this._map.get(t)}remove(t){var e=this._map.get(t);if(!e)return null;var n=this._arr.indexOf(e);return this._arr.splice(n,1),this._map.delete(t),e}getArr(){return this._arr}dispose(){this._arr.length=0,this._map.clear()}}class J extends class{constructor(){this.uuid=0,this.eventsMap=new Map,this.components=new Map,this.parent=null,this._children=new K,this._typeChildren=new Map}addChild(t,e){t.parent=this,this._children.add(t.uuid,t);let n=this._typeChildren.get(e.name);null==n&&(n=new Array,this._typeChildren.set(e.name,n)),n.push(t)}removeChild(t){this._children.remove(t.uuid).dispose()}getChildren(){return this._children.getArr()}getChildByUUID(t){return this._children.get(t)}getChildrenByType(t){return this._typeChildren.get(t.name)}getChildByType(t){return this.getChildrenByType(t)[0]}addComponent(t){let e=new t;return e.entity=this,this.components[t.name]=e,e}getComponent(t){return this.components[t.name]}getOrAddComponent(t){let e=this.getComponent(t);return null==e&&(e=this.addComponent(t)),e}publish(t,e){let n=this.eventsMap.get(e.name);if(null!=n&&0!=n.length)for(let e=0;e<n.length;e++){let i=n[e];null!=i&&i(t)}else F.log("this event not subscribed...")}subscribe(t,e){let n=this.eventsMap.get(e.name);null==n&&(n=new Array,this.eventsMap.set(e.name,n)),n.push(t)}unSubscribe(t,e){let n=this.eventsMap.get(e.name),i=n.indexOf(t,0);i>-1&&n.splice(i,1)}dispose(){let t=this.getChildren;for(let e=0;e<t.length;e++)t[e].dispose();this.components.clear(),this.eventsMap.clear(),this._typeChildren.clear(),this._children.dispose(),this.parent=null}}{onAwake(t){}constructor(){super(),this.level=1,this.hp=100}}class q extends r{getPlayer(t=!1){return t?(this.player=null,this.player=U.Instance(U).create(J)):null==this.player&&(this.player=U.Instance(U).create(J)),this.player}}class H{publish(t,e){this.entity.publish(t,e)}subscribe(t,e){this.entity.subscribe(t,e)}unSubscribe(t,e){this.entity.unSubscribe(t,e)}}class z extends H{constructor(){super(...arguments),this.name="hello",this.size=100}}class $ extends H{constructor(){super(...arguments),this.nickName="Justin",this.money=1000001}}class X{static async doTest(){F.log("TimeUtil ============================="),L.test(),F.log("Singleton ============================="),R.Instance(R),F.log("===");let t=R.Instance(R),e=R.Instance(R);F.log(t.test()+" : "+e.test()),t.add(),F.log(t.test()+" : "+e.test()),e.add(),F.log(t.test()+" : "+e.test()),F.log("Messager =============================");let n=new c,r=function(t,e){F.log(`listen call: ${t} , ${e}`)};n.addListener(100,this,r),n.addListener(100,this,(function(t,e){F.log(`listen call2: ${t} , ${e}`)})),n.broadcast(100,999," Hello"),n.removeListener(100,r),n.broadcast(100,999," Hello"),n.clearup(),n.broadcast(100,999," Hello"),F.log("Timer =============================");let s=setInterval(()=>{F.log("inter val..")},1e3);setTimeout(()=>{clearInterval(s)},5e3);F.log("ResourceManager ============================="),F.log("引用类型 =============================");let o=new Map;o.set("key1",new Array);let l=o.get("key1");l.push(12),l.push(333);let u=o.get("key1");F.log(u),F.log("UIManager ============================="),F.log("excel data =============================");let h=M.Instance(M).trs.get(1003);F.log(`${h._Name} : ${h._AttackType}`);let d=h._ImpactType;F.log(d),F.log("Protobuf =============================");try{let t={Account:"test",Password:"1234"},e=y.nice_ts.C2R_Login.verify(t);F.log("verify pb: "+e);let n=y.nice_ts.C2R_Login.create(t);n.Account="test1",n.Password="1122",F.log(n);let i=y.nice_ts.C2R_Login.encode(n).finish();F.log(i);let r=y.nice_ts.C2R_Login.decode(i);F.log(r.Account),F.log(r.Password)}catch(t){F.log(t)}F.log("UintArray =============================");let p=new Uint8Array([257,25]);F.log(p.subarray(0,1)),F.log(p.length);let f=new Uint8Array([33]),m=new Uint8Array(p.length+f.length);m.set(f),m.set(p,f.length),F.log(m.length);let S=5678,C=new Uint8Array(4);C[0]=S>>>24,C[1]=S>>>16,C[2]=S>>>8,C[3]=255&S,S=C[0]<<24|C[1]<<16|C[2]<<8|C[3],F.log(S),S=300;let v=new Uint8Array(2);v[0]=S>>>8,v[1]=255&S,F.log(v),S=v[0]<<8|v[1],F.log(S),F.log("sleep ============================="),await L.sleep(1e3),F.log("sleep ..end");try{F.log("测试红点系统 ============================="),G.Instance(G).addListener(g.chat,this,(function(){F.log("red hints chat...")})),G.Instance(G).addListener(g.chat_family,this,(function(){F.log("red hints chat_family...")})),G.Instance(G).addListener(g.chat_system,this,(function(){F.log("red hints chat...")})),D.Instance(D).setRedHintOpenOrClose(g.chat_family,!0);let t=D.Instance(D).checkRedIsOpen(g.chat),e=D.Instance(D).checkRedIsOpen(g.chat_family),n=D.Instance(D).checkRedIsOpen(g.chat_system);F.log(t,e,n)}catch(t){F.log(t)}try{F.log("Ink Story =============================");var b=await(await a.Instance(a).loadTextAsset("Story/TestStory.json")).text;let t=new B.Story(b);t.ChoosePathString("story1",!0),t.BindExternalFunction("GetCharacterName",()=>"Justin Test"),t.BindExternalFunctionGeneral("GetCharacterNameByMutiParams",t=>(F.log(t.length),"TTTT")),F.log(t.Continue()),F.log(t.Continue()),F.log(t.Continue())}catch(t){F.log(t)}F.log("HttpManager=========================");let _=await W.HttpManager.get("https://www.baidu.com/");F.log(_);let w=q.Instance(q).getPlayer(),P=w.addComponent(z),O=(w.addComponent($),new Y);O.name="helloEvent",P.subscribe(t=>{},Y);let T=t=>{};P.subscribe(T,Y),P.unSubscribe(T,Y),P.publish(O,Y),i.TestC.SetPackageItemExtension(new Z),setInterval(()=>{i.TestC.getObj()instanceof Z?console.log("aaaaaaaaaaaaaaaa"):console.log("bbbbbbbbbbbbbbbbbbbb")},1e3)}}X.testVar=1e4;class Z extends i.TestP{test(){console.log("hello test delegate")}}class Y{}(new class{constructor(){i.JsManager.Instance.JsOnApplicationQuit=()=>this.onApplicationQuit(),i.JsManager.Instance.JsOnDispose=()=>this.onDispose()}async start(){try{F.log("Game start in JS...."),W.StoryManager.initialize(),X.doTest(),await W.SceneManager.loadScene(E.LoginScene),i.GameLaunch.Instance.JsLuanchFinish()}catch(t){F.error(t)}}onApplicationQuit(){W.GameObjectPool.cleanup(!0),F.log("Game onApplicationQuit in JS....")}onDispose(){F.log("Game onDispose in JS....")}}).start()}]);